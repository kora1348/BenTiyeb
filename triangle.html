<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Futures USDT-M — Variation % (clôture) — Jour courant d’octobre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
           --ok:#16a34a; --bad:#ef4444; --border:#1f2937; --chip:#111827; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    main{padding:16px;max-width:100%;overflow:auto}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .badge{background:var(--chip);border:1px solid var(--border);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    table{border-collapse:separate;border-spacing:0;width:max-content;min-width:420px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);white-space:nowrap;text-align:center;font-variant-numeric:tabular-nums}
    th{background:#0e182c}
    td:first-child{text-align:left;font-weight:600}
    tr:last-child td{border-bottom:0}
    th:last-child, td:last-child{border-right:0}
    .pos{color:var(--ok);font-weight:600}
    .neg{color:var(--bad);font-weight:600}
    .zero{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Variation % de clôture — Binance Futures USDT-M (PERP) — Jour d’octobre</h1>
      <div class="sub">Jour = date actuelle en Europe/Brussels. Calcul en UTC avec bougies 1d (close→close).</div>
    </div>
    <div class="controls">
      <button id="startBtn">Démarrer</button>
      <span class="badge" id="status">Prêt</span>
    </div>
  </header>

  <main>
    <div id="wrap"></div>
  </main>

  <script>
    const API = {
      base: 'https://fapi.binance.com',
      exchangeInfo: '/fapi/v1/exchangeInfo',
      klines: '/fapi/v1/klines'
    };

    // ---- Récupère Y/M/D EXACTS pour Europe/Brussels (sans parser une string) ----
    const BRUSSELS_TZ = 'Europe/Brussels';
    function getBrusselsYMD(){
      const parts = new Intl.DateTimeFormat('en-US', {
        timeZone: BRUSSELS_TZ, year:'numeric', month:'numeric', day:'numeric'
      }).formatToParts(new Date());
      const y = +parts.find(p=>p.type==='year').value;
      const m = +parts.find(p=>p.type==='month').value; // 1..12
      const d = +parts.find(p=>p.type==='day').value;   // 1..31
      return { y, m, d };
    }

    const { y:TARGET_YEAR, m:BRU_MON_1, d:TODAY_DAY } = getBrusselsYMD();
    const TARGET_MONTH = 9; // octobre (0=janvier)
    const labelDay = String(TODAY_DAY).padStart(2, '0');

    // Si on n'est pas en octobre, on affiche quand même le jour étiquette, mais on force les requêtes sur octobre.
    // (Tu peux changer ce comportement si besoin.)
    const monthForQueries = TARGET_MONTH; // fixé à octobre
    const dayForQueries = (BRU_MON_1 - 1 === TARGET_MONTH) ? TODAY_DAY : 1;

    // Fenêtre UTC nécessaire (J-1 -> J) pour calcul close→close
    const prevDayUTC = Date.UTC(TARGET_YEAR, monthForQueries, dayForQueries - 1, 0, 0, 0);
    const startUTC   = (dayForQueries === 1)
      ? Date.UTC(TARGET_YEAR, monthForQueries, 0, 0, 0, 0) // 30/09 00:00 UTC
      : prevDayUTC;
    const endUTC     = Date.UTC(TARGET_YEAR, monthForQueries, dayForQueries, 23, 59, 59);

    const qs = (s, el=document) => el.querySelector(s);
    const statusEl = qs('#status');
    const wrap = qs('#wrap');
    const startBtn = qs('#startBtn');

    function setStatus(t) { statusEl.textContent = t; }
    function fmtPct(x){
      if (x === null || Number.isNaN(x)) return '<span class="zero">—</span>';
      const s = (x >= 0 ? '+' : '') + x.toFixed(2) + '%';
      const cls = x > 0 ? 'pos' : (x < 0 ? 'neg' : 'zero');
      return `<span class="${cls}">${s}</span>`;
    }

    function buildTable() {
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tr = document.createElement('tr');

      const thSym = document.createElement('th'); thSym.textContent = 'Symbole'; tr.appendChild(thSym);
      const thToday = document.createElement('th'); thToday.textContent = labelDay; tr.appendChild(thToday);

      thead.appendChild(tr);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      table.appendChild(tbody);
      return { table, tbody };
    }

    async function fetchJSON(url){
      const r = await fetch(url);
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    async function getTradablePerpUSDT() {
      const data = await fetchJSON(API.base + API.exchangeInfo);
      return data.symbols
        .filter(s => s.status === 'TRADING' && s.contractType === 'PERPETUAL' && s.quoteAsset === 'USDT')
        .map(s => s.symbol)
        .sort();
    }

    async function getKlinesClose(symbol){
      const url = `${API.base}${API.klines}?symbol=${symbol}&interval=1d&startTime=${startUTC}&endTime=${endUTC}`;
      const raw = await fetchJSON(url);
      // kline: [ openTime, open, high, low, close, volume, closeTime, ... ]
      return raw.map(k => ({ t: k[0], c: parseFloat(k[4]) }));
    }

    function computeTodayChange(closes){
      // Attendu: 2 bougies (veille et jour courant). S'il n'y a pas la bougie du jour (pas encore close), on renvoie null.
      if (!closes || closes.length < 2) return null;
      const prev = closes[0]?.c;
      const today = closes[closes.length - 1]?.c;
      if (prev == null || today == null) return null;
      return (today - prev) / prev * 100;
    }

    async function parallelLimit(items, limit, worker){
      const results = new Array(items.length);
      let i = 0;
      async function next(){
        const idx = i++;
        if (idx >= items.length) return;
        try{ results[idx] = await worker(items[idx], idx); }
        catch(e){ results[idx] = { error: e.message }; }
        return next();
      }
      const runners = Array(Math.min(limit, items.length)).fill(0).map(next);
      await Promise.all(runners);
      return results;
    }

    async function run(){
      startBtn.disabled = true;
      setStatus(`Jour d’octobre ciblé (étiquette): ${labelDay} — Chargement des symboles…`);
      wrap.innerHTML = '';

      try{
        const symbols = await getTradablePerpUSDT();
        setStatus(`Symboles PERP USDT actifs: ${symbols.length}`);

        const { table, tbody } = buildTable();
        wrap.appendChild(table);

        const rowMap = new Map();
        for (const sym of symbols) {
          const tr = document.createElement('tr');
          const tdSym = document.createElement('td'); tdSym.textContent = sym; tr.appendChild(tdSym);
          const tdToday = document.createElement('td'); tdToday.textContent = '…'; tr.appendChild(tdToday);
          tbody.appendChild(tr);
          rowMap.set(sym, tr);
        }

        let done = 0;
        const total = symbols.length;
        await parallelLimit(symbols, 10, async (sym) => {
          const closes = await getKlinesClose(sym);
          const pct = computeTodayChange(closes);
          const tr = rowMap.get(sym);
          tr.children[1].innerHTML = fmtPct(pct);
          done++;
          if (done % 5 === 0) setStatus(`Téléchargé ${done}/${total} — jour ${labelDay}`);
        });

        setStatus('Terminé ✅');
      }catch(err){
        console.error(err);
        setStatus('Erreur: ' + err.message);
        const p = document.createElement('p');
        p.textContent = 'Vérifie ta connexion Internet et réessaie.';
        wrap.appendChild(p);
      }finally{
        startBtn.disabled = false;
      }
    }

    document.getElementById('startBtn').addEventListener('click', run);
  </script>
</body>
</html>
