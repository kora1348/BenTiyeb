<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Delistings Binance Futures (USDT) – Suivi en temps réel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f1a;--card:#11182a;--muted:#6b7280;--text:#e5e7eb;
      --accent:#3b82f6;--pos:#16a34a22;--neg:#dc262622;--neu:#37415166;
      --ring:#3b82f688;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b0f1a,#0a1020 30%,#0b0f1a);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1300px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{font-size:20px;font-weight:700;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;background:#1f2937;color:#cbd5e1;padding:3px 8px;border-radius:999px;border:1px solid #334155}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .input,.btn{border:1px solid #1f2937;background:#0f172a;color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    .input{min-width:220px}
    .btn{cursor:pointer;transition:transform .06s ease, box-shadow .12s ease;border-color:#23304b}
    .btn:hover{box-shadow:0 0 0 3px var(--ring)}
    .btn:active{transform:translateY(1px)}
    .card{background:linear-gradient(180deg,#0e1527, #0c1223);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px #0006;overflow:hidden;margin-bottom:16px}
    .card-head{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2937}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .chip{border:1px solid #27324b;background:#0f172a;border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
    .progress{height:6px;background:#111827;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,#3b82f6,#06b6d4);width:0%}
    .table-wrap{max-height:70vh;overflow:auto}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:600px}
    thead th{position:sticky;top:0;background:#0c1325;border-bottom:1px solid #1f2937;padding:10px 8px;font-weight:600;text-align:left}
    tbody td{border-bottom:1px solid #111827;padding:8px 8px;vertical-align:middle}
    tbody tr:nth-child(2n){background:#0a1221}
    tbody tr:hover{background:#0b1530}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .muted{color:var(--muted)}
    .sticky-foot{position:sticky;bottom:0;background:#0c1325;border-top:1px solid #1f2937;padding:8px 12px;font-size:12px;color:#93a0b2}
    .new-item{animation: pulse 1.5s infinite}
    @keyframes pulse {
      0% { background: transparent }
      50% { background: rgba(59, 130, 246, 0.15) }
      100% { background: transparent }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Delistings Binance Futures <span class="badge">USDT</span></div>
    <div class="toolbar">
      <input id="search" class="input" placeholder="Rechercher (symbole)..." />
      <button id="refresh" class="btn">Rafraîchir</button>
      <label class="btn" style="display:flex;gap:8px;align-items:center;cursor:pointer;">
        <input id="auto" type="checkbox" checked style="accent-color:#3b82f6"> Auto-refresh (10 min)
      </label>
    </div>
  </header>
  <div class="card">
    <div class="card-head">
      <div class="stats">
        <div class="chip">Source: Binance Futures API</div>
        <div class="chip"><span id="count">0</span> paires délistées</div>
        <div class="chip">Dernière mise à jour: <span id="updated">-</span></div>
        <div class="chip">Nouveaux: <span id="new-count">0</span></div>
      </div>
      <div class="progress" style="width:260px"><div id="bar"></div></div>
    </div>
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th style="min-width:150px">Symbole</th>
            <th style="min-width:120px">Délisté le</th>
            <th style="min-width:100px">Statut</th>
          </tr>
        </thead>
        <tbody id="body">
          <tr><td colspan="3" class="muted" style="text-align:center;padding:18px">Chargement des données depuis Binance...</td></tr>
        </tbody>
        <tfoot>
          <tr class="sticky-foot"><td colspan="3">Les données sont récupérées directement depuis l'API Binance. Tri par date récente.</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script>
(() => {
  const API = "https://fapi.binance.com";
  const $body = document.getElementById('body');
  const $count = document.getElementById('count');
  const $newCount = document.getElementById('new-count');
  const $bar = document.getElementById('bar');
  const $search = document.getElementById('search');
  const $refresh = document.getElementById('refresh');
  const $auto = document.getElementById('auto');
  const $updated = document.getElementById('updated');
  let masterRows = [];
  let previousRows = [];
  let timer = null;
  let firstLoad = true;

  function fmtDateFR(ts) {
    try {
      if (!ts || isNaN(ts)) return "Date inconnue";
      return new Intl.DateTimeFormat('fr-FR', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
      }).format(new Date(ts));
    } catch (e) {
      console.error("Erreur de formatage de date:", e);
      return "Date invalide";
    }
  }

  function fmtDateTimeFR(ts) {
    try {
      return new Intl.DateTimeFormat('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).format(new Date(ts));
    } catch (e) {
      console.error("Erreur de formatage datetime:", e);
      return "Date/heure invalide";
    }
  }

  async function jget(url) {
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    } catch (e) {
      console.error("Erreur fetch:", e);
      throw e;
    }
  }

  async function fetchDelistedFutures() {
    try {
      // Récupère toutes les paires futures USDT
      const ex = await jget(API + "/fapi/v1/exchangeInfo");
      
      // Filtre les paires non tradables (delisted)
      const delistedPairs = ex.symbols.filter(s => 
        s.quoteAsset === "USDT" && 
        s.status !== "TRADING" &&
        s.status !== "PRE_TRADING" &&
        s.status !== "PENDING_TRADING"
      );
      
      // Formatte les données avec la meilleure date disponible
      const formatted = delistedPairs.map(pair => ({
        symbol: pair.symbol,
        delistedAt: pair.updateTime || pair.onboardDate || Date.now(),
        status: pair.status,
        isNew: false // Serra mis à jour pendant le rendu
      }));
      
      // Trie par date de délistage (récent -> ancien)
      formatted.sort((a, b) => b.delistedAt - a.delistedAt);
      
      return formatted;
    } catch (e) {
      console.error("Erreur fetchDelistedFutures:", e);
      throw e;
    }
  }

  function renderTable(rows) {
    const q = $search.value.trim().toUpperCase();
    const view = q ? rows.filter(r => r.symbol.includes(q)) : rows;
    $count.textContent = view.length;
    $updated.textContent = fmtDateTimeFR(Date.now());
    
    // Détecte les nouvelles entrées
    let newItemsCount = 0;
    if (!firstLoad && previousRows.length > 0) {
      const previousSymbols = previousRows.map(r => r.symbol);
      rows.forEach(r => {
        r.isNew = !previousSymbols.includes(r.symbol);
        if (r.isNew) newItemsCount++;
      });
    }
    $newCount.textContent = newItemsCount;
    firstLoad = false;
    previousRows = [...rows];
    
    let html = "";
    if (view.length === 0) {
      html = `<tr><td colspan="3" class="muted" style="text-align:center;padding:18px">Aucune paire délistée trouvée.</td></tr>`;
    } else {
      for (const r of view) {
        html += `<tr${r.isNew ? ' class="new-item"' : ''}>
          <td class="mono">${r.symbol}${r.isNew ? ' <span style="color:#3b82f6;font-size:12px">(nouveau)</span>' : ''}</td>
          <td class="mono">${fmtDateFR(r.delistedAt)}</td>
          <td class="mono muted">${r.status}</td>
        </tr>`;
      }
    }
    $body.innerHTML = html;
  }

  async function loadAll() {
    masterRows = [];
    $body.innerHTML = `<tr><td colspan="3" class="muted" style="text-align:center;padding:18px">Chargement des données depuis Binance...</td></tr>`;
    $bar.style.width = "0%";
    try {
      const delistedPairs = await fetchDelistedFutures();
      masterRows = delistedPairs;
      renderTable(masterRows);
      $bar.style.width = "100%";
    } catch (e) {
      console.error("Erreur loadAll:", e);
      $body.innerHTML = `<tr><td colspan="3" style="color:#fecaca;background:#7f1d1d22;border:1px solid #7f1d1d;padding:14px;border-radius:12px">
        Erreur de chargement: ${e.message || 'Problème de connexion'}. Cliquez sur « Rafraîchir ».
      </td></tr>`;
    }
  }

  $refresh.addEventListener('click', loadAll);
  $search.addEventListener('input', () => renderTable(masterRows));
  $auto.addEventListener('change', () => {
    if ($auto.checked) {
      timer = setInterval(loadAll, 10 * 60 * 1000); // 10 minutes
      loadAll();
    } else { 
      clearInterval(timer); 
      timer = null; 
    }
  });

  // Initial load avec auto-refresh activé par défaut
  timer = setInterval(loadAll, 10 * 60 * 1000);
  loadAll();
})();
</script>
</body>
</html>