<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Historique 2025 Binance - Depuis 01/01/2025</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background-color: #eee; }
#progressContainer {
  width: 100%;
  background-color: #ddd;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 10px;
}
#progressBar {
  height: 20px;
  width: 0%;
  background-color: #4caf50;
  text-align: center;
  color: white;
  font-size: 12px;
  line-height: 20px;
  transition: width 0.3s ease;
}
#alertGreen div { color: green; margin-bottom: 4px; }
#alertRed div { color: red; margin-bottom: 4px; }
#alertsContainer { display: flex; gap: 40px; margin-top: 20px; }
#alertGreen, #alertRed { flex: 1; }
#alertGreen h3, #alertRed h3 {
  margin-bottom: 8px;
  border-bottom: 1px solid #ccc;
  padding-bottom: 4px;
}
</style>
</head>
<body>

<h2>Alertes : Variations depuis le 01/01/2025</h2>

<div id="progressContainer">
  <div id="progressBar">0%</div>
</div>

<div id="alertsContainer">
  <div id="alertGreen">
    <h3>Variations entre -70% et -78% (Vert)</h3>
  </div>
  <div id="alertRed">
    <h3>Variations ≥ 10000% (Rouge)</h3>
  </div>
</div>

<table>
<thead>
<tr>
  <th>Crypto</th>
  <th>Variation 2025 (%)</th>
  <th>Prix 01/01/2025</th>
  <th>Prix actuel</th>
</tr>
</thead>
<tbody id="cryptoTableBody"></tbody>
</table>

<script>
async function fetchUsdtSymbols() {
  const resp = await fetch('https://api.binance.com/api/v3/exchangeInfo');
  if (!resp.ok) throw new Error('Erreur récupération exchangeInfo');
  const data = await resp.json();
  return data.symbols
    .filter(s => s.status === 'TRADING' && s.symbol.endsWith('USDT') && s.isSpotTradingAllowed)
    .map(s => s.symbol);
}

async function fetchDailyKlines(symbol) {
  const startTime = new Date("2025-01-01T00:00:00Z").getTime();
  const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&startTime=${startTime}&limit=1000`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Erreur API pour ${symbol} : ${resp.status}`);
  return resp.json();
}

function updateProgress(current, total) {
  const progressBar = document.getElementById('progressBar');
  const percent = Math.round((current / total) * 100);
  progressBar.style.width = percent + '%';
  progressBar.textContent = percent + '%';
}

async function main() {
  const alertGreenDiv = document.getElementById('alertGreen');
  const alertRedDiv = document.getElementById('alertRed');
  const tbody = document.getElementById('cryptoTableBody');
  tbody.innerHTML = '';
  alertGreenDiv.innerHTML = '<h3>Variations entre -70% et -78% (Vert)</h3>';
  alertRedDiv.innerHTML = '<h3>Variations ≥ 10000% (Rouge)</h3>';

  let alertsGreen = [];
  let alertsRed = [];
  let rowsData = []; // Tableau pour stocker toutes les lignes avant tri

  try {
    const symbols = await fetchUsdtSymbols();
    const total = symbols.length;
    let processed = 0;

    for (const symbol of symbols) {
      try {
        const klines = await fetchDailyKlines(symbol);
        if (klines.length < 2) {
          processed++;
          updateProgress(processed, total);
          continue;
        }

        const firstClose = parseFloat(klines[0][4]);
        const lastClose = parseFloat(klines[klines.length - 1][4]);
        if (!firstClose || !lastClose) {
          processed++;
          updateProgress(processed, total);
          continue;
        }

        const variation = ((lastClose - firstClose) / firstClose) * 100;

        if (variation >= -78 && variation <= -70) {
          alertsGreen.push({ symbol, variation: variation.toFixed(2) });
        }
        if (variation >= 10000) {
          alertsRed.push({ symbol, variation: variation.toFixed(2) });
        }

        const color = (variation >= -78 && variation <= -70) ? 'green' :
                      (variation >= 10000 ? 'red' : '');

        rowsData.push({
          symbol,
          html: `
            <tr>
              <td>${symbol}</td>
              <td style="color:${color}">${variation.toFixed(2)}%</td>
              <td>${firstClose.toFixed(2)}</td>
              <td>${lastClose.toFixed(2)}</td>
            </tr>
          `
        });

      } catch (e) {
        console.error(e.message);
      }

      processed++;
      updateProgress(processed, total);
    }

    // Tri alphabétique par symbole
    rowsData.sort((a, b) => a.symbol.localeCompare(b.symbol));
    rowsData.forEach(row => tbody.insertAdjacentHTML('beforeend', row.html));

    // Tri et affichage alertes
    alertsGreen.sort((a,b) => a.symbol.localeCompare(b.symbol));
    alertsRed.sort((a,b) => a.symbol.localeCompare(b.symbol));

    if (alertsGreen.length > 0) {
      alertsGreen.forEach(a => {
        alertGreenDiv.insertAdjacentHTML('beforeend', `<div>${a.symbol} : ${a.variation}%</div>`);
      });
    } else {
      alertGreenDiv.insertAdjacentHTML('beforeend', '<div>Aucune variation détectée.</div>');
    }

    if (alertsRed.length > 0) {
      alertsRed.forEach(a => {
        alertRedDiv.insertAdjacentHTML('beforeend', `<div>${a.symbol} : ${a.variation}%</div>`);
      });
    } else {
      alertRedDiv.insertAdjacentHTML('beforeend', '<div>Aucune variation détectée.</div>');
    }

  } catch (e) {
    alertGreenDiv.insertAdjacentHTML('beforeend', `<div style="color:red;">Erreur : ${e.message}</div>`);
  }
}

main();
</script>

</body>
</html>
