<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Variations 5m — Sélection Binance Futures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8;
      --ok:#10b981; --bad:#ef4444; --text:#e5e7eb; --border:#1f2937; --warn:#f59e0b;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:18px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .wrap{padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;white-space:nowrap}
    th{position:sticky;top:0;background:var(--card);text-align:left}
    tfoot td{font-weight:700;border-top:1px solid var(--border)}
    .pos{color:var(--ok);font-variant-numeric:tabular-nums}
    .neg{color:var(--bad);font-variant-numeric:tabular-nums}
    .na{color:var(--muted)}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <header>
    <h1>Variation 5m — Sélection de cryptos Futures</h1>
    <div class="sub">
      21/10/2025 05:45 • 26/10/2025 11:10 • 26/10/2025 12:25 •
      05/11/2025 05:15 • 07:00 • 13:35 • 17:30 • 21:50 (Europe/Brussels)
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <p style="color:var(--muted);font-size:13px;margin-bottom:8px">
        Calcul = (Close − Open) / Open × 100 sur la bougie 5m correspondant à l’heure exacte (Europe/Brussels).
        Le <b>total</b> affiché en bas est la somme des variations (%) de toutes les lignes pour chaque date (valeurs manquantes ignorées).
      </p>

      <!-- UN SEUL TABLEAU -->
      <table id="table">
        <thead>
          <tr id="thead-row">
            <th>Symbole</th>
            <!-- Les colonnes de dates sont injectées ci-dessous -->
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr id="total-row">
            <td>Total (∑)</td>
            <!-- Totaux par date insérés ici -->
          </tr>
        </tfoot>
      </table>

      <p id="progress" class="warn">Chargement…</p>
    </div>
  </div>

  <script>
    const BASE = "https://fapi.binance.com";
    const INTERVAL = "5m";

    // Tes symboles actuels
    const symbols = [
      "JELLYJELLYUSDT",
      "MYXUSDT",
      "PROVEUSDT",
      "TRUTHUSDT",
      "USTCUSDT"
    ];

    // Nouveaux points (Europe/Brussels) — conversion DST auto
    const points = [
      { label:"21/10 05:45", y:2025, m:10, d:21, h:5,  min:45 },
      { label:"26/10 11:10", y:2025, m:10, d:26, h:11, min:10 },
      { label:"26/10 12:25", y:2025, m:10, d:26, h:12, min:25 },
      { label:"05/11 05:15", y:2025, m:11, d:5,  h:5,  min:15 },
      { label:"05/11 07:00", y:2025, m:11, d:5,  h:7,  min:0  },
      { label:"05/11 13:35", y:2025, m:11, d:5,  h:13, min:35 },
      { label:"05/11 17:30", y:2025, m:11, d:5,  h:17, min:30 },
      { label:"05/11 21:50", y:2025, m:11, d:5,  h:21, min:50 }
    ];

    const theadRow = document.getElementById("thead-row");
    const tbody = document.getElementById("tbody");
    const totalRow = document.getElementById("total-row");
    const progress = document.getElementById("progress");

    // Ajoute les entêtes de colonnes de dates
    for (const p of points) {
      const th = document.createElement("th");
      th.textContent = p.label;
      theadRow.appendChild(th);
    }

    // Conversion Europe/Brussels -> UTC (gère CEST/CET)
    function brusselsLocalToUtcMs(y,m,d,h,min){
      const fmt = new Intl.DateTimeFormat('en-US',{
        timeZone:'Europe/Brussels',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit',
        hourCycle:'h23'
      });
      const parts = fmt.formatToParts(new Date(Date.UTC(y, m-1, d, h, min, 0)));
      const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
      return Date.UTC(+map.year, +map.month-1, +map.day, +map.hour, +map.minute, +map.second);
    }

    const pointTimes = points.map(p => ({ label:p.label, openTimeMs: brusselsLocalToUtcMs(p.y,p.m,p.d,p.h,p.min) }));

    async function fetchKlinePct(symbol, openTimeMs){
      const url = `${BASE}/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&startTime=${openTimeMs}&limit=1`;
      const r = await fetch(url);
      if(!r.ok) return null;
      const data = await r.json();
      if(!data.length) return null;
      const k = data[0];
      if(+k[0] !== openTimeMs) return null;
      const open = parseFloat(k[1]), close = parseFloat(k[4]);
      if(!isFinite(open) || !isFinite(close) || open === 0) return null;
      return (close - open) / open * 100;
    }

    function fmtPct(v){
      if(v == null) return `<span class="na">—</span>`;
      const cls = v >= 0 ? "pos" : "neg";
      return `<span class="${cls}">${v.toFixed(2)}%</span>`;
    }
    function fmtTotal(v){
      if(v == null) return `<span class="na">—</span>`;
      const cls = v >= 0 ? "pos" : "neg";
      return `<span class="${cls}">${v.toFixed(2)}%</span>`;
    }

    async function main(){
      // Prépare la ligne de totaux (une cellule par date)
      const totalCells = [];
      for (let i=0;i<pointTimes.length;i++){
        const td = document.createElement("td");
        td.innerHTML = `<span class="na">—</span>`;
        totalRow.appendChild(td);
        totalCells.push(td);
      }

      // Accumulateurs de totaux par colonne
      const sums = new Array(pointTimes.length).fill(0);
      const counts = new Array(pointTimes.length).fill(0);

      let done = 0;
      for(const symbol of symbols){
        const tr = document.createElement("tr");
        // Symbole
        const tdSym = document.createElement("td");
        tdSym.textContent = symbol;
        tr.appendChild(tdSym);

        // Cellules des dates
        const tds = [];
        for(let i=0;i<pointTimes.length;i++){
          const td = document.createElement("td");
          td.innerHTML = `<span class="warn">…</span>`;
          tr.appendChild(td);
          tds.push(td);
        }
        tbody.appendChild(tr);

        // Remplissage et accumulation
        for(let i=0;i<pointTimes.length;i++){
          try{
            const pct = await fetchKlinePct(symbol, pointTimes[i].openTimeMs);
            tds[i].innerHTML = fmtPct(pct);
            if(pct != null){ sums[i] += pct; counts[i]++; }
          }catch{
            tds[i].innerHTML = `<span class="na">—</span>`;
          }
          await new Promise(r=>setTimeout(r,100)); // petit throttle
        }

        done++;
        if(done % 2 === 0) progress.textContent = `Progression : ${done}/${symbols.length}`;
      }

      // Affiche les totaux par date (en bas)
      for(let i=0;i<pointTimes.length;i++){
        if(counts[i] > 0){
          totalCells[i].innerHTML = fmtTotal(sums[i]);
        }else{
          totalCells[i].innerHTML = `<span class="na">—</span>`;
        }
      }

      progress.textContent = "Terminé ✅";
    }

    main();
  </script>
</body>
</html>
