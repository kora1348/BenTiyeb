<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Binance Futures â€” Delta Â±1 Scanner (Last 3 Days)</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;900&display=swap');

    :root {
      --bg: #0a0e1a;
      --surface: #141824;
      --border: #1e2535;
      --text: #e8eaed;
      --text-muted: #8a8f98;

      --accent-green: #00ff88;
      --accent-red: #ff3366;
      --accent-yellow: #ffd700;
      --accent-blue: #00aaff;

      --orange-bg: rgba(255, 170, 0, 0.16);
      --orange-text: #ffb300;
      --orange-border: rgba(255, 170, 0, 0.55);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      line-height: 1.6;
      padding: 18px;
      overflow-x: hidden;
    }
    .container{ max-width: 100%; margin:0 auto; }

    header{
      background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 22px;
      margin-bottom: 18px;
      box-shadow: 0 8px 32px rgba(0, 255, 136, 0.10);
    }
    h1{
      font-size: 22px;
      font-weight: 900;
      color: var(--accent-green);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 6px;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.25);
    }
    .subtitle{
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .info-bar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      align-items:center;
      justify-content: space-between;
    }
    .info-left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .info-item{
      background: var(--surface);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 12px;
      border: 1px solid var(--border);
      display:flex;
      gap:8px;
      align-items: center;
      white-space: nowrap;
    }
    .info-label{ color: var(--text-muted); }
    .info-value{ color: var(--accent-yellow); font-weight: 800; }

    .controls{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
      width: 100%;
    }
    .input, select{
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-family: inherit;
      font-size: 12px;
      outline: none;
      min-width: 220px;
    }
    select{ min-width: 200px; cursor:pointer; }

    .progress{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin: 12px 0 18px 0;
    }
    .progress-text{
      font-size: 12px;
      color: var(--text-muted);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .progress-bar{
      height: 8px;
      background: var(--border);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 8px;
    }
    .progress-fill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
      transition: width 0.25s ease;
    }

    .stats{
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
    }
    .stats-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--accent-yellow);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      display:flex; align-items:center; justify-content: space-between; gap: 10px;
      flex-wrap: wrap;
    }
    .stats-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 14px;
    }
    .stat-item{ text-align:center; }
    .stat-value{ font-size: 22px; font-weight: 900; margin-bottom: 4px; }
    .stat-label{ font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .sym{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .5px;
      color: var(--text);
    }
    .tag{
      font-size: 10px;
      font-weight: 900;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-muted);
      background: rgba(255,255,255,0.03);
      white-space: nowrap;
    }

    .dates{
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 6px;
      letter-spacing: .8px;
      text-transform: uppercase;
    }

    .coeff-line{
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .coeff-prev2{ color: var(--accent-blue); }
    .coeff-prev1{ color: var(--accent-yellow); }
    .coeff-current{ color: var(--accent-green); }

    .price{
      font-size: 11px;
      color: var(--text-muted);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .delta-badge{
      display:inline-block;
      padding: 5px 9px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 900;
      margin-top: 10px;
      letter-spacing: .5px;
    }
    .delta-positive{
      background: rgba(255, 51, 102, 0.18);
      color: var(--accent-red);
      border: 1px solid rgba(255, 51, 102, 0.65);
    }
    .delta-negative{
      background: rgba(0, 255, 136, 0.16);
      color: var(--accent-green);
      border: 1px solid rgba(0, 255, 136, 0.55);
    }
    .delta-neutral{
      background: rgba(138, 143, 152, 0.16);
      color: var(--text-muted);
      border: 1px solid rgba(138, 143, 152, 0.55);
    }
    .delta-extreme{
      background: var(--orange-bg);
      color: var(--orange-text);
      border: 1px solid var(--orange-border);
    }

    .error{
      background: rgba(255, 51, 102, 0.10);
      border: 2px solid var(--accent-red);
      border-radius: 12px;
      padding: 16px;
      color: var(--accent-red);
      text-align:center;
      margin-top: 14px;
    }

    .muted{ color: var(--text-muted); }

    @media (max-width: 768px){
      body{ padding: 14px; }
      h1{ font-size: 18px; }
      .grid{ grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
      .input{ min-width: 170px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>âš¡ FUTURES SCANNER â€” Î” Â±1 TRACKER</h1>
      <div class="subtitle">
        Scan de <b>toutes</b> les cryptos en Futures (Binance) â€” 3 derniers jours (J-2, J-1, J).
        RÃ©fÃ©rence = prix de J-2 â‡’ coefficient arrondi, puis Î” = diff des coeffs (J vs J-1).
      </div>

      <div class="info-bar">
        <div class="info-left">
          <div class="info-item">
            <span class="info-label">FenÃªtre:</span>
            <span class="info-value" id="windowLabel">â€”</span>
          </div>
          <div class="info-item">
            <span class="info-label">Futures USDT:</span>
            <span class="info-value" id="symCount">â€”</span>
          </div>
          <div class="info-item">
            <span class="info-label">ChargÃ©s:</span>
            <span class="info-value" id="loadedCount">0</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status:</span>
            <span class="info-value" id="status">Loadingâ€¦</span>
          </div>
        </div>

        <div class="controls">
          <input class="input" id="search" placeholder="Rechercher (ex: BTC, SOL, PIPPINâ€¦)" />
          <select id="sort">
            <option value="deltaDesc">Trier: Î” (desc)</option>
            <option value="deltaAsc">Trier: Î” (asc)</option>
            <option value="absDeltaDesc">Trier: |Î”| (desc)</option>
            <option value="symbolAsc">Trier: Symbol (Aâ†’Z)</option>
          </select>
        </div>
      </div>
    </header>

    <div class="progress" id="progress">
      <div class="progress-text">
        <span id="progressLeft">Initialisationâ€¦</span>
        <span id="progressRight">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="stats" id="stats" style="display:none;">
      <div class="stats-title">
        <span>ðŸ“Š Statistics (Î” entre J et J-1)</span>
        <span class="muted" id="statsHint">â€”</span>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" style="color: var(--accent-red);" id="statPos">0</div>
          <div class="stat-label">Î” Positifs</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color: var(--accent-green);" id="statNeg">0</div>
          <div class="stat-label">Î” NÃ©gatifs</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color: var(--accent-blue);" id="statZero">0</div>
          <div class="stat-label">Î” = 0</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color: var(--accent-yellow);" id="statMax">â€”</div>
          <div class="stat-label">Max Î”</div>
        </div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="error" style="display:none;"></div>
  </div>

  <script>
    (() => {
      const API_BASE = 'https://fapi.binance.com';
      const CONCURRENCY = 10;

      // IMPORTANT:
      // - Si tu fixes ?base=2026-02-14  => on affiche 12/02 | 13/02 | 14/02
      // - Par dÃ©faut (sans base), on prend "dernier jour complet" = Belgique - 1 jour
      //   => le 15/02/2026, on affiche 12/02 | 13/02 | 14/02 (et pas 13/02 | 14/02 | 15/02)
      const BASE_PARAM = new URLSearchParams(location.search).get('base'); // YYYY-MM-DD

      const el = {
        windowLabel: document.getElementById('windowLabel'),
        symCount: document.getElementById('symCount'),
        loadedCount: document.getElementById('loadedCount'),
        status: document.getElementById('status'),

        progress: document.getElementById('progress'),
        progressFill: document.getElementById('progressFill'),
        progressLeft: document.getElementById('progressLeft'),
        progressRight: document.getElementById('progressRight'),

        stats: document.getElementById('stats'),
        statsHint: document.getElementById('statsHint'),
        statPos: document.getElementById('statPos'),
        statNeg: document.getElementById('statNeg'),
        statZero: document.getElementById('statZero'),
        statMax: document.getElementById('statMax'),

        grid: document.getElementById('grid'),
        error: document.getElementById('error'),

        search: document.getElementById('search'),
        sort: document.getElementById('sort'),
      };

      async function fetchJSON(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} â€” ${url}`);
        return res.json();
      }

      function getBelgiumYMD(date = new Date()) {
        const parts = new Intl.DateTimeFormat('en-CA', {
          timeZone: 'Europe/Brussels',
          year: 'numeric', month: '2-digit', day: '2-digit'
        }).formatToParts(date);
        const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
        return `${map.year}-${map.month}-${map.day}`;
      }

      function ymdToUTCStartMs(ymd) {
        return Date.parse(ymd + 'T00:00:00Z');
      }

      function addDaysYMD(ymd, deltaDays) {
        const d = new Date(ymd + 'T00:00:00Z');
        d.setUTCDate(d.getUTCDate() + deltaDays);
        return d.toISOString().slice(0, 10);
      }

      function formatFR(ymd) {
        const [y,m,d] = ymd.split('-');
        return `${d}/${m}/${y}`;
      }

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function formatPrice(p) {
        if (p === null || p === undefined || !Number.isFinite(p)) return 'â€”';
        if (p >= 1000) return p.toFixed(2);
        if (p >= 1) return p.toFixed(6);
        return p.toFixed(10);
      }

      function signedCoeff(ref, cur) {
        if (!Number.isFinite(ref) || !Number.isFinite(cur) || ref <= 0 || cur <= 0) return null;
        if (cur >= ref) return Math.round(cur / ref);
        return -Math.round(ref / cur);
      }

      function formatCoeff(c) {
        if (c === null) return 'â€”';
        return c > 0 ? `+${c}` : `${c}`;
      }

      function deltaBadge(delta) {
        if (delta === null) return { text: 'Î” â€”', cls: 'delta-neutral' };
        if (delta > 0) {
          const cls = (delta === 1) ? 'delta-positive' : 'delta-extreme';
          return { text: `Î” +${delta}`, cls };
        }
        if (delta < 0) {
          const cls = (delta === -1) ? 'delta-negative' : 'delta-extreme';
          return { text: `Î” ${delta}`, cls };
        }
        return { text: `Î” 0`, cls: 'delta-neutral' };
      }

      function setProgress(done, total, leftText) {
        const pct = total ? Math.round((done / total) * 100) : 0;
        el.progressFill.style.width = `${clamp(pct,0,100)}%`;
        el.progressRight.textContent = `${clamp(pct,0,100)}%`;
        if (leftText) el.progressLeft.textContent = leftText;
      }

      function cardHTML(row) {
        const badge = deltaBadge(row.delta);
        return `
          <div class="card" data-symbol="${row.symbol}">
            <div class="top">
              <div class="sym">${row.symbol}</div>
              <div class="tag">PERP Â· USDT</div>
            </div>

            <div class="dates">${formatFR(row.d2)} | ${formatFR(row.d1)} | ${formatFR(row.d0)} (TODAY)</div>

            <div class="coeff-line">
              <span class="coeff-prev2">${formatCoeff(row.c2)}</span>
              <span class="muted">|</span>
              <span class="coeff-prev1">${formatCoeff(row.c1)}</span>
              <span class="muted">|</span>
              <span class="coeff-current">${formatCoeff(row.c0)}</span>
            </div>

            <div class="price">
              <span>Ref (J-2): <b class="muted">${formatPrice(row.ref)}</b></span>
              <span>Now: <b class="muted">${formatPrice(row.now)}</b></span>
            </div>

            <div class="delta-badge ${badge.cls}">${badge.text}</div>
          </div>
        `;
      }

      async function getPerpUSDTsymbols() {
        const data = await fetchJSON(`${API_BASE}/fapi/v1/exchangeInfo`);
        return (data.symbols || [])
          .filter(s =>
            s.contractType === 'PERPETUAL' &&
            s.quoteAsset === 'USDT' &&
            s.status === 'TRADING'
          )
          .map(s => s.symbol);
      }

      async function getAllLivePricesMap() {
        const arr = await fetchJSON(`${API_BASE}/fapi/v1/ticker/price`);
        const map = new Map();
        for (const it of arr) {
          if (it && it.symbol && it.price) map.set(it.symbol, Number(it.price));
        }
        return map;
      }

      async function get2DailyCloses(symbol, d2YMD, d0YMD) {
        // We request daily klines from start of d2 to start of d0 (excluded),
        // limit=2 => (d2 close, d1 close).
        const start = ymdToUTCStartMs(d2YMD);
        const end = ymdToUTCStartMs(d0YMD);
        const url = `${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=1d&startTime=${start}&endTime=${end}&limit=2`;
        const kl = await fetchJSON(url);
        if (!Array.isArray(kl) || kl.length === 0) return { close2: null, close1: null };
        const close2 = (kl[0] && kl[0][4]) ? Number(kl[0][4]) : null;
        const close1 = (kl[1] && kl[1][4]) ? Number(kl[1][4]) : null;
        return { close2, close1 };
      }

      function pLimit(limit) {
        let active = 0;
        const queue = [];
        const next = () => {
          if (active >= limit || queue.length === 0) return;
          active++;
          const { fn, resolve, reject } = queue.shift();
          fn().then(resolve).catch(reject).finally(() => {
            active--;
            next();
          });
        };
        return (fn) => new Promise((resolve, reject) => {
          queue.push({ fn, resolve, reject });
          next();
        });
      }

      let allRows = [];

      function applyUI() {
        const q = (el.search.value || '').trim().toUpperCase();
        const mode = el.sort.value;

        let rows = allRows.slice();
        if (q) rows = rows.filter(r => r.symbol.includes(q));

        const getDelta = (r) => (r.delta === null ? -999999 : r.delta);
        const getAbsDelta = (r) => (r.delta === null ? -1 : Math.abs(r.delta));

        rows.sort((a,b) => {
          if (mode === 'symbolAsc') return a.symbol.localeCompare(b.symbol);
          if (mode === 'deltaAsc') return getDelta(a) - getDelta(b);
          if (mode === 'absDeltaDesc') return getAbsDelta(b) - getAbsDelta(a);
          return getDelta(b) - getDelta(a);
        });

        el.grid.innerHTML = rows.map(cardHTML).join('');
      }

      async function main() {
        try {
          el.status.textContent = 'Fetching symbolsâ€¦';
          setProgress(0, 1, 'RÃ©cupÃ©ration des symboles futuresâ€¦');

          // âœ… FIX: sans ?base=, on prend "dernier jour complet" = Belgique - 1 jour
          const rawBelgiumToday = getBelgiumYMD(new Date());
          const defaultBase = addDaysYMD(rawBelgiumToday, -1); // hier en BE

          const baseYMD = (BASE_PARAM && /^\d{4}-\d{2}-\d{2}$/.test(BASE_PARAM))
            ? BASE_PARAM
            : defaultBase;

          const d0 = baseYMD;                 // "TODAY" = dernier jour complet
          const d1 = addDaysYMD(baseYMD, -1); // d0-1
          const d2 = addDaysYMD(baseYMD, -2); // d0-2

          el.windowLabel.textContent = `${formatFR(d2)} â†’ ${formatFR(d0)} (BE)`;
          el.statsHint.textContent = `RÃ©f = clÃ´ture J-2 Â· Î” = coeff(J) - coeff(J-1)`;

          const symbols = await getPerpUSDTsymbols();
          el.symCount.textContent = symbols.length.toString();

          el.status.textContent = 'Fetching live pricesâ€¦';
          setProgress(0, 1, 'RÃ©cupÃ©ration des prix LIVE (1 requÃªte)â€¦');
          const liveMap = await getAllLivePricesMap();

          el.status.textContent = 'Scanningâ€¦';
          const limit = pLimit(CONCURRENCY);

          let done = 0;
          let ok = 0;

          let pos = 0, neg = 0, zero = 0;
          let maxDelta = -Infinity;

          setProgress(0, symbols.length, `Scan des futures (concurrency=${CONCURRENCY})â€¦`);

          const tasks = symbols.map(sym => limit(async () => {
            const now = liveMap.get(sym);
            if (!Number.isFinite(now)) {
              done++;
              el.loadedCount.textContent = String(ok);
              setProgress(done, symbols.length, `Scanâ€¦ (${done}/${symbols.length})`);
              return;
            }

            let close2 = null, close1 = null;
            try {
              const res = await get2DailyCloses(sym, d2, d0);
              close2 = res.close2; // close of d2
              close1 = res.close1; // close of d1
            } catch (_) {}

            const ref = close2;

            const c2 = signedCoeff(ref, close2);
            const c1 = signedCoeff(ref, close1);
            const c0 = signedCoeff(ref, now);

            const delta = (c0 !== null && c1 !== null) ? (c0 - c1) : null;

            if (delta !== null) {
              if (delta > 0) pos++;
              else if (delta < 0) neg++;
              else zero++;
              if (delta > maxDelta) maxDelta = delta;
            }

            allRows.push({
              symbol: sym,
              d0, d1, d2,
              ref,
              now,
              close2,
              close1,
              c2, c1, c0,
              delta
            });

            ok++;
            done++;

            if (done % 12 === 0 || done === symbols.length) {
              el.loadedCount.textContent = String(ok);
              setProgress(done, symbols.length, `Scanâ€¦ (${done}/${symbols.length})`);
              el.statPos.textContent = String(pos);
              el.statNeg.textContent = String(neg);
              el.statZero.textContent = String(zero);
              el.statMax.textContent = (maxDelta === -Infinity) ? 'â€”' : (maxDelta > 0 ? `+${maxDelta}` : String(maxDelta));
              el.stats.style.display = 'block';
              applyUI();
            } else {
              el.loadedCount.textContent = String(ok);
              setProgress(done, symbols.length, `Scanâ€¦ (${done}/${symbols.length})`);
            }
          }));

          await Promise.all(tasks);

          el.status.textContent = 'Complete âœ“';
          el.progressLeft.textContent = `TerminÃ©: ${ok}/${symbols.length} symboles affichÃ©s`;
          setProgress(symbols.length, symbols.length);

          el.statPos.textContent = String(pos);
          el.statNeg.textContent = String(neg);
          el.statZero.textContent = String(zero);
          el.statMax.textContent = (maxDelta === -Infinity) ? 'â€”' : (maxDelta > 0 ? `+${maxDelta}` : String(maxDelta));
          el.stats.style.display = 'block';
          applyUI();

          el.search.addEventListener('input', applyUI);
          el.sort.addEventListener('change', applyUI);

        } catch (err) {
          console.error(err);
          el.status.textContent = 'Error âœ—';
          el.error.textContent = `Error: ${err.message || err}`;
          el.error.className = 'error';
          el.error.style.display = 'block';
        }
      }

      main();
    })();
  </script>
</body>
</html>
