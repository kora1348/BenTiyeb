<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Listings de septembre ‚Äî 20e bougie (Binance Futures USDT-M PERP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ok:#10b981; --bad:#ef4444; --text:#e5e7eb; --border:#1f2937; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:18px 16px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    main{max-width:900px;margin:18px auto;padding:0 12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
    select,button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;text-align:right;vertical-align:top}
    th:first-child,td:first-child{text-align:left}
    .up{color:var(--ok);font-weight:600}
    .down{color:var(--bad);font-weight:600}
    .muted{color:var(--muted)}
    .error{color:var(--bad);margin-top:8px}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
    .right{position:absolute;top:12px;right:12px}
  </style>
</head>
<body>
  <header>
    <h1>Listings en septembre ‚Ä¢ 20e bougie</h1>
    <div class="sub">March√© analys√© : <b>Binance Futures ‚Äî USDT-M PERP</b></div>
  </header>

  <main>
    <div class="controls">
      <label>
        <span class="muted">Ann√©e</span><br>
        <select id="yearSel"></select>
      </label>
      <label>
        <span class="muted">Mois</span><br>
        <select id="monthSel"></select>
      </label>
      <div style="align-self:end;display:flex;gap:8px">
        <button id="runBtn">Lister</button>
        <span id="status" class="muted" style="align-self:center"></span>
      </div>
    </div>

    <div class="card">
      <div class="right badge"><span id="progress">‚Äî</span></div>
      <table>
        <thead>
          <tr>
            <th style="width:180px">Symbole</th>
            <th style="width:260px">Date 20e bougie (Europe/Brussels)</th>
            <th style="width:260px">Date &gt; 1 an apr√®s (Europe/Brussels)</th>
            <th style="width:170px">Variation 20e bougie</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="err" class="error"></div>
      <div class="hint">
        D√©tection du listing (non affich√©e) : premi√®re bougie journali√®re disponible (<code>startTime=0</code>).<br>
        On conserve uniquement les cryptos dont le <b>jour de listing</b> est dans le mois/ann√©e choisis.<br>
        20e bougie = jour n¬∞20 apr√®s le listing. Variation = (Close ‚àí Open) / Open √ó 100. La colonne ‚Äú&gt; 1 an apr√®s‚Äù = (20e bougie) + 1 an (strictement &gt; 1 an).
      </div>
    </div>
  </main>

  <script>
    const tz = 'Europe/Brussels';
    const yearSel = document.getElementById('yearSel');
    const monthSel = document.getElementById('monthSel');
    const runBtn = document.getElementById('runBtn');
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const tbody = document.getElementById('tbody');
    const errEl = document.getElementById('err');

    // --- UI init (par d√©faut: Septembre 2025) ---
    (function initSelectors(){
      // ann√©es "r√©elles" pour le backend
      const years = [2023, 2024, 2025];

      // üëâ on affiche +1 mais on garde la valeur r√©elle
      years.forEach(y=>{
        const o = document.createElement('option');
        o.value = String(y);          // utilis√© par le backend (inchang√©)
        o.textContent = String(y + 1); // affichage seulement
        o.dataset.realYear = y;        // (optionnel) utile pour debug
        yearSel.appendChild(o);
      });
      yearSel.value = '2025';          // valeur r√©elle s√©lectionn√©e (affiche 2026)

      const months = [
        '01 Jan','02 F√©v','03 Mar','04 Avr','05 Mai','06 Jun',
        '07 Jul','08 Ao√ª','09 Sep','10 Oct','11 Nov','12 D√©c'
      ];
      months.forEach((m,i)=>{
        const o = document.createElement('option');
        o.value = i; o.textContent = m;
        monthSel.appendChild(o);
      });
      monthSel.value = 8; // septembre
    })();

    function toBrusselsDate(ms){
      const d = new Date(ms);
      return new Intl.DateTimeFormat('fr-BE', {
        timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      }).format(d);
    }
    function monthYearInBrussels(ms){
      const d = new Date(new Intl.DateTimeFormat('en-CA', {
        timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'
      }).format(new Date(ms)) + 'T00:00:00');
      return { y: d.getUTCFullYear(), m: d.getUTCMonth() };
    }
    // Strictement > 1 an : +1 an puis +1 milliseconde (pas +1 jour)
    function plusThanOneYear(ms){
      const d = new Date(ms);
      d.setUTCFullYear(d.getUTCFullYear() + 1);
      return d.getTime() + 1; // √©vite l'√©galit√© pile √† 1 an
    }

    const fmtPct = n => (n>=0?'+':'') + n.toFixed(4) + ' %';

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status} ‚Äî ${await r.text()}`);
      return r.json();
    }

    // Limiteur de concurrence
    async function mapLimit(items, limit, worker){
      const ret = [];
      let i = 0, active = 0, done = 0;
      return new Promise(resolve=>{
        const next = ()=>{
          while(active < limit && i < items.length){
            const idx = i++, item = items[idx];
            active++;
            Promise.resolve(worker(item, idx))
              .then(res=>{ ret[idx] = res; })
              .catch(()=>{ ret[idx] = null; })
              .finally(()=>{
                active--; done++;
                progressEl.textContent = `${done}/${items.length}`;
                if(done === items.length) resolve(ret);
                else next();
              });
          }
        };
        next();
      });
    }

    async function run(){
      errEl.textContent = '';
      statusEl.textContent = 'Chargement des symboles‚Ä¶';
      tbody.innerHTML = '';
      progressEl.textContent = '‚Äî';

      const Y = parseInt(yearSel.value,10);
      const M = parseInt(monthSel.value,10);

      try{
        // 1) Tous les PERP USDT actifs
        const ex = await fetchJSON('https://fapi.binance.com/fapi/v1/exchangeInfo');
        const symbols = (ex.symbols || [])
          .filter(s => s.contractType === 'PERPETUAL' && s.quoteAsset === 'USDT' && s.status === 'TRADING')
          .map(s => s.symbol);

        statusEl.textContent = `Analyse des premiers listings (${symbols.length} symboles)‚Ä¶`;

        // 2) Pour chaque symbole : jusqu'√† 20 bougies depuis le d√©but
        const rows = await mapLimit(symbols, 6, async (sym)=>{
          try{
            const u = new URL('https://fapi.binance.com/fapi/v1/klines');
            u.searchParams.set('symbol', sym);
            u.searchParams.set('interval', '1d');
            u.searchParams.set('limit', '20');
            u.searchParams.set('startTime', '0');
            const kl = await fetchJSON(u.toString());
            if(!kl || !kl.length) return null;

            // Bougie 1 (listing) ‚Äî utilis√©e pour filtrer le mois/ann√©e
            const k1 = kl[0];
            const openTime1 = k1[0];

            const { y, m } = monthYearInBrussels(openTime1);
            if (y !== Y || m !== M) return null; // list√© hors mois cibl√©

            // 20e bougie (date + variation) si dispo
            let openTime20 = null, pct20 = null, openTime20Plus = null;
            if (kl.length >= 20){
              const k20 = kl[19];
              openTime20 = k20[0];
              const open20 = parseFloat(k20[1]);
              const close20 = parseFloat(k20[4]);
              pct20 = open20>0 ? ((close20-open20)/open20*100) : 0;
              openTime20Plus = plusThanOneYear(openTime20);
            }

            return { sym, openTime20, openTime20Plus, pct20 };
          }catch(e){
            return null;
          }
        });

        const out = rows.filter(Boolean).sort((a,b)=>{
          if (a.openTime20 && b.openTime20) return a.openTime20 - b.openTime20;
          if (a.openTime20) return -1;
          if (b.openTime20) return 1;
          return a.sym.localeCompare(b.sym);
        });

        if(out.length === 0){
          tbody.innerHTML = `<tr><td colspan="4" class="muted">Aucun nouveau PERP USDT-M list√© en ${String(M+1).padStart(2,'0')}/${Y}.</td></tr>`;
        } else {
          const frag = document.createDocumentFragment();
          out.forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.sym}</td>
              <td>${r.openTime20===null ? '<span class="muted">‚Äî</span>' : toBrusselsDate(r.openTime20)}</td>
              <td>${r.openTime20Plus===null ? '<span class="muted">‚Äî</span>' : toBrusselsDate(r.openTime20Plus)}</td>
              <td>${r.pct20===null ? '<span class="muted">‚Äî</span>' : `<span class="${r.pct20>=0?'up':'down'}">${fmtPct(r.pct20)}</span>`}</td>
            `;
            frag.appendChild(tr);
          });
          tbody.appendChild(frag);
        }

        statusEl.textContent = `Termin√© ‚Äî ${out.length} symbole(s) en ${String(M+1).padStart(2,'0')}/${Y}`;
      }catch(e){
        console.error(e);
        errEl.textContent = 'Erreur: ' + e.message;
        statusEl.textContent = '';
      }
    }

    document.getElementById('runBtn').addEventListener('click', run);
    run(); // lancement initial (Septembre 2025)
  </script>
</body>
</html>
