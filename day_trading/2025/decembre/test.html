<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title></title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
      .container{background:white;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:1400px;width:100%}
      h1{text-align:center;color:#333;margin-bottom:6px;font-size:28px}
      .hint{color:#6b7280;text-align:center;margin-bottom:24px;font-size:13px}
      table{width:100%;border-collapse:collapse;margin-bottom:20px;background:white;border-radius:10px;overflow:hidden}
      thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
      th{padding:15px 10px;text-align:center;font-weight:bold;font-size:14px}
      td{padding:15px 10px;text-align:center;border-bottom:1px solid #eee;font-size:14px}
      tbody tr:last-child td{border-bottom:none}
      tbody tr:hover{background:#f8f9fa}
      .symbol{font-weight:bold;color:#333}
      .positive{color:#22c55e;font-weight:bold}
      .negative{color:#ef4444;font-weight:bold}
      .loading{text-align:center;color:#666;padding:20px}
      .error{background:#fee;border:1px solid #fcc;color:#c33;padding:15px;border-radius:10px;margin-bottom:20px}
      button{width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:transform .2s;margin-bottom:10px}
      button:hover{transform:translateY(-2px)}
      button:disabled{opacity:.5;cursor:not-allowed}
      .progress-container{width:100%;background:#e5e7eb;border-radius:10px;height:30px;overflow:hidden;margin-bottom:20px;box-shadow:inset 0 2px 4px rgba(0,0,0,.1)}
      .progress-bar{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);border-radius:10px;transition:width .3s ease;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px}
      .year-badge{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:12px;font-weight:bold;display:inline-block;margin-bottom:10px}
      .year-badge a{color:white;text-decoration:none}

      /* ‚úÖ MODIF UNIQUEMENT ICI : 3 boutons sur 1 ligne */
      .nav-buttons{
        display:grid;
        grid-template-columns:1fr 1fr 1fr;
        gap:10px;
        margin-bottom:20px
      }
      .nav-btn{
        padding:12px;
        border-radius:10px;
        text-align:center;
        text-decoration:none;
        color:white;
        font-weight:bold;
        transition:transform .2s;
        display:block
      }
      .nav-btn:hover{transform:translateY(-2px)}
      .nav-btn.spike-max{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)}
      .nav-btn.spike-min{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%)}
      .nav-btn.variation{background:linear-gradient(135deg,#111827 0%,#000000 100%)}

      @media (max-width:900px){
        .nav-buttons{grid-template-columns:1fr; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="pageTitle">üìä Taux de variation (Bougies Daily - ?)</h1>
      <div class="hint">üïê D√©but bougie Binance (UTC+8) ‚âà <strong>01h en hiver</strong> / <strong>02h en √©t√©</strong> √† Bruxelles</div>

      <div style="text-align:center;">
        <span class="year-badge"><a href="/index.html">Ann√©e 2025</a></span>
        <div style="margin-top:10px; margin-bottom: 10px;color:#667eea;font-weight:bold;font-size:16px;">
          üìÖ Date de r√©f√©rence : <span id="refDateDisplay"></span>
        </div>
      </div>

      <div class="nav-buttons">
        <a id="btnSpikeMax" href="#" class="nav-btn spike-max">üìà Voir Spike Max (m√®che haute)</a>
        <a id="btnSpikeMin" href="#" class="nav-btn spike-min">üìâ Voir Spike Min (m√®che basse)</a>
        <a id="btnVariationLink" href="#" class="nav-btn variation">‚ÜîÔ∏è Variation (Close/Open)</a>
      </div>

      <div id="progressContainer" style="display:none;">
        <div class="progress-container">
          <div id="progressBar" class="progress-bar" style="width:0%;">0%</div>
        </div>
      </div>

      <div id="content"><div class="loading">Chargement des donn√©es...</div></div>

      <button id="refreshBtn">üîÑ Actualiser</button>
      <p>R + R + R + V + V + R</p>
    </div>

    <script>
      const REF_DATE_FR = '19/12/2025';

      const BASE_REF_FR = '19/12/2025';
      const BASE_DATES_FR = [
        '17/04/2025',
        '24/04/2025',
        '15/09/2025',
        '18/09/2025',
        '15/12/2025',
        '19/12/2025'
      ];

      const pad2 = n => String(n).padStart(2,'0');
      function parseFR(strFR){
        const [jj,mm,aaaa] = strFR.split('/').map(Number);
        return new Date(Date.UTC(aaaa, mm-1, jj));
      }
      function formatFR(d){
        return `${pad2(d.getUTCDate())}/${pad2(d.getUTCMonth()+1)}/${d.getUTCFullYear()}`;
      }
      function formatISO(d){
        return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())}`;
      }
      function daysBetweenUTC(d1,d2){
        const ms = 24*60*60*1000;
        const t1 = Date.UTC(d1.getUTCFullYear(), d1.getUTCMonth(), d1.getUTCDate());
        const t2 = Date.UTC(d2.getUTCFullYear(), d2.getUTCMonth(), d2.getUTCDate());
        return Math.round((t2 - t1)/ms);
      }
      function addDaysUTC(d, n){
        const cp = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
        cp.setUTCDate(cp.getUTCDate() + n);
        return cp;
      }

      function computeShiftedDates(){
        const baseRef = parseFR(BASE_REF_FR);
        const refSel  = parseFR(REF_DATE_FR);
        const delta   = daysBetweenUTC(baseRef, refSel);
        const datesFR = [];
        const datesISO = [];
        for (const fr of BASE_DATES_FR){
          const d0 = parseFR(fr);
          const d  = addDaysUTC(d0, delta);
          datesFR.push(formatFR(d));
          datesISO.push(formatISO(d));
        }
        return { datesFR, datesISO };
      }

      function ddmmyyyyToPartsFR(str){
        const [jj, mm, aaaa] = str.split('/').map(Number);
        return { jj, mm, aaaa };
      }
      function dateUTC(yyyy, mm, dd){
        return new Date(Date.UTC(yyyy, mm - 1, dd));
      }

      (function applyTitleLinksAndRefDate() {
        const ref20 = dateUTC(2025, 10, 9);

        const { jj, mm, aaaa } = ddmmyyyyToPartsFR(REF_DATE_FR);
        const refSel = dateUTC(aaaa, mm, jj);

        const deltaDays = daysBetweenUTC(ref20, refSel);
        const numeroBougie = 20 + deltaDays;
        const h1 = document.getElementById('pageTitle');
        if (h1) h1.textContent = `üìä Taux de variation (Bougies Daily - ${numeroBougie})`;

        const t = document.querySelector('title');
        if (t) {
          const yy = String(aaaa).slice(-2);
          t.textContent = `${pad2(jj)}-${pad2(mm)}-${yy}`;
        }

        const jjStr = pad2(jj);
        const mmStr = pad2(mm);
        const yyStr = String(aaaa).slice(-2);

        const moisFR = [
          'janvier','fevrier','mars','avril','mai','juin',
          'juillet','aout','septembre','octobre','novembre','decembre'
        ];
        const monthFolder = moisFR[mm - 1];

        const basePath = `/day_trading/${aaaa}/${monthFolder}/${jjStr}-${mmStr}-${yyStr}`;
        const linkMax = document.getElementById('linkSpikeMax');
        const linkMin = document.getElementById('linkSpikeMin');

        if (linkMax) linkMax.href = `${basePath}/futures-spike-max-${aaaa}.html`;
        if (linkMin) linkMin.href = `${basePath}/futures-spike-min-${aaaa}.html`;

        const refSpan = document.getElementById('refDateDisplay');
        if (refSpan) refSpan.textContent = `${pad2(jj)}/${pad2(mm)}/${aaaa}`;
      })();

      const API = 'https://fapi.binance.com';
      const U = s => s.trim().toUpperCase();

      function binanceDailyWindow(dateISO){
        const baseUTC = new Date(dateISO + 'T00:00:00.000Z');
        const start = new Date(baseUTC.getTime() - 8 * 60 * 60 * 1000);
        const end   = new Date(start.getTime() + 24 * 60 * 60 * 1000 - 1);
        return { start, end };
      }

      async function getKline(symbol, dateISO){
        const { start, end } = binanceDailyWindow(dateISO);
        const url = `${API}/fapi/v1/klines?symbol=${U(symbol)}&interval=1d&startTime=${start.getTime()}&endTime=${end.getTime()}&limit=1`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Erreur API pour ${symbol} (${res.status})`);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) return null;
        return data[0];
      }

      function calculateDailyVariation(kline){
        const open = parseFloat(kline[1]);
        const close = parseFloat(kline[4]);
        return ((close - open) / open) * 100;
      }
      function calculateSpikeMax(kline){
        const open = parseFloat(kline[1]);
        const high = parseFloat(kline[2]);
        return ((high - open) / open) * 100;
      }
      function calculateSpikeMin(kline){
        const open = parseFloat(kline[1]);
        const low = parseFloat(kline[3]);
        return ((low - open) / open) * 100;
      }

      let CURRENT_MODE = 'variation';

      function setMode(mode){
        CURRENT_MODE = mode;
      }
      function computeMetricFromKline(kline){
        if (!kline) return null;
        if (CURRENT_MODE === 'spike_max') return calculateSpikeMax(kline);
        if (CURRENT_MODE === 'spike_min') return calculateSpikeMin(kline);
        return calculateDailyVariation(kline);
      }

      async function fetchData(){
        const content = document.getElementById('content');
        const btn = document.getElementById('refreshBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        btn.disabled = true;
        content.innerHTML = '';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        try{
          const symbols = [
            "AEVOUSDT","ARPAUSDT","AXLUSDT","DIAUSDT","EGLDUSDT","IDUSDT","RONINUSDT","WLDUSDT",
            "1000satsusdt","1000luncusdt","ANKRUSDT","DENTUSDT","ENJUSDT","NXPCUSDT",
          ].map(U);

          const { datesFR, datesISO } = computeShiftedDates();

          const totalRequests = symbols.length * datesISO.length;
          let completedRequests = 0;

          const allPromises = [];
          for (const symbol of symbols){
            for (const dateISO of datesISO){
              allPromises.push(
                getKline(symbol, dateISO)
                  .then(kline=>{
                    completedRequests++;
                    const p = Math.round((completedRequests / totalRequests) * 100);
                    progressBar.style.width = p + '%';
                    progressBar.textContent = p + '%';
                    const v = computeMetricFromKline(kline);
                    return (v === null || !isFinite(v)) ? null : v;
                  })
                  .catch(()=>{
                    completedRequests++;
                    const p = Math.round((completedRequests / totalRequests) * 100);
                    progressBar.style.width = p + '%';
                    progressBar.textContent = p + '%';
                    return null;
                  })
              );
            }
          }

          const allValues = await Promise.all(allPromises);

          const results = [];
          for (let i=0;i<symbols.length;i++){
            const values = allValues.slice(i*datesISO.length,(i+1)*datesISO.length);
            results.push({ symbol: symbols[i], values });
          }

          progressContainer.style.display = 'none';

          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>Symbole</th>
                  ${datesFR.map(d=>`<th>${d}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
          `;

          const totals = new Array(datesISO.length).fill(0);
          const counts = new Array(datesISO.length).fill(0);

          results.forEach(r=>{
            tableHTML += `<tr><td class="symbol">${r.symbol}</td>`;
            r.values.forEach((v, idx)=>{
              if (v === null || !isFinite(v)){
                tableHTML += `<td style="color:#9ca3af;">N/A</td>`;
              } else {
                const cls = v >= 0 ? 'positive':'negative';
                const sign = v >= 0 ? '+' : '';
                tableHTML += `<td class="${cls}">${sign}${v.toFixed(2)}%</td>`;
                totals[idx] += v;
                counts[idx]++;
              }
            });
            tableHTML += `</tr>`;
          });

          tableHTML += `<tr style="background:#f3f4f6;font-weight:bold;border-top:3px solid #667eea;">`;
          tableHTML += `<td class="symbol">TOTAL</td>`;
          totals.forEach((total, idx)=>{
            if (counts[idx] === 0){
              tableHTML += `<td style="color:#9ca3af;">N/A</td>`;
            } else {
              const cls = total >= 0 ? 'positive':'negative';
              const sign = total >= 0 ? '+' : '';
              tableHTML += `<td class="${cls}">${sign}${total.toFixed(2)}%</td>`;
            }
          });
          tableHTML += `</tr>`;

          tableHTML += `</tbody></table>`;
          content.innerHTML = tableHTML;

        } catch(err){
          progressContainer.style.display = 'none';
          content.innerHTML = `<div class="error"><strong>Erreur:</strong> ${err.message}</div>`;
        } finally{
          btn.disabled = false;
        }
      }

      document.getElementById('btnSpikeMax').addEventListener('click', (e)=>{
        e.preventDefault();
        setMode('spike_max');
        fetchData();
      });

      document.getElementById('btnSpikeMin').addEventListener('click', (e)=>{
        e.preventDefault();
        setMode('spike_min');
        fetchData();
      });

      document.getElementById('btnVariationLink').addEventListener('click', (e)=>{
        e.preventDefault();
        setMode('variation');
        fetchData();
      });

      document.getElementById('refreshBtn').addEventListener('click', ()=>{
        fetchData();
      });

      fetchData();
    </script>
  </body>
</html>
