<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Clôture, Spike max & Spike min — 2024 (Binance)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8;
      --ok:#10b981; --bad:#ef4444; --text:#e5e7eb; --border:#1f2937;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:18px 16px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    main{max-width:1000px;margin:18px auto;padding:0 12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
    select,button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;text-align:right}
    th:first-child,td:first-child{text-align:left}
    .up{color:var(--ok);font-weight:600}
    .down{color:var(--bad);font-weight:600}
    .muted{color:var(--muted)}
    .row-worst{background:rgba(239,68,68,.08)}
    .row-best{background:rgba(16,185,129,.08)}
    .skeleton{height:12px;background:#0c1426;border-radius:6px;animation:pulse 1.2s infinite ease-in-out}
    @keyframes pulse{0%{opacity:.5}50%{opacity:.9}100%{opacity:.5}}
    .pill{display:inline-flex;align-items:center;gap:8px}
    .triangle-up{display:inline-block;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:10px solid var(--ok)}
    .triangle-down{display:inline-block;border-left:6px solid transparent;border-right:6px solid transparent;border-top:10px solid var(--bad)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .error{color:var(--bad);margin-top:8px}
    .summary{position:absolute;top:12px;right:12px;display:flex;gap:10px;align-items:center}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
    .badge .label{color:var(--muted);margin-right:6px}
  </style>
</head>
<body>
  <header>
    <h1>Clôture (Close vs Open) • Spike max ↑ (High vs Open) • Spike min ↓ (Low vs Open)</h1>
    <div class="sub">Par jour pour le mois sélectionné en <b>2024</b></div>
  </header>

  <main>
    <div class="controls">
      <label>
        <span class="muted">Mois (2024)</span><br>
        <select id="monthSel"></select>
      </label>
      <label>
        <span class="muted">Crypto</span><br>
        <select id="symbolSel">
          <option value="WIFUSDT">WIFUSDT</option>
          <option value="XAIUSDT">XAIUSDT</option>
          <option value="ETHFIUSDT">ETHFIUSDT</option>
          <option value="GLMUSDT">GLMUSDT</option>
          <option value="JUPUSDT">JUPUSDT</option>
          <option value="TONUSDT">TONUSDT</option>
          <option value="ONDOUSDT">ONDOUSDT</option>
          <option value="NOTUSDT">NOTUSDT</option>
          <option value="MROUSDT">MROUSDT</option>
        </select>
      </label>
      <div style="align-self:end;display:flex;gap:8px">
        <button id="loadBtn">Analyser</button>
        <span id="status" class="muted" style="align-self:center"></span>
      </div>
    </div>

    <div class="card">
      <div id="summary" class="summary">
        <span class="badge muted"><span class="label">Variation totale du mois</span><b id="monthChange">—</b></span>
      </div>

      <div class="pill" style="margin-right:170px">
        <span class="triangle-up"></span>
        <span class="muted">
          Colonnes : <b>Clôture vs Open</b> → <b>Spike max ↑</b> → <b>Spike min ↓</b>.<br>
          Vert = meilleur spike max, rouge = pire spike min.
        </span>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:140px">Date (Europe/Brussels)</th>
            <th>Clôture vs Open</th>
            <th>Spike max ↑ (High vs Open)</th>
            <th>Spike min ↓ (Low vs Open)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div id="err" class="error"></div>
      <div class="hint">Variation totale = (Close dernier jour − Open premier jour) / Open premier jour × 100.</div>
    </div>
  </main>

  <script>
    const tz = 'Europe/Brussels';
    const monthSel = document.getElementById('monthSel');
    const symbolSel = document.getElementById('symbolSel');
    const loadBtn   = document.getElementById('loadBtn');
    const statusEl  = document.getElementById('status');
    const tbody     = document.getElementById('tbody');
    const errEl     = document.getElementById('err');
    const monthChangeEl = document.getElementById('monthChange');

    function toBrusselsDate(ms){
      return new Intl.DateTimeFormat('fr-BE', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date(ms));
    }
    function monthRangeUTC(year, monthIndex){
      const start = Date.UTC(year, monthIndex, 1, 0,0,0,0);
      const end = Date.UTC(year, monthIndex+1, 1, 0,0,0,0) - 1;
      return { start, end };
    }
    const fmtPct = n => (n>=0?'+':'') + n.toFixed(4) + ' %';

    (function initMonths(){
      const names = ['01 Jan','02 Fév','03 Mar','04 Avr','05 Mai','06 Jun','07 Jul','08 Aoû','09 Sep','10 Oct','11 Nov','12 Déc'];
      names.forEach((label, i)=>{
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = label + ' 2024';
        monthSel.appendChild(opt);
      });
      const today = new Date();
      if (today.getUTCFullYear() === 2024) monthSel.value = Math.min(today.getUTCMonth(), 11);
      else monthSel.value = 0;
    })();

    loadBtn.addEventListener('click', run);
    run();

    async function run(){
      errEl.textContent = '';
      tbody.innerHTML = '';
      monthChangeEl.textContent = '—';
      monthChangeEl.className = '';

      const sym = symbolSel.value;
      const mIdx = parseInt(monthSel.value,10);
      const { start, end } = monthRangeUTC(2024, mIdx);

      statusEl.textContent = 'Chargement…';
      try{
        const url = new URL('https://api.binance.com/api/v3/klines');
        url.searchParams.set('symbol', sym);
        url.searchParams.set('interval', '1d');
        url.searchParams.set('startTime', String(start));
        url.searchParams.set('endTime', String(end));
        url.searchParams.set('limit', '1000');

        const res = await fetch(url.toString());
        if (!res.ok) throw new Error(`HTTP ${res.status} — ${await res.text()}`);
        const rows = await res.json();

        const all = rows.map(r => ({
          openTime: r[0],
          open : parseFloat(r[1]),
          high : parseFloat(r[2]),
          low  : parseFloat(r[3]),
          close: parseFloat(r[4]),
        })).filter(d => d.openTime >= start && d.openTime <= end);

        const data = all.map(d => ({
          openTime: d.openTime,
          pctClose: d.open>0 ? ((d.close - d.open)/d.open*100) : 0,
          pctUp   : d.open>0 ? ((d.high  - d.open)/d.open*100) : 0,
          pctDown : d.open>0 ? ((d.low   - d.open)/d.open*100) : 0
        }));

        let worstIdx = -1, worstVal = +Infinity;
        let bestIdx  = -1, bestVal  = -Infinity;
        data.forEach((d,i)=>{
          if (d.pctDown < worstVal){ worstVal = d.pctDown; worstIdx = i; }
          if (d.pctUp   > bestVal ){ bestVal  = d.pctUp;   bestIdx  = i; }
        });

        if (data.length === 0){
          tbody.innerHTML = `<tr><td colspan="4" class="muted">Aucune donnée pour ${sym} en ${monthSel.options[monthSel.selectedIndex].text}.</td></tr>`;
        } else {
          const firstOpen = all[0].open;
          const lastClose = all[all.length-1].close;
          const monthChange = firstOpen>0 ? ((lastClose - firstOpen)/firstOpen*100) : 0;

          monthChangeEl.textContent = fmtPct(monthChange);
          monthChangeEl.className = monthChange>=0 ? 'up' : 'down';

          data.forEach((d,i)=>{
            const tr = document.createElement('tr');
            if (i === worstIdx) tr.classList.add('row-worst');
            if (i === bestIdx)  tr.classList.add('row-best');
            tr.innerHTML = `
              <td>${toBrusselsDate(d.openTime)}</td>
              <td class="${d.pctClose>=0?'up':'down'}">${fmtPct(d.pctClose)}</td>
              <td class="up">${fmtPct(d.pctUp)}</td>
              <td class="down">${fmtPct(d.pctDown)}</td>
            `;
            tbody.appendChild(tr);
          });
        }

        statusEl.textContent = `${sym} — ${monthSel.options[monthSel.selectedIndex].text}`;
      } catch(e){
        console.error(e);
        errEl.textContent = 'Erreur: ' + e.message;
        statusEl.textContent = '';
      }
    }
  </script>
</body>
</html>