<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liquidations Binance - Version Simple</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f0f2f5;
  margin: 0;
  padding: 20px;
  color: #333;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
h1 {
  color: #2a52be;
  text-align: center;
}
.input-group {
  margin-bottom: 15px;
}
select, input, button {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border: 1px solid #ddd;
  border-radius: 5px;
}
button {
  background-color: #2a52be;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: bold;
}
button:hover {
  background-color: #1a3a9e;
}
.chart-container {
  margin-top: 20px;
  height: 300px;
}
.alert {
  padding: 10px;
  border-radius: 5px;
  margin-bottom: 10px;
}
.alert-short {
  background-color: #ffebee;
  border-left: 4px solid #f44336;
}
.alert-long {
  background-color: #e8f5e9;
  border-left: 4px solid #4caf50;
}
.loading {
  text-align: center;
  padding: 20px;
  color: #2a52be;
}
</style>
</head>
<body>
<div class="container">
  <h1>Liquidations Binance</h1>
  
  <div class="input-group">
    <label for="cryptoSelect">Choisissez une crypto :</label>
    <select id="cryptoSelect">
      <option value="">Chargement...</option>
    </select>
  </div>
  
  <div class="input-group">
    <label for="datePicker">Date pour le backtest :</label>
    <input type="date" id="datePicker">
  </div>
  
  <button id="loadBtn">Afficher les données</button>
  
  <div id="alerts"></div>
  
  <div class="chart-container">
    <canvas id="priceChart"></canvas>
  </div>
  
  <div id="priceInfo" class="loading">
    Sélectionnez une crypto et une date
  </div>
</div>

<script>
// Configuration de base
const config = {
  maxDistance: 5, // Distance maximale en %
  confidence: 4   // Seuil de confiance (1-5)
};

// Éléments de l'interface
const elements = {
  cryptoSelect: document.getElementById('cryptoSelect'),
  datePicker: document.getElementById('datePicker'),
  loadBtn: document.getElementById('loadBtn'),
  alerts: document.getElementById('alerts'),
  chart: document.getElementById('priceChart'),
  priceInfo: document.getElementById('priceInfo')
};

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  // Définir la date par défaut (hier)
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  elements.datePicker.valueAsDate = yesterday;
  
  // Charger la liste des cryptos
  loadCryptoList();
  
  // Écouteur pour le bouton
  elements.loadBtn.addEventListener('click', loadData);
});

// Charge la liste des cryptos
async function loadCryptoList() {
  try {
    const response = await axios.get('https://fapi.binance.com/fapi/v1/exchangeInfo');
    const cryptos = response.data.symbols
      .filter(s => s.contractType === 'PERPETUAL' && s.quoteAsset === 'USDT')
      .map(s => s.symbol);
    
    elements.cryptoSelect.innerHTML = 
      '<option value="">Choisissez une crypto</option>' +
      cryptos.map(c => `<option value="${c}">${c}</option>`).join('');
  } catch (error) {
    elements.priceInfo.innerHTML = `<div class="alert">Erreur de chargement : ${error.message}</div>`;
  }
}

// Charge les données principales
async function loadData() {
  const symbol = elements.cryptoSelect.value;
  const date = elements.datePicker.value;
  
  if (!symbol || !date) {
    alert("Veuillez sélectionner une crypto et une date");
    return;
  }
  
  elements.priceInfo.innerHTML = '<div class="loading">Chargement en cours...</div>';
  elements.alerts.innerHTML = '';
  
  try {
    const endTime = new Date(date).getTime();
    const startTime = endTime - (7 * 24 * 60 * 60 * 1000); // 7 jours avant
    
    const priceData = await axios.get(`https://fapi.binance.com/fapi/v1/klines`, {
      params: {
        symbol: symbol,
        interval: '1d',
        limit: 7,
        endTime: endTime
      }
    });
    
    processData(priceData.data, symbol);
  } catch (error) {
    elements.priceInfo.innerHTML = `<div class="alert">Erreur : ${error.message}</div>`;
  }
}

// Traite les données reçues
function processData(data, symbol) {
  const prices = data.map(d => ({
    time: new Date(d[0]),
    open: +d[1],
    high: +d[2],
    low: +d[3],
    close: +d[4]
  }));
  
  const lastPrice = prices[prices.length - 1].close;
  
  // Calcul simplifié des zones de liquidation
  const highs = prices.map(p => p.high);
  const lows = prices.map(p => p.low);
  
  const liquidationShort = Math.max(...highs) * 0.98;
  const liquidationLong = Math.min(...lows) * 1.02;
  
  const distanceShort = ((liquidationShort - lastPrice) / lastPrice * 100).toFixed(2);
  const distanceLong = ((lastPrice - liquidationLong) / lastPrice * 100).toFixed(2);
  
  // Affichage des alertes
  if (Math.abs(distanceShort) <= config.maxDistance) {
    elements.alerts.innerHTML += `
      <div class="alert alert-short">
        <strong>Liquidation Short</strong><br>
        Prix: ${liquidationShort.toFixed(4)}<br>
        Distance: +${distanceShort}%
      </div>
    `;
  }
  
  if (Math.abs(distanceLong) <= config.maxDistance) {
    elements.alerts.innerHTML += `
      <div class="alert alert-long">
        <strong>Liquidation Long</strong><br>
        Prix: ${liquidationLong.toFixed(4)}<br>
        Distance: -${distanceLong}%
      </div>
    `;
  }
  
  // Mise à jour du graphique
  updateChart(symbol, prices, {
    short: liquidationShort,
    long: liquidationLong
  });
  
  // Affichage des infos
  elements.priceInfo.innerHTML = `
    <strong>${symbol}</strong><br>
    Dernier prix: ${lastPrice.toFixed(4)}<br>
    Date: ${prices[prices.length - 1].time.toLocaleDateString()}
  `;
}

// Met à jour le graphique
function updateChart(symbol, data, zones) {
  const ctx = elements.chart.getContext('2d');
  
  if (window.priceChart) {
    window.priceChart.destroy();
  }
  
  window.priceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.time.toLocaleDateString()),
      datasets: [{
        label: `${symbol} Prix`,
        data: data.map(d => d.close),
        borderColor: '#2a52be',
        tension: 0.1,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        annotation: {
          annotations: {
            shortLine: {
              type: 'line',
              yMin: zones.short,
              yMax: zones.short,
              borderColor: '#f44336',
              borderWidth: 2,
              borderDash: [5, 5],
              label: {
                content: `Short: ${zones.short.toFixed(4)}`,
                display: true
              }
            },
            longLine: {
              type: 'line',
              yMin: zones.long,
              yMax: zones.long,
              borderColor: '#4caf50',
              borderWidth: 2,
              borderDash: [5, 5],
              label: {
                content: `Long: ${zones.long.toFixed(4)}`,
                display: true
              }
            }
          }
        }
      }
    }
  });
}
</script>
</body>
</html>