<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Variation 1m — 23h (Europe/Brussels) — 2024 vs 2025 + minutes communes négatives</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --up:#16a34a; --down:#dc2626; --zero:#64748b; --border:#1f2937; --header:#0b1220; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b1020;color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;padding:24px}
    header{max-width:1200px;margin:0 auto 16px;display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
    header h1{margin:0;font-size:20px;font-weight:700}
    .meta{color:var(--muted);font-size:14px}
    .controls{margin-left:auto}
    .controls button{background:var(--accent);border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

    /* Sections côte à côte */
    #sections{display:flex;gap:20px;flex-wrap:wrap;max-width:1200px;margin:0 auto}

    .section{flex:1;min-width:450px;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px}
    .section h2{margin:0 0 6px 0;font-size:16px;font-weight:700;color:#e2e8f0}
    .section .sub{color:var(--muted);font-size:12px;margin-bottom:12px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card header{background:var(--header);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;gap:10px;align-items:center}
    .symbol{font-weight:700;letter-spacing:.3px}
    .status{margin-left:auto;font-size:12px;color:var(--muted)}
    .table-wrap{max-height:70vh;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;font-variant-numeric:tabular-nums}
    thead th{position:sticky;top:0;background:var(--header);border-bottom:1px solid var(--border);padding:6px 8px;font-size:12px;color:var(--muted);text-align:left}
    tbody td, tbody th{border-bottom:1px solid rgba(255,255,255,.06);padding:6px 8px;font-size:12px}
    tbody td.time{color:var(--muted)}
    .pct{font-weight:600;text-align:right}
    .up{color:var(--up)} .down{color:var(--down)} .zero{color:var(--zero)}
    .loading,.error{padding:10px 12px;border-top:1px solid var(--border);font-size:13px;color:var(--muted)}
    .error{color:#fca5a5}

    /* UNIQUE card de comparaison */
    .compare-wrap{max-width:1200px;margin:20px auto 0}
    .compare-card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .compare-card header{background:var(--header);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;gap:10px;align-items:center}
    .compare-card h3{margin:0;font-size:15px}
    .compare-body{padding:12px}
    .minutes{font-size:13px;line-height:1.6}
    .none{color:var(--muted)}
    footer.small{max-width:1200px;margin:18px auto 0;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>Variation 1m — Heure 23h (Europe/Brussels)</h1>
    <div class="meta">Plage : <strong>23:00 → 23:59</strong> • Timeframe : <strong>1m</strong></div>
    <div class="controls"><button id="reload">Recharger</button></div>
  </header>

    <!-- UNE SEULE card de comparaison -->
  <div class="compare-wrap">
    <div class="compare-card">
      <header><h3>Minutes négatives en commun — 2024 & 2025 (même minute)</h3></header>
      <div class="compare-body">
        <div id="compareStatus" class="minutes">Analyse en cours…</div>
      </div>
    </div>
  </div>
  

  <!-- 2 tableaux côte à côte -->
  <div id="sections"></div>



  <footer class="small">
    Deux tableaux : 2024 (gauche) et 2025 (droite). La carte liste les minutes où les deux années sont négatives simultanément (pour tous les symboles affichés).
  </footer>

<script>
(async () => {
  // ====== Paramètres ======
  const symbols = ["AEVOUSDT"];  // Tu peux en ajouter; la comparaison exigera que TOUS soient négatifs sur les 2 années
  const timeZone = "Europe/Brussels";
  const interval = "1m";

  // Ordre inversé demandé : 2024 d'abord, 2025 ensuite
  const sessions = [
    { id: "s2024", y: 2024, m: 10, d: 10, label: "10/10/2024" },
    { id: "s2025", y: 2025, m: 10, d: 10, label: "10/10/2025" }
  ];

  // ====== Utils fuseau ======
  function localToUtcMs(y,m,d,hh,mm,ss,ms,tz){
    const approxUtc = Date.UTC(y,m-1,d,hh,mm,ss,ms);
    const offset = tzOffsetMsAt(new Date(approxUtc), tz);
    return approxUtc - offset;
  }
  function tzOffsetMsAt(date, tz){
    const dtf = new Intl.DateTimeFormat('en-GB',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    const parts = dtf.formatToParts(date);
    const map = {};
    for(const p of parts) map[p.type]=p.value;
    const asUTC = Date.UTC(+map.year, +map.month-1, +map.day, +map.hour, +map.minute, +map.second);
    return asUTC - date.getTime();
  }

  // ====== UI ======
  const sectionsRoot = document.getElementById('sections');
  function buildSection(session){
    const sec = document.createElement('div'); sec.className='section';
    const h2 = document.createElement('h2'); h2.textContent = `Date : ${session.label}`;
    const sub = document.createElement('div'); sub.className='sub'; sub.textContent = 'Plage : 23:00 → 23:59 • Timeframe : 1m';
    const grid = document.createElement('div'); grid.className='grid';
    sec.appendChild(h2); sec.appendChild(sub); sec.appendChild(grid);
    sectionsRoot.appendChild(sec);
    return { gridEl: grid };
  }

  function buildCard(gridEl, symbol){
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('header');
    const symEl = document.createElement('div'); symEl.className='symbol'; symEl.textContent = symbol;
    const status = document.createElement('div'); status.className='status'; status.textContent='Chargement…';
    head.appendChild(symEl); head.appendChild(status);

    const wrap = document.createElement('div'); wrap.className='table-wrap';
    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr><th>Heure (Brussels)</th><th style="text-align:right">Variation (1m)</th></tr></thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');

    // 60 lignes vides
    for(let i=0;i<60;i++){
      const tr=document.createElement('tr');
      const t=document.createElement('td'); t.className='time'; t.textContent=`23:${String(i).padStart(2,'0')}`;
      const v=document.createElement('td'); v.className='pct zero'; v.textContent='—';
      tr.appendChild(t); tr.appendChild(v); tbody.appendChild(tr);
    }

    wrap.appendChild(table);
    const loading = document.createElement('div'); loading.className='loading'; loading.textContent='Requête klines 1m…';

    card.appendChild(head); card.appendChild(wrap); card.appendChild(loading);
    gridEl.appendChild(card);

    return { statusEl: status, loadingEl: loading, tbody };
  }

  // ====== Data helpers ======
  function pctChange(o,c){ o=+o; c=+c; if(!isFinite(o)||o===0||!isFinite(c)) return null; return ((c-o)/o)*100; }
  function minuteIndexIn23h(openTimeMs){
    const dt = new Date(openTimeMs);
    const fmt = new Intl.DateTimeFormat('fr-BE',{ timeZone, hour:'2-digit', minute:'2-digit', hour12:false });
    const [h,m] = fmt.format(dt).split(':'); return +h===23 ? +m : -1;
  }

  async function fetchKlines(symbol,start,end){
    const url=new URL('https://api.binance.com/api/v3/klines');
    url.searchParams.set('symbol',symbol);
    url.searchParams.set('interval',interval);
    url.searchParams.set('startTime',start);
    url.searchParams.set('endTime',end);
    url.searchParams.set('limit','1000');
    const res = await fetch(url);
    if(!res.ok){const txt=await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status} ${res.statusText} — ${txt}`);}
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error('Réponse inattendue de Binance.');
    return data;
  }

  // ====== État par session ======
  const sessionViews = sessions.map(s=>{
    const start = localToUtcMs(s.y, s.m, s.d, 23, 0, 0, 0, timeZone);
    const end   = localToUtcMs(s.y, s.m, s.d, 23, 59, 59, 999, timeZone);
    const { gridEl } = buildSection(s);
    const state = {
      negBySymbol: new Map(),   // symbol -> Array(60) true/false/undefined
      hasBySymbol: new Map(),   // symbol -> Array(60) true/false
      cards: []
    };
    for(const sym of symbols){
      state.negBySymbol.set(sym, Array(60).fill(undefined));
      state.hasBySymbol.set(sym, Array(60).fill(false));
    }
    return { ...s, start, end, gridEl, state };
  });

  function renderHour23(tbody, klines, symbol, state){
    const negArr = state.negBySymbol.get(symbol);
    const hasArr = state.hasBySymbol.get(symbol);
    let count=0;
    for(const k of klines){
      const idx = minuteIndexIn23h(k[0]);
      if(idx>=0 && idx<60){
        const p = pctChange(k[1], k[4]);
        const row = tbody.children[idx]; const cell = row.children[1];
        if(p===null){ cell.textContent='n/a'; cell.className='pct zero'; negArr[idx]=undefined; hasArr[idx]=false; }
        else { cell.textContent=(p>=0?'+':'')+p.toFixed(3)+'%'; cell.className='pct '+(p>0?'up':(p<0?'down':'zero')); negArr[idx]=(p<0); hasArr[idx]=true; }
        count++;
      }
    }
    return count;
  }

  const compareStatus = document.getElementById('compareStatus');

  function updateCommonNegativeCard(){
    if(sessionViews.length<2){ compareStatus.textContent='Comparaison indisponible.'; return; }
    const [s2024, s2025] = sessionViews;

    const minutesCommon = [];
    for(let m=0;m<60;m++){
      let okForAllSymbols = true;
      for(const sym of symbols){
        const hasA = s2024.state.hasBySymbol.get(sym)[m];
        const hasB = s2025.state.hasBySymbol.get(sym)[m];
        const negA = s2024.state.negBySymbol.get(sym)[m];
        const negB = s2025.state.negBySymbol.get(sym)[m];
        if(!hasA || !hasB || negA!==true || negB!==true){ okForAllSymbols = false; break; }
      }
      if(okForAllSymbols) minutesCommon.push(m);
    }

    if(minutesCommon.length===0){
      compareStatus.innerHTML = `<span class="none">Aucune minute commune négative entre 23:00 et 23:59.</span>`;
    }else{
      const times = minutesCommon.map(m=>`23:${String(m).padStart(2,'0')}`).join(', ');
      compareStatus.innerHTML = `Minutes communes négatives : <strong>${times}</strong>`;
    }
  }

  // Construire les cartes des deux tableaux
  for(const sess of sessionViews){
    for(const sym of symbols){
      const card = buildCard(sess.gridEl, sym);
      sess.state.cards.push({ symbol: sym, ...card });
    }
  }

  async function loadAll(){
    // Charger chaque session
    await Promise.all(sessionViews.map(async (sess)=>{
      await Promise.all(sess.state.cards.map(async (c)=>{
        c.statusEl.textContent='Chargement…'; c.loadingEl.className='loading'; c.loadingEl.textContent='Requête klines 1m…';
        try{
          const kl = await fetchKlines(c.symbol, sess.start, sess.end);
          const count = renderHour23(c.tbody, kl, c.symbol, sess.state);
          c.statusEl.textContent = `OK • ${count}/60`;
          c.loadingEl.textContent = (count<60) ? `Données manquantes (${count}/60).` : 'Terminé.';
          if(count<60) c.loadingEl.className='error';
        }catch(e){
          c.statusEl.textContent='Erreur';
          c.loadingEl.className='error';
          c.loadingEl.textContent='Échec: '+(e?.message||e);
          // sécuriser pour la comparaison
          sess.state.negBySymbol.forEach((_,sym)=>sess.state.negBySymbol.set(sym, Array(60).fill(undefined)));
          sess.state.hasBySymbol.forEach((_,sym)=>sess.state.hasBySymbol.set(sym, Array(60).fill(false)));
        }
      }));
    }));

    // Une fois les deux tableaux chargés, on met à jour la card unique
    updateCommonNegativeCard();
  }

  loadAll();
  document.getElementById('reload').addEventListener('click', loadAll);
})();
</script>
</body>
</html>
