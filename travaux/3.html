<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Binance Order Book — Détection Sell Walls x10</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111c33; --text:#e5e7eb; --muted:#93a4bf;
      --border:#1f2b46; --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --shadow:0 12px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,#0b1220,#0a1020 35%,#070b14);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:18px}
    .wrap{max-width:1150px;margin:0 auto}
    header{display:flex;gap:12px;flex-wrap:wrap;align-items:end;justify-content:space-between;margin-bottom:14px}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .panel{background:rgba(17,28,51,.7);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select,button{
      background:#0b1220;border:1px solid var(--border);color:var(--text);
      border-radius:10px;padding:10px 12px;font-size:13px;outline:none
    }
    input{width:170px}
    select{width:150px}
    button{cursor:pointer;background:linear-gradient(135deg,#1d4ed8,#2563eb);border:0}
    button:active{transform:translateY(1px)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:12px;margin-top:12px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} input,select{width:100%} }
    .card{background:rgba(15,23,42,.6);border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(11,18,32,.75)}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:16px;margin-top:3px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(31,43,70,.7);text-align:right}
    th{text-align:right;color:var(--muted);font-weight:600;font-size:12px}
    td:first-child,th:first-child{text-align:left}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .pill.red{color:#fecaca;background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
    .pill.blue{color:#bfdbfe;background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.35)}
    .muted{color:var(--muted)}
    .ok{color:var(--green)}
    .bad{color:var(--red)}
    .log{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;color:#cbd5e1;background:rgba(11,18,32,.6);border:1px solid var(--border);
      border-radius:12px;padding:10px;max-height:180px;overflow:auto}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Détection de murs de vente (asks) — x10</h1>
      <div class="sub">Source: Binance Depth API • Valeur = prix × quantité (USDT) • Baseline = médiane des asks</div>
    </div>

    <div class="controls panel">
      <div>
        <label>Symbol</label><br>
        <input id="symbol" value="CYSUSDT" />
      </div>
      <div>
        <label>Depth limit</label><br>
        <select id="limit">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
          <option value="500">500</option>
          <option value="1000">1000</option>
        </select>
      </div>
      <div>
        <label>Seuil</label><br>
        <select id="mult">
          <option value="5">x5</option>
          <option value="10" selected>x10</option>
          <option value="15">x15</option>
          <option value="20">x20</option>
        </select>
      </div>
      <div>
        <label>Refresh</label><br>
        <select id="refresh">
          <option value="0">manuel</option>
          <option value="1000">1s</option>
          <option value="2000" selected>2s</option>
          <option value="5000">5s</option>
        </select>
      </div>
      <div style="align-self:flex-end">
        <button id="run">Scanner</button>
      </div>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="t">Prix (mid)</div>
          <div class="v" id="mid">—</div>
        </div>
        <div class="kpi">
          <div class="t">Médiane asks (USDT)</div>
          <div class="v" id="median">—</div>
        </div>
        <div class="kpi">
          <div class="t">Seuil (médiane × N)</div>
          <div class="v" id="threshold">—</div>
        </div>
        <div class="kpi">
          <div class="t">Gros asks détectés</div>
          <div class="v" id="count">—</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Niveau ask</th>
            <th>Prix</th>
            <th>Quantité</th>
            <th>Valeur (USDT)</th>
            <th>Ratio</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" class="muted" style="text-align:left;padding:12px">Clique “Scanner”.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <span class="pill blue">Notes</span>
          <div class="sub" style="margin-top:6px">
            • “Ratio” = valeur_ask / médiane<br>
            • Si un mur “fuit” (disparaît) d’un refresh à l’autre ⇒ suspect “fake wall”
          </div>
        </div>
        <div class="pill red">Asks = Ventes</div>
      </div>

      <div style="margin-top:12px">
        <div class="sub">Logs</div>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function fmt(n, d=2){
    if (!isFinite(n)) return '—';
    return n.toLocaleString('fr-FR', { minimumFractionDigits:d, maximumFractionDigits:d });
  }
  function fmtK(n){
    if (!isFinite(n)) return '—';
    const abs = Math.abs(n);
    if (abs >= 1e9) return (n/1e9).toFixed(3) + 'B';
    if (abs >= 1e6) return (n/1e6).toFixed(3) + 'M';
    if (abs >= 1e3) return (n/1e3).toFixed(3) + 'K';
    return n.toFixed(2);
  }
  function median(arr){
    const a = arr.slice().sort((x,y)=>x-y);
    const m = Math.floor(a.length/2);
    if (a.length === 0) return NaN;
    return a.length % 2 ? a[m] : (a[m-1] + a[m]) / 2;
  }

  let timer = null;
  let prevWalls = new Map(); // price -> valueUSDT (pour repérer disparition)

  async function fetchDepth(symbol, limit){
    const url = `https://fapi.binance.com/fapi/v1/depth?symbol=${encodeURIComponent(symbol)}&limit=${limit}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  function logLine(msg){
    const el = $('log');
    const now = new Date();
    const t = now.toLocaleTimeString('fr-FR');
    el.textContent = `[${t}] ${msg}\n` + el.textContent;
  }

  function setRows(walls, med){
    const tb = $('rows');
    if (!walls.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted" style="text-align:left;padding:12px">Aucun mur détecté avec ce seuil.</td></tr>`;
      return;
    }
    tb.innerHTML = walls.map((w,i)=>`
      <tr>
        <td style="text-align:left">
          <span class="pill red">ASK #${i+1}</span>
        </td>
        <td>${fmt(w.price, 6)}</td>
        <td>${fmt(w.qty, 2)}</td>
        <td>${fmtK(w.value)}</td>
        <td class="${w.ratio >= 10 ? 'bad' : 'ok'}">${fmt(w.ratio, 2)}x</td>
      </tr>
    `).join('');
  }

  async function scan(){
    const symbol = $('symbol').value.trim().toUpperCase();
    const limit = Number($('limit').value);
    const mult = Number($('mult').value);

    try{
      const data = await fetchDepth(symbol, limit);

      const bids = data.bids?.map(([p,q]) => ({ p:+p, q:+q })) ?? [];
      const asks = data.asks?.map(([p,q]) => ({ p:+p, q:+q })) ?? [];
      if (!bids.length || !asks.length) throw new Error('Carnet vide');

      const bestBid = bids[0].p;
      const bestAsk = asks[0].p;
      const mid = (bestBid + bestAsk) / 2;

      // Valeur USDT par niveau ask
      const askValues = asks.map(a => a.p * a.q).filter(v => isFinite(v) && v > 0);

      // Médiane (baseline “normale”)
      const med = median(askValues);
      const thr = med * mult;

      // Walls = asks >= threshold
      const walls = asks
        .map(a => ({ price:a.p, qty:a.q, value:a.p*a.q }))
        .filter(x => x.value >= thr)
        .sort((a,b)=>b.value-a.value)
        .map(x => ({ ...x, ratio: x.value / med }));

      $('mid').textContent = fmt(mid, 6);
      $('median').textContent = fmtK(med);
      $('threshold').textContent = fmtK(thr) + ` (${mult}x)`;
      $('count').textContent = String(walls.length);

      // Détection “fuite” : murs présents avant mais plus maintenant
      const nowWalls = new Map(walls.map(w => [w.price, w.value]));
      let disappeared = 0;
      for (const [p, v] of prevWalls.entries()){
        if (!nowWalls.has(p)) disappeared++;
      }
      if (prevWalls.size > 0){
        if (disappeared > 0) logLine(`⚠️ ${disappeared} mur(s) ont disparu depuis le scan précédent (suspect fake wall).`);
        else logLine(`OK: murs stables (aucune disparition depuis le scan précédent).`);
      } else {
        logLine(`Scan initial sur ${symbol} (limit ${limit}, seuil x${mult}).`);
      }
      prevWalls = nowWalls;

      setRows(walls, med);
    } catch(e){
      logLine(`Erreur: ${e.message}`);
      $('rows').innerHTML = `<tr><td colspan="5" class="muted" style="text-align:left;padding:12px">Erreur: ${e.message}</td></tr>`;
      $('mid').textContent = $('median').textContent = $('threshold').textContent = $('count').textContent = '—';
    }
  }

  function applyRefresh(){
    const ms = Number($('refresh').value);
    if (timer) clearInterval(timer);
    timer = null;
    if (ms > 0){
      timer = setInterval(scan, ms);
      logLine(`Auto-refresh activé: toutes les ${ms/1000}s`);
    } else {
      logLine(`Auto-refresh désactivé (manuel).`);
    }
  }

  $('run').addEventListener('click', scan);
  $('refresh').addEventListener('change', applyRefresh);

  // petit confort : entrer = scanner
  $('symbol').addEventListener('keydown', (e)=>{ if(e.key==='Enter') scan(); });

  applyRefresh();
</script>
</body>
</html>
