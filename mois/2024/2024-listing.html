<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Listings 2024 (Futures USDT) – Variation mensuelle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f1a;
      --card:#11182a;
      --muted:#6b7280;
      --text:#e5e7eb;
      --accent:#3b82f6;
      --pos:#16a34a22;
      --neg:#dc262622;
      --neu:#37415166;
      --ring:#3b82f688;
      --border:#1f2937;
    }

    *{box-sizing:border-box}

    /* ✅ plus aucune scrollbar de page */
    html,body{
      margin:0;padding:0;
      height:100%;
      overflow:hidden;
      background:linear-gradient(180deg,#0b0f1a,#0a1020 30%,#0b0f1a);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }

    .wrap{
      max-width:1300px;
      margin:0 auto;
      height:100vh;
      padding:18px 16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    header{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      font-size:20px;
      font-weight:700;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
      white-space:nowrap;
    }
    .badge{
      font-size:12px;
      background:#1f2937;
      color:#cbd5e1;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #334155;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .input,.btn,select{
      border:1px solid var(--border);
      background:#0f172a;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    .input{min-width:240px}
    select{min-width:170px}

    .btn{
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease;
      border-color:#23304b;
      user-select:none;
    }
    .btn:hover{box-shadow:0 0 0 3px var(--ring)}
    .btn:active{transform:translateY(1px)}

    .card{
      background:linear-gradient(180deg,#0e1527, #0c1223);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 30px #0006;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0; /* important pour flex */
    }

    .card-head{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      border:1px solid #27324b;
      background:#0f172a;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:#cbd5e1;
      white-space:nowrap;
    }

    .progress{
      height:6px;
      background:#111827;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      width:240px;
    }
    .progress>div{
      height:100%;
      background:linear-gradient(90deg,#3b82f6,#06b6d4);
      width:0%;
    }

    /* ✅ pas de scroll interne */
    .table-wrap{
      padding:8px 10px 10px;
      min-height:0;
      overflow:visible;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .table-shell{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden; /* pas de scroll, juste clip */
      background:#0a1221;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed; /* ✅ empêche le dépassement horizontal */
      font-size:12.5px;
    }

    thead th{
      background:#0c1325;
      border-bottom:1px solid var(--border);
      padding:10px 8px;
      font-weight:700;
      text-align:left;
      white-space:nowrap;
    }

    tbody td{
      border-bottom:1px solid #111827;
      padding:7px 8px;
      vertical-align:middle;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis; /* ✅ pas de dépassement -> pas de scroll horizontal */
    }

    tbody tr:nth-child(2n){background:#0b1326}
    tbody tr:hover{background:#0b1530}

    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .sym{display:flex;align-items:center;gap:8px;min-width:0}
    .pill{
      font-size:11px;
      border:1px solid #263149;
      background:#0d152b;
      color:#cbd5e1;
      padding:2px 6px;
      border-radius:7px;
      flex:0 0 auto;
    }

    .pct{
      padding:4px 7px;
      border-radius:9px;
      display:inline-block;
      text-align:right;
      min-width:66px;
      font-variant-numeric:tabular-nums;
    }
    .pct.pos{background:var(--pos);border:1px solid #14532d;color:#a7f3d0}
    .pct.neg{background:var(--neg);border:1px solid #7f1d1d;color:#fecaca}
    .pct.neu{background:var(--neu);border:1px solid #374151;color:#e5e7eb}
    .muted{color:var(--muted)}

    .footer{
      padding:8px 12px;
      font-size:12px;
      color:#93a0b2;
      background:#0c1325;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .pager{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pager .btn{padding:8px 10px;border-radius:10px}
    .pager .chip{padding:6px 10px}

    /* Carte des cryptos listées ce mois */
    .month-card{
      display:none;
      background:linear-gradient(180deg,#0e1527, #0c1223);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 30px #0006;
      overflow:hidden;
    }
    .month-card.active{display:block}
    .month-card-head{padding:12px 14px;border-bottom:1px solid var(--border)}
    .month-symbols{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));
      gap:8px;
      padding:12px 14px;
    }
    .month-symbol{
      background:#0f172a;
      border:1px solid #27324b;
      border-radius:8px;
      padding:8px;
      text-align:center;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    /* Colonnes compactes */
    th.col-id{width:110px}
    th.col-sym{width:135px}
    th.col-date{width:105px}
    th.col-m{width:72px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Listings 2024 — Futures <span class="badge">USDT</span></div>

      <div class="toolbar">
        <input id="search" class="input" placeholder="Rechercher (ID ou symbole)..." />
        <select id="month-select">
          <option value="-1">Filtre Mois</option>
          <option value="0">Janvier</option>
          <option value="1">Février</option>
          <option value="2">Mars</option>
          <option value="3">Avril</option>
          <option value="4">Mai</option>
          <option value="5">Juin</option>
          <option value="6">Juillet</option>
          <option value="7">Août</option>
          <option value="8">Septembre</option>
          <option value="9">Octobre</option>
          <option value="10">Novembre</option>
          <option value="11">Décembre</option>
        </select>
        <button id="refresh" class="btn">Rafraîchir</button>
        <label class="btn" style="display:flex;gap:8px;align-items:center;cursor:pointer;">
          <input id="auto" type="checkbox" style="accent-color:#3b82f6"> Auto-refresh (10 min)
        </label>
      </div>
    </header>

    <div id="month-card" class="month-card">
      <div class="month-card-head">
        <div class="stats">
          <div class="chip">Nouveautés <span id="month-name">—</span> <span id="month-year">2024</span></div>
          <div class="chip"><span id="month-count">0</span> listées</div>
        </div>
      </div>
      <div class="month-symbols" id="month-symbols"></div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="stats">
          <div class="chip">Période: Jan 2024 → Déc 2024 (1M)</div>
          <div class="chip">Source: Binance Futures</div>
          <div class="chip"><span id="count">0</span> listées en 2024</div>
        </div>
        <div class="progress"><div id="bar"></div></div>
      </div>

      <div class="table-wrap">
        <div class="table-shell">
          <table>
            <thead>
              <tr>
                <th class="col-id">ID</th>
                <th class="col-sym">Symbole</th>
                <th class="col-date">Listé le</th>
                <th class="col-m">Jan</th><th class="col-m">Fév</th><th class="col-m">Mar</th><th class="col-m">Avr</th><th class="col-m">Mai</th><th class="col-m">Juin</th>
                <th class="col-m">Juil</th><th class="col-m">Août</th><th class="col-m">Sep</th><th class="col-m">Oct</th><th class="col-m">Nov</th><th class="col-m">Déc</th>
              </tr>
            </thead>
            <tbody id="body">
              <tr><td colspan="15" class="muted" style="text-align:center;padding:18px">Chargement…</td></tr>
            </tbody>
          </table>

          <div class="footer">
            <div class="muted">Conseil : clic sur « Rafraîchir » pour recharger. Table triée par ID.</div>

            <div class="pager">
              <button id="prev" class="btn">◀</button>
              <button id="next" class="btn">▶</button>
              <span class="chip">Page <span id="page">1</span>/<span id="pages">1</span></span>
              <span class="chip"><span id="range">0–0</span> / <span id="totalView">0</span></span>
              <select id="pageSize">
                <option value="12">12 lignes</option>
                <option value="18" selected>18 lignes</option>
                <option value="24">24 lignes</option>
                <option value="36">36 lignes</option>
              </select>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  const API = "https://fapi.binance.com";
  const YEAR = 2024;

  const startYear = Date.UTC(2024,0,1);
  const startNext = Date.UTC(2025,0,1);

  const monthsFR = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];

  const $body = document.getElementById('body');
  const $count = document.getElementById('count');
  const $bar = document.getElementById('bar');
  const $search = document.getElementById('search');
  const $refresh = document.getElementById('refresh');
  const $auto = document.getElementById('auto');
  const $monthSelect = document.getElementById('month-select');

  const $monthCard = document.getElementById('month-card');
  const $monthName = document.getElementById('month-name');
  const $monthYear = document.getElementById('month-year');
  const $monthCount = document.getElementById('month-count');
  const $monthSymbols = document.getElementById('month-symbols');

  const $prev = document.getElementById('prev');
  const $next = document.getElementById('next');
  const $page = document.getElementById('page');
  const $pages = document.getElementById('pages');
  const $range = document.getElementById('range');
  const $totalView = document.getElementById('totalView');
  const $pageSize = document.getElementById('pageSize');

  let masterRows = [];
  let timer = null;

  let curPage = 1;
  let perPage = parseInt($pageSize.value, 10);

  function fmtDateUTC(ts){
    const d = new Date(ts);
    return d.getUTCFullYear()+"-"+String(d.getUTCMonth()+1).padStart(2,'0')+"-"+String(d.getUTCDate()).padStart(2,'0');
  }
  function clsPct(v){
    if (v === null) return "pct neu";
    if (v > 0) return "pct pos";
    if (v < 0) return "pct neg";
    return "pct neu";
  }
  function pctTxt(v){
    return v === null ? "—" : (v>0?"+":"") + v.toFixed(2) + "%";
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function jget(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return r.json();
  }

  async function fetchUSDTListingsYear(){
    const ex = await jget(API + "/fapi/v1/exchangeInfo");
    const usdtFutures = ex.symbols.filter(s =>
      s.status === "TRADING" &&
      s.contractType === "PERPETUAL" &&
      s.quoteAsset === "USDT" &&
      s.symbol.endsWith("USDT")
    );

    const BATCH = 10;
    const kept = [];
    let done = 0;

    for (let i=0; i<usdtFutures.length; i+=BATCH){
      const slice = usdtFutures.slice(i,i+BATCH);
      await Promise.all(slice.map(async s => {
        try{
          const earliest = await jget(API + `/fapi/v1/klines?symbol=${s.symbol}&interval=1M&startTime=0&limit=1`);
          if (!earliest || earliest.length===0) return;
          const firstOpen = earliest[0][0];
          if (firstOpen >= startYear && firstOpen < startNext){
            kept.push({ id:s.baseAsset, symbol:s.symbol, listedAt:firstOpen });
          }
        }catch(e){
          // ignore
        }finally{
          done++;
        }
      }));

      $bar.style.width = Math.min(50, Math.round((done/usdtFutures.length)*50)) + "%";
      await sleep(120);
    }

    kept.sort((a,b)=> a.id.localeCompare(b.id));
    return kept;
  }

  async function fetchMonthlyPctForSymbol(symbol){
    const ks = await jget(API + `/fapi/v1/klines?symbol=${symbol}&interval=1M&startTime=${startYear}&endTime=${startNext}`);
    const arr = Array(12).fill(null);

    for (const k of ks){
      const openTime = k[0];
      const d = new Date(openTime);
      if (d.getUTCFullYear() !== YEAR) continue;

      const m = d.getUTCMonth();
      const open = parseFloat(k[1]);
      const close = parseFloat(k[4]);
      if (isFinite(open) && open>0 && isFinite(close)){
        arr[m] = ((close - open) / open) * 100;
      }
    }
    return arr;
  }

  function getFilteredRows(rows){
    const q = $search.value.trim().toUpperCase();
    return q ? rows.filter(r => r.id.includes(q) || r.symbol.includes(q)) : rows;
  }

  function clampPage(totalPages){
    if (totalPages < 1) totalPages = 1;
    if (curPage > totalPages) curPage = totalPages;
    if (curPage < 1) curPage = 1;
  }

  function renderTable(){
    const filtered = getFilteredRows(masterRows);
    const total = filtered.length;

    const totalPages = Math.max(1, Math.ceil(total / perPage));
    clampPage(totalPages);

    const start = (curPage - 1) * perPage;
    const end = Math.min(start + perPage, total);
    const pageRows = filtered.slice(start, end);

    $count.textContent = masterRows.length.toString();
    $page.textContent = String(curPage);
    $pages.textContent = String(totalPages);
    $totalView.textContent = String(total);
    $range.textContent = total === 0 ? "0–0" : `${start+1}–${end}`;

    $prev.disabled = (curPage === 1);
    $next.disabled = (curPage === totalPages);
    $prev.style.opacity = $prev.disabled ? 0.5 : 1;
    $next.style.opacity = $next.disabled ? 0.5 : 1;

    if (pageRows.length === 0){
      $body.innerHTML = `<tr><td colspan="15" class="muted" style="text-align:center;padding:18px">Aucun résultat</td></tr>`;
      return;
    }

    $body.innerHTML = pageRows.map(r => `
      <tr>
        <td class="mono">
          <div class="sym">
            <span style="min-width:0;overflow:hidden;text-overflow:ellipsis">${r.id}</span>
            <span class="pill">USDT</span>
          </div>
        </td>
        <td class="mono">${r.symbol}</td>
        <td class="mono muted">${fmtDateUTC(r.listedAt)}</td>
        ${r.pcts.map(v => `<td><span class="${clsPct(v)}">${pctTxt(v)}</span></td>`).join("")}
      </tr>
    `).join("");
  }

  function filterByMonth(month){
    if (month === -1){
      $monthCard.classList.remove("active");
      return;
    }
    const monthListed = masterRows.filter(r => {
      const d = new Date(r.listedAt);
      return d.getUTCFullYear() === YEAR && d.getUTCMonth() === month;
    });
    $monthName.textContent = monthsFR[month];
    $monthYear.textContent = YEAR;
    $monthCount.textContent = monthListed.length;
    $monthSymbols.innerHTML = monthListed.map(r => `<div class="month-symbol">${r.symbol}</div>`).join("");
    $monthCard.classList.add("active");
  }

  async function loadAll(){
    masterRows = [];
    curPage = 1;
    $bar.style.width = "0%";
    $body.innerHTML = `<tr><td colspan="15" class="muted" style="text-align:center;padding:18px">Chargement…</td></tr>`;

    try{
      const listed = await fetchUSDTListingsYear();

      const BATCH = 10;
      let done = 0;
      const rows = [];

      for (let i=0;i<listed.length;i+=BATCH){
        const slice = listed.slice(i,i+BATCH);
        const partial = await Promise.all(slice.map(async it => {
          try{
            const pcts = await fetchMonthlyPctForSymbol(it.symbol);
            return {...it, pcts};
          }catch(e){
            return {...it, pcts: Array(12).fill(null)};
          }finally{
            done++;
          }
        }));

        rows.push(...partial);
        masterRows = rows.sort((a,b)=> a.id.localeCompare(b.id));

        const progress = 50 + Math.round((done/listed.length)*50);
        $bar.style.width = progress + "%";
        renderTable();
        await sleep(80);
      }

      $bar.style.width = "100%";
      renderTable();

      const m = parseInt($monthSelect.value, 10);
      if (!isNaN(m) && m !== -1) filterByMonth(m);

    }catch(e){
      $body.innerHTML = `<tr><td colspan="15" style="color:#fecaca;background:#7f1d1d22;border:1px solid #7f1d1d;padding:14px">
        Erreur de chargement. Clic sur « Rafraîchir ».
      </td></tr>`;
    }
  }

  $refresh.addEventListener('click', loadAll);
  $search.addEventListener('input', () => { curPage = 1; renderTable(); });

  $auto.addEventListener('change', () => {
    if ($auto.checked){
      timer = setInterval(loadAll, 10*60*1000);
    } else {
      clearInterval(timer); timer = null;
    }
  });

  $monthSelect.addEventListener('change', () => filterByMonth(parseInt($monthSelect.value, 10)));

  $prev.addEventListener('click', () => { curPage--; renderTable(); });
  $next.addEventListener('click', () => { curPage++; renderTable(); });

  $pageSize.addEventListener('change', () => {
    perPage = parseInt($pageSize.value, 10);
    curPage = 1;
    renderTable();
  });

  loadAll();
})();
</script>
</body>
</html>
