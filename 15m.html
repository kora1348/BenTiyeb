<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Variations ‚Äî Binance (Movers 24h + Futures 15m)</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5}
    h2{margin:0 0 6px}
    .status{margin:0 0 10px;font-weight:700}
    .status.negative{color:#dc2626}
    .status.positive{color:#16a34a}

    .card{margin:12px 0 14px;padding:14px;border-radius:10px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.10)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .muted{color:#666;font-size:13px}
    table{background:#fff;border-collapse:collapse}
    th{background:#fafafa;position:sticky;top:0}
    th,td{border:1px solid #ddd;padding:8px}
    .wrap{max-width:1200px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:14px}
    .small{font-size:12px}

    select, input, button{font:inherit}
    button{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:10px;
      padding:7px 10px;
      cursor:pointer;
    }
    button:hover{background:#fafafa}
    button.primary{border-color:#bbf7d0;background:#f0fdf4}
    button.danger{border-color:#fecaca;background:#fff1f2}

    .pill{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:#eef2ff;
      font-size:12px;
      color:#1f2a44;
      border:1px solid #e5e7eb;
    }

    .insights{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:linear-gradient(180deg,#ffffff,#fafafa);
    }
    .insightsTitle{
      margin:0 0 8px;
      font-weight:800;
      font-size:13px;
      color:#111827;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .insightsGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 700px){
      .insightsGrid{grid-template-columns:1fr}
    }
    .box{
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    .boxHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .boxHeader .tag{
      font-weight:800;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid transparent;
    }
    .tag.neg{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .tag.pos{background:#dcfce7;border-color:#bbf7d0;color:#166534}

    .hoursRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .hourChip{
      padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;
      background:#f9fafb;font-size:12px;font-weight:700;color:#111827;
    }
    .hourChip.neg{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    .hourChip.pos{background:#f0fdf4;border-color:#bbf7d0;color:#166534}

    .dayTotal{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 10px}
    .dayTotal .badge{
      display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;
      background:#f9fafb;font-size:12px;font-weight:800;white-space:nowrap;
    }
    .badge.pos{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
    .badge.neg{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    .badge.neu{background:#f3f4f6;border-color:#e5e7eb;color:#374151}

    .modePill{
      display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #dbeafe;
      background:#eff6ff;color:#1d4ed8;font-weight:800;font-size:12px;
    }

    tr.inWindow td{ background:#fff7ed; }
    tr.inWindow td:last-child{ font-weight:800; }

    /* Movers card */
    .moversGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 700px){ .moversGrid{grid-template-columns:1fr} }
    .mini th,.mini td{padding:6px;font-size:13px}
    .kpiRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
    .kpi{padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;font-weight:800;font-size:12px}
    .loadingLine{color:#6b7280;font-style:italic}
  </style>
</head>

<body class="wrap">

  <!-- CARD CONTROLES -->
  <div class="card">
    <div class="row">
      <div>
        <button class="prevBtn">Pr√©c√©dant</button>
        <button class="nextBtn">Suivant</button>

        &nbsp;|&nbsp;

        <label>
          Date :
          <input type="text" class="dateInput" placeholder="JJ/MM/AAAA" inputmode="numeric" style="width:120px" />
        </label>

        <button class="goDateBtn">OK</button>

        &nbsp;|&nbsp;

        <label class="small">
          Nombre de jours affich√©s :
          <input id="daysCount" type="number" min="1" max="60" value="24" style="width:70px" />
        </label>

        &nbsp;|&nbsp;

        <label class="small">
          Filtre :
          <select id="polarityFilter">
            <option value="all">All</option>
            <option value="negative">Negative</option>
            <option value="positive">Positif</option>
          </select>
        </label>

        &nbsp;|&nbsp;

        <label class="small">
          Movers :
          <select id="moversMarket">
            <option value="futures" selected>Futures (24h)</option>
            <option value="spot">Spot (24h)</option>
          </select>
        </label>

        <button id="reloadBtn">Recharger</button>

        <span class="pill" id="shownCount">‚Äî</span>
        <span class="modePill" id="modePill" style="display:none"></span>
      </div>

      <div class="muted" id="rangeInfo">‚Äî</div>
    </div>

    <div class="muted small" id="fixedInfo"></div>

    <div class="insights" id="globalInsights">
      <div class="insightsTitle">
        <span>üìå Heures cl√©s (15m)</span>
        <span class="muted small">1 seul total = celui du mode actif</span>
      </div>

      <div class="insightsGrid">
        <div class="box">
          <div class="boxHeader">
            <span>üî¥ S√©ances √† risque</span>
            <span class="tag neg">NEGATIVE</span>
          </div>

          <div class="hoursRow" style="margin-bottom:10px">
            <div class="hoursRow" id="riskHours"></div>
          </div>

          <div class="hoursRow">
            <button class="danger" id="btnShowRiskNegative">Afficher tableaux N√âGATIFS + s√©ances 09:51 / 09:54 / 21:51 / 23:51 / 23:54</button>
            <button id="btnResetModeA">Reset</button>
          </div>
        </div>

        <div class="box">
          <div class="boxHeader">
            <span>üü¢ S√©ances favorables</span>
            <span class="tag pos">POSITIVE</span>
          </div>

          <div class="hoursRow" style="margin-bottom:10px">
            <div class="hoursRow" id="goodHours"></div>
          </div>

          <div class="hoursRow">
            <button class="primary" id="btnShowGoodPositive">Afficher tableaux POSITIFS + s√©ances 11:48 / 12:42 / 14:45 / 15:48</button>
            <button id="btnResetModeB">Reset</button>
          </div>
        </div>
      </div>

      <div class="muted small" style="margin-top:8px">
        ‚úÖ Movers = <b>24h change LIVE</b> (comme Binance).<br>
        ‚úÖ Tables BTC/ETH = bougies futures <b>15m</b> (historique du jour).<br>
        ‚úÖ Mode ‚Äús√©ance‚Äù filtre uniquement les heures demand√©es.
      </div>
    </div>
  </div>

  <div id="tables" class="grid"></div>

<script>
/* ========= CONFIG ========= */
const BASE_FUTURES = "https://fapi.binance.com";
const BASE_SPOT    = "https://api.binance.com";

const SYMBOLS = ["BTCUSDT","ETHUSDT"];  // tableaux 15m (futures)
const INTERVAL     = "15m";
const MINUTES_STEP = 15;

const MOVERS_TOP_N = 4;
const MOVERS_QUOTE = "USDT";

const NOW = new Date();
const RANGE_START_UTC = new Date(Date.UTC(NOW.getUTCFullYear(), NOW.getUTCMonth(), NOW.getUTCDate(), 0,0,0,0));
const RANGE_END_UTC   = new Date(Date.UTC(2025, 10, 27, 0,0,0,0)); // 27/11/2025
let baseDateUtc = new Date(RANGE_START_UTC);

const STATUS_BY_DATE_FR = {
  "21/12/2025": { text: "negative", cls: "negative" },
  "20/12/2025": { text: "positif",  cls: "positive" },
  "19/12/2025": { text: "negative", cls: "negative" },
  "18/12/2025": { text: "negative", cls: "negative" },
  "17/12/2025": { text: "negative", cls: "negative" },
  "16/12/2025": { text: "positif",  cls: "positive" },
  "15/12/2025": { text: "negative", cls: "negative" },
  "14/12/2025": { text: "negative", cls: "negative" },
  "13/12/2025": { text: "negative", cls: "negative" },
  "12/12/2025": { text: "negative", cls: "negative" },
};

const GOOD_SESSIONS = ["11:48","12:42","14:45","15:48"];
const RISK_SESSIONS = ["09:51","09:54","21:51","23:51","23:54"];
let MODE = "none";

/* ========= HELPERS ========= */
const pad2 = n => String(n).padStart(2, "0");
const toFr = d => `${pad2(d.getUTCDate())}/${pad2(d.getUTCMonth()+1)}/${d.getUTCFullYear()}`;
const fmtPct = v => `${v>0?"+":""}${v.toFixed(2)}%`;
function applyColor(el, v){ el.style.color = v>0 ? "green" : v<0 ? "red" : ""; }

function fmtTimeUTC(ms){
  const d = new Date(ms);
  return `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}`;
}
function parseHHMM(hhmm){
  const m = /^(\d{2}):(\d{2})$/.exec(String(hhmm).trim());
  if(!m) return null;
  const hh = Number(m[1]), mm = Number(m[2]);
  if(hh<0||hh>23||mm<0||mm>59) return null;
  return { minOfDay: hh*60 + mm };
}
function alignToStep(minOfDay){
  const aligned = Math.floor(minOfDay / MINUTES_STEP) * MINUTES_STEP;
  return Math.min(1435, aligned);
}
function buildSessions(listHHMM){
  const out = [];
  for(const t of listHHMM){
    const p = parseHHMM(t);
    if(!p) continue;
    const a = alignToStep(p.minOfDay);
    out.push({ min: a, label: t, alignedLabel: `${pad2(Math.floor(a/60))}:${pad2(a%60)}` });
  }
  return out;
}
function isInAnySession(minOfDay, sessions){
  for(const s of sessions){
    if(minOfDay === s.min) return true;
  }
  return false;
}
function renderGlobalInsights(){
  const riskWrap = document.getElementById("riskHours");
  const goodWrap = document.getElementById("goodHours");
  riskWrap.innerHTML = "";
  goodWrap.innerHTML = "";
  for(const s of buildSessions(RISK_SESSIONS)){
    const sp = document.createElement("span");
    sp.className = "hourChip neg";
    sp.textContent = `${s.label} ‚Üí ${s.alignedLabel}`;
    riskWrap.appendChild(sp);
  }
  for(const s of buildSessions(GOOD_SESSIONS)){
    const sp = document.createElement("span");
    sp.className = "hourChip pos";
    sp.textContent = `${s.label} ‚Üí ${s.alignedLabel}`;
    goodWrap.appendChild(sp);
  }
}
function addDaysUtc(d, days){
  const x = new Date(d);
  x.setUTCDate(x.getUTCDate() + days);
  return new Date(Date.UTC(x.getUTCFullYear(), x.getUTCMonth(), x.getUTCDate(), 0,0,0,0));
}
function clampToFixedRange(d){
  const maxT = Math.max(RANGE_START_UTC.getTime(), RANGE_END_UTC.getTime());
  const minT = Math.min(RANGE_START_UTC.getTime(), RANGE_END_UTC.getTime());
  const t = d.getTime();
  if(t > maxT) return new Date(maxT);
  if(t < minT) return new Date(minT);
  return d;
}
function frToUtcDate(fr){
  const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(String(fr || "").trim());
  if(!m) return null;
  const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
  if(mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;
  const dt = new Date(Date.UTC(yy, mm-1, dd, 0,0,0,0));
  if(isNaN(dt.getTime())) return null;
  if(dt.getUTCFullYear() !== yy || (dt.getUTCMonth()+1) !== mm || dt.getUTCDate() !== dd) return null;
  return dt;
}
function dayUtcRangeMs(dUtc){
  const y = dUtc.getUTCFullYear();
  const m = dUtc.getUTCMonth();
  const d = dUtc.getUTCDate();
  return { start: Date.UTC(y,m,d,0,0,0,0), end: Date.UTC(y,m,d,23,59,59,999) };
}
function sameUtcDay(a, b){
  return a.getUTCFullYear()===b.getUTCFullYear()
    && a.getUTCMonth()===b.getUTCMonth()
    && a.getUTCDate()===b.getUTCDate();
}

/* ========= API (15m FUTURES) ========= */
async function fetchKlinesFutures(symbol, startMs, endMs){
  const url = `${BASE_FUTURES}/fapi/v1/klines?symbol=${encodeURIComponent(symbol)}&interval=${INTERVAL}&startTime=${startMs}&endTime=${endMs}&limit=200`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${symbol} -> HTTP ${r.status}`);
  const arr = await r.json();
  if(!Array.isArray(arr) || arr.length === 0) throw new Error(`${symbol} -> aucune bougie ${INTERVAL}`);
  return arr;
}
function pctFromKline(k){
  const o = +k[1], c = +k[4];
  if(!isFinite(o) || !isFinite(c) || o <= 0) return null;
  return ((c - o) / o) * 100;
}

/* ========= MOVERS (LIVE 24H like Binance) ========= */
async function fetchMovers24h(market){
  const url = market === "spot"
    ? `${BASE_SPOT}/api/v3/ticker/24hr`
    : `${BASE_FUTURES}/fapi/v1/ticker/24hr`;

  const r = await fetch(url);
  if(!r.ok) throw new Error(`ticker/24hr -> HTTP ${r.status}`);
  const arr = await r.json();
  if(!Array.isArray(arr)) throw new Error(`ticker/24hr -> r√©ponse invalide`);

  // On garde uniquement les paires ...USDT, et percent num√©rique
  const rows = [];
  for(const it of arr){
    const sym = String(it?.symbol || "");
    if(!sym.endsWith(MOVERS_QUOTE)) continue;
    const v = Number(it?.priceChangePercent);
    if(!isFinite(v)) continue;
    rows.push({ sym, v });
  }
  return rows;
}

/* ========= MODE TARGET ========= */
function modeTarget(){
  if(MODE === "goodPos") return { kind:"session", sessions: buildSessions(GOOD_SESSIONS), label:`Œ£(s√©ances align√©es ${INTERVAL})` };
  if(MODE === "riskNeg") return { kind:"session", sessions: buildSessions(RISK_SESSIONS), label:`Œ£(s√©ances align√©es ${INTERVAL})` };
  return { kind:"all", sessions: null, label:"Œ£(24h)" };
}

/* ========= CARDS ========= */
function setBadgeClass(el, value, found){
  el.classList.remove("pos","neg","neu");
  if(!found) el.classList.add("neu");
  else if(value > 0) el.classList.add("pos");
  else if(value < 0) el.classList.add("neg");
  else el.classList.add("neu");
}

function createMoversCard(dateUtc){
  const fr = toFr(dateUtc);
  const st = STATUS_BY_DATE_FR[fr];

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.polarity = st ? st.cls : "unknown";

  const h2 = document.createElement("h2");
  h2.textContent = `üìà Movers (24h LIVE) ‚Äî ${fr} (TOP ${MOVERS_TOP_N} / FLOP ${MOVERS_TOP_N})`;
  card.appendChild(h2);

  const kpi = document.createElement("div");
  kpi.className = "kpiRow";
  kpi.innerHTML = `
    <span class="kpi" data-role="market">Market: ‚Äî</span>
    <span class="kpi" data-role="count">Paires USDT: ‚Äî</span>
    <span class="kpi" data-role="note">‚Äî</span>
  `;
  card.appendChild(kpi);

  if(st){
    const p = document.createElement("div");
    p.className = `status ${st.cls}`;
    p.textContent = st.text;
    card.appendChild(p);
  }else{
    const p = document.createElement("div");
    p.className = "muted small";
    p.textContent = "(polarit√© non d√©finie)";
    card.appendChild(p);
  }

  const wrap = document.createElement("div");
  wrap.className = "moversGrid";

  const topBox = document.createElement("div");
  topBox.className = "box";
  topBox.innerHTML = `
    <div class="boxHeader">
      <span>Top ${MOVERS_TOP_N} (24h)</span>
      <span class="tag pos">HAUT</span>
    </div>
    <table class="mini" width="100%">
      <thead><tr><th>Symbol</th><th>Var 24h</th></tr></thead>
      <tbody data-role="top"><tr><td colspan="2" class="loadingLine">‚è≥ Chargement des movers 24h‚Ä¶</td></tr></tbody>
    </table>
  `;

  const flopBox = document.createElement("div");
  flopBox.className = "box";
  flopBox.innerHTML = `
    <div class="boxHeader">
      <span>Flop ${MOVERS_TOP_N} (24h)</span>
      <span class="tag neg">BAS</span>
    </div>
    <table class="mini" width="100%">
      <thead><tr><th>Symbol</th><th>Var 24h</th></tr></thead>
      <tbody data-role="flop"><tr><td colspan="2" class="loadingLine">‚è≥ Chargement des movers 24h‚Ä¶</td></tr></tbody>
    </table>
  `;

  wrap.appendChild(topBox);
  wrap.appendChild(flopBox);
  card.appendChild(wrap);

  return {
    card,
    elMarket: kpi.querySelector('[data-role="market"]'),
    elCount:  kpi.querySelector('[data-role="count"]'),
    elNote:   kpi.querySelector('[data-role="note"]'),
    topTbody: topBox.querySelector('tbody[data-role="top"]'),
    flopTbody: flopBox.querySelector('tbody[data-role="flop"]'),
  };
}

async function fillMoversForDate(dateUtc, ui){
  const market = document.getElementById("moversMarket").value; // futures|spot
  ui.elMarket.textContent = `Market: ${market.toUpperCase()}`;
  ui.elNote.textContent = `Source: ticker/24hr (LIVE)`;

  // IMPORTANT: ticker/24hr = live, donc √ßa repr√©sente "maintenant".
  // On l'affiche pour chaque jour, mais c'est la m√™me source live.
  // Si tu veux de l'historique 24h, Binance ne donne pas √ßa directement via API.
  const rows = await fetchMovers24h(market);
  ui.elCount.textContent = `Paires USDT: ${rows.length}`;

  rows.sort((a,b)=> b.v - a.v);
  const top = rows.slice(0, MOVERS_TOP_N);
  const flop = rows.slice(-MOVERS_TOP_N).sort((a,b)=> a.v - b.v);

  ui.topTbody.innerHTML = "";
  for(const it of top){
    const tr = document.createElement("tr");
    const tdS = document.createElement("td");
    const tdV = document.createElement("td");
    tdS.textContent = it.sym;
    tdV.textContent = fmtPct(it.v);
    applyColor(tdV, it.v);
    tr.appendChild(tdS); tr.appendChild(tdV);
    ui.topTbody.appendChild(tr);
  }

  ui.flopTbody.innerHTML = "";
  for(const it of flop){
    const tr = document.createElement("tr");
    const tdS = document.createElement("td");
    const tdV = document.createElement("td");
    tdS.textContent = it.sym;
    tdV.textContent = fmtPct(it.v);
    applyColor(tdV, it.v);
    tr.appendChild(tdS); tr.appendChild(tdV);
    ui.flopTbody.appendChild(tr);
  }
}

function createTableCard(symbol, dateUtc){
  const fr = toFr(dateUtc);
  const st = STATUS_BY_DATE_FR[fr];

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.polarity = st ? st.cls : "unknown";

  const h2 = document.createElement("h2");
  h2.textContent = `Tableau ‚Äî ${symbol} ‚Äî ${fr}`;
  card.appendChild(h2);

  const meta = document.createElement("div");
  meta.className = "dayTotal";
  meta.innerHTML = `
    <span class="badge neu" data-role="sum">Total: ‚Äî</span>
    <span class="badge neu" data-role="found">Lignes trouv√©es: ‚Äî</span>
  `;
  card.appendChild(meta);

  if(st){
    const p = document.createElement("div");
    p.className = `status ${st.cls}`;
    p.textContent = st.text;
    card.appendChild(p);
  }else{
    const p = document.createElement("div");
    p.className = "muted small";
    p.textContent = "(polarit√© non d√©finie)";
    card.appendChild(p);
  }

  const table = document.createElement("table");
  table.width = "100%";
  table.cellPadding = "8";
  table.innerHTML = `
    <thead>
      <tr>
        <th>Heure (UTC)</th>
        <th>Taux variation ${INTERVAL}</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="2">Chargement...</td></tr></tbody>
  `;
  card.appendChild(table);

  return {
    card,
    tbody: table.querySelector("tbody"),
    elSum: meta.querySelector('[data-role="sum"]'),
    elFound: meta.querySelector('[data-role="found"]')
  };
}

/* ========= FILL TABLE (15m) ========= */
async function fillTableForDate(symbol, dateUtc, ui){
  const tbody = ui.tbody;
  tbody.innerHTML = "";

  const {start, end} = dayUtcRangeMs(dateUtc);
  const klines = await fetchKlinesFutures(symbol, start, end);

  const rows = [];
  for(const k of klines){
    if(!k || !isFinite(k[0])) continue;
    const openMs = k[0];
    if(openMs < start || openMs > end) continue;

    const v = pctFromKline(k);
    if(v === null) continue;

    const d = new Date(openMs);
    const minOfDay = d.getUTCHours()*60 + d.getUTCMinutes();
    rows.push({ openMs, minOfDay, v });
  }

  const tgt = modeTarget();
  let displayed = rows;
  if(tgt.kind === "session"){
    displayed = rows.filter(r => isInAnySession(r.minOfDay, tgt.sessions));
  }

  let sum = 0;
  for(const r of displayed) sum += r.v;

  ui.elFound.textContent = `Lignes affich√©es: ${displayed.length}`;
  ui.elSum.textContent = `${tgt.label}: ${displayed.length ? fmtPct(sum) : "‚Äî"}`;
  setBadgeClass(ui.elSum, sum, displayed.length);

  if(displayed.length === 0){
    tbody.innerHTML = `<tr><td colspan="2">Aucune donn√©e</td></tr>`;
    return;
  }

  for(const r of displayed){
    const tr = document.createElement("tr");
    if(tgt.kind !== "all") tr.classList.add("inWindow");

    const tdT = document.createElement("td");
    const tdV = document.createElement("td");

    tdT.textContent = fmtTimeUTC(r.openMs);
    tdV.textContent = fmtPct(r.v);
    applyColor(tdV, r.v);

    tr.appendChild(tdT);
    tr.appendChild(tdV);
    tbody.appendChild(tr);
  }
}

/* ========= FILTRE + MODE ========= */
function applyPolarityFilter(){
  const sel = document.getElementById("polarityFilter").value;
  const cards = Array.from(document.querySelectorAll("#tables .card"));
  let shown = 0;

  for(const c of cards){
    const pol = c.dataset.polarity;
    let visible = true;

    if(sel === "negative") visible = (pol === "negative");
    else if(sel === "positive") visible = (pol === "positive");

    c.style.display = visible ? "" : "none";
    if(visible) shown++;
  }
  document.getElementById("shownCount").textContent = `Affich√©s: ${shown}/${cards.length}`;
}

function updateModePill(){
  const pill = document.getElementById("modePill");
  if(MODE === "none"){
    pill.style.display = "none";
    pill.textContent = "";
    return;
  }
  pill.style.display = "";
  if(MODE === "riskNeg") pill.textContent = `MODE: N√âGATIFS + s√©ances (align√©es ${INTERVAL})`;
  if(MODE === "goodPos") pill.textContent = `MODE: POSITIFS + s√©ances (align√©es ${INTERVAL})`;
}

function setMode(next){
  MODE = next;
  updateModePill();
  if(MODE === "goodPos") document.getElementById("polarityFilter").value = "positive";
  if(MODE === "riskNeg") document.getElementById("polarityFilter").value = "negative";
  refreshMulti();
}

/* ========= RENDER ========= */
async function refreshMulti(){
  baseDateUtc = clampToFixedRange(baseDateUtc);

  const days = Math.max(1, Math.min(60, Number(document.getElementById("daysCount").value || 24)));
  const tablesWrap = document.getElementById("tables");
  tablesWrap.innerHTML = "";

  const maxDaysPossible =
    Math.floor((baseDateUtc.getTime() - Math.min(RANGE_START_UTC.getTime(), RANGE_END_UTC.getTime())) / (24*60*60*1000)) + 1;

  const realDays = Math.min(days, maxDaysPossible);

  document.getElementById("rangeInfo").textContent =
    `Affich√© : ${toFr(baseDateUtc)} ‚Üí ${toFr(addDaysUtc(baseDateUtc, -(realDays-1)))} (UTC)`;

  const market = document.getElementById("moversMarket").value;
  document.getElementById("fixedInfo").textContent =
    `Fen√™tre fix√©e : ${toFr(RANGE_START_UTC)} ‚Üí ${toFr(RANGE_END_UTC)} (UTC). | Tables: Futures 15m BTC/ETH | Movers: ${market.toUpperCase()} ticker/24hr (LIVE).`;

  const jobs = [];

  for(let i=0;i<realDays;i++){
    const d = addDaysUtc(baseDateUtc, -i);

    // 1) Movers card (LIVE 24h)
    const movers = createMoversCard(d);
    tablesWrap.appendChild(movers.card);
    jobs.push(
      fillMoversForDate(d, movers).catch(err=>{
        console.error(err);
        movers.topTbody.innerHTML = `<tr><td colspan="2">Erreur</td></tr>`;
        movers.flopTbody.innerHTML = `<tr><td colspan="2">Erreur</td></tr>`;
        movers.elNote.textContent = "‚ùå Erreur API movers.";
      })
    );

    // 2) Tables 15m futures (BTC/ETH)
    for(const sym of SYMBOLS){
      const obj = createTableCard(sym, d);
      tablesWrap.appendChild(obj.card);
      jobs.push(
        fillTableForDate(sym, d, obj).catch(err=>{
          console.error(err);
          obj.tbody.innerHTML = `<tr><td colspan="2">Erreur</td></tr>`;
          obj.elSum.textContent = "Total: Erreur";
          obj.elFound.textContent = "Lignes trouv√©es: ‚Äî";
        })
      );
    }
  }

  await Promise.all(jobs);
  applyPolarityFilter();
}

/* ========= EVENTS ========= */
document.querySelectorAll(".prevBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    baseDateUtc = addDaysUtc(baseDateUtc, -1);
    baseDateUtc = clampToFixedRange(baseDateUtc);
    document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
    await refreshMulti();
  });
});
document.querySelectorAll(".nextBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    baseDateUtc = addDaysUtc(baseDateUtc, 1);
    baseDateUtc = clampToFixedRange(baseDateUtc);
    document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
    await refreshMulti();
  });
});
document.querySelectorAll(".goDateBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    const wrap = btn.parentElement;
    const inp = wrap.querySelector(".dateInput");
    const dt = frToUtcDate(inp.value);
    if(!dt){
      alert("Date invalide. Format JJ/MM/AAAA (ex: 20/12/2025).");
      return;
    }
    baseDateUtc = clampToFixedRange(new Date(dt));
    document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
    await refreshMulti();
  });
});
document.querySelectorAll(".dateInput").forEach(inp => {
  inp.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      const btn = inp.parentElement.parentElement.querySelector(".goDateBtn");
      if(btn) btn.click();
    }
  });
});

document.getElementById("reloadBtn").addEventListener("click", refreshMulti);
document.getElementById("moversMarket").addEventListener("change", refreshMulti);

document.getElementById("polarityFilter").addEventListener("change", ()=>{
  const v = document.getElementById("polarityFilter").value;
  if(MODE === "goodPos" && v !== "positive") setMode("none");
  if(MODE === "riskNeg" && v !== "negative") setMode("none");
  applyPolarityFilter();
});

document.getElementById("btnShowGoodPositive").addEventListener("click", ()=>setMode("goodPos"));
document.getElementById("btnShowRiskNegative").addEventListener("click", ()=>setMode("riskNeg"));
document.getElementById("btnResetModeA").addEventListener("click", ()=>setMode("none"));
document.getElementById("btnResetModeB").addEventListener("click", ()=>setMode("none"));

/* ========= INIT ========= */
renderGlobalInsights();
updateModePill();
document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
refreshMulti();
</script>

</body>
</html>
