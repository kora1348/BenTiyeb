<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Listings ‚Äî Bougie n¬∞20 (Binance Futures USDT-M PERP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ok:#10b981; --bad:#ef4444; --text:#e5e7eb; --border:#1f2937; --warn:#f59e0b; --ink:#111827;}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;font-size:13px}
    header{padding:18px 16px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    main{max-width:980px;margin:18px auto;padding:0 12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0;align-items:flex-end}
    label{font-size:12px}
    label span{display:block;margin-bottom:4px;font-size:11px}
    select,button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:12px}
    button{cursor:pointer}
    .btn-danger{border-color:#3b1d1d;background:#1a0e0e}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:right;vertical-align:top}
    th:first-child,td:first-child{text-align:left}
    .up{color:var(--ok);font-weight:600}
    .down{color:var(--bad);font-weight:600}
    .muted{color:var(--muted)}
    .error{color:var(--bad);margin-top:8px}
    .hint{font-size:11px;color:var(--muted);margin-top:8px}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .right{position:absolute;top:-70px;right:12px}
    #homeBtn { color:white!important; border:1px solid var(--border); }
    #homeBtn a { color:white!important; text-decoration:none; display:block; }
    .candle-date-banner{
      margin:16px 0 6px;display:flex;justify-content:center;align-items:center;
      background:#facc15;color:#111827;border:1px solid #f59e0b;border-radius:12px;
      padding:10px 14px;font-weight:700;font-size:18px;letter-spacing:.5px;
    }
    #status{font-size:11px}
    #nCalendar{font-size:12px;margin-left:auto}
    /* Carte d‚Äôalerte ‚Äúdates en double avec m√™me polarit√©‚Äù */
    .dupe-card{margin:16px 0 10px;background:#0f1222;border:1px solid #23324a}
    .dupe-title{display:flex;gap:8px;align-items:center;margin-bottom:8px;font-weight:700}
    .dupe-pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px}
    .dupe-pill.positive{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08)}
    .dupe-pill.negative{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
    .dupe-month{margin-top:8px}
    .dupe-empty{font-size:12px;color:var(--muted)}
    .dupe-month h4{margin:8px 0 6px;font-size:13px;color:#d1d5db}
  </style>
</head>
<body>
  <header>
    <h1 id="h1">Listings en janvier ‚Ä¢ Bougie n¬∞<span id="nLabel">20</span></h1>
    <div class="sub">March√© analys√© : <b>Binance Futures ‚Äî USDT-M PERP</b></div>
  </header>
  <main>
    <div class="controls">
      <label>
        <span class="muted">Ann√©e (affich√©e +1)</span>
        <select id="yearSel"></select>
      </label>
      <label>
        <span class="muted">Mois</span>
        <select id="monthSel"></select>
      </label>
      <label>
        <span class="muted">N¬∞ de bougie (daily)</span>
        <select id="candleSel"></select>
      </label>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="runBtn">Run</button>
        <button id="clearBtn" class="btn-danger">üóëÔ∏è Effacer</button>
        <button id="homeBtn"><a href="/index.html">Accueil</a></button>
        <span id="status" class="muted"></span>
      </div>
      <div class="muted" id="nCalendar" style="margin-left:auto">
        Bougie n¬∞<b><span id="nCalN">20</span></b> ‚Äî <b><span id="nCalDate">‚Äî</span></b>
      </div>
    </div>

    <!-- Cartes d'alerte -->
    <div id="dupeCardsContainer"></div>

    <div class="card">
      <div class="right badge"><span id="progress">‚Äî</span></div>
      <table>
        <thead>
          <tr>
            <th style="width:160px">Symbole</th>
            <th style="width:230px">Date bougie n¬∞<span id="thN1">20</span> (Europe/Brussels)</th>
            <th style="width:230px">Date &gt; 1 an apr√®s (Europe/Brussels)</th>
            <th style="width:150px">Variation bougie n¬∞<span id="thN2">20</span></th>
            <th style="width:230px">Variation bougie 5m</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="err" class="error"></div>
      <div class="hint" id="hint">
        D√©tection du listing : premi√®re bougie journali√®re disponible (<code>startTime=0</code>).<br>
        On conserve uniquement les cryptos dont le <b>jour de listing</b> est dans le mois/ann√©e choisis.<br>
        Bougie n¬∞<span id="hintN">20</span> = jour n¬∞<span id="hintN2">20</span> apr√®s le listing.
        Variation = (Close - Open) / Open √ó 100.
        La colonne ‚Äú&gt; 1 an apr√®s‚Äù = (bougie n¬∞<span id="hintN3">20</span>) + 1 an (strictement &gt; 1 an).<br>
      </div>
      <div id="candleDateBanner" class="candle-date-banner">‚Äî</div>
    </div>
  </main>

  <script>
    // ====== DOM refs
    const tz='Europe/Brussels';
    const yearSel   = document.getElementById('yearSel');
    const monthSel  = document.getElementById('monthSel');
    const candleSel = document.getElementById('candleSel');
    const runBtn    = document.getElementById('runBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const statusEl  = document.getElementById('status');
    const progressEl= document.getElementById('progress');
    const tbody     = document.getElementById('tbody');
    const errEl     = document.getElementById('err');
    const nLabel = document.getElementById('nLabel');
    const thN1   = document.getElementById('thN1');
    const thN2   = document.getElementById('thN2');
    const hintN  = document.getElementById('hintN');
    const hintN2 = document.getElementById('hintN2');
    const hintN3 = document.getElementById('hintN3');
    const nCalN    = document.getElementById('nCalN');
    const nCalDate = document.getElementById('nCalDate');
    const candleDateBanner = document.getElementById('candleDateBanner');
    const dupeCardsContainer = document.getElementById('dupeCardsContainer');

    // ====== Consts
    const dayMs = 24*60*60*1000;
    const BANNER_BASE_MS = Date.UTC(2025, 9, 9, 0, 0, 0); // 09/10/2025
    const ALLOWED_MONTHS = [0,5,8]; // Jan, Jun, Sep
    let refListingMs = null;
    let lastRows = [];

    // ====== Caches
    const CACHE = {
      symbols: null,
      daily60: new Map(),
      monthRows: new Map(),
      pct5m: new Map(),
      computed: new Map(),
    };
    const keyMonth = (Y,M)=>`${Y}-${M}`;
    const key5m   = (sym, openTimeN, m5)=>`${sym}-${openTimeN}-${m5}`;
    const keyComputed = (Y,M,N)=>`${Y}-${M}-${N}`;

    // ====== Helpers dates & formats
    function capitalizeFr(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
    function formatLongFrDate(ms){
      const d = new Date(ms);
      const day = new Intl.DateTimeFormat('fr-BE',{timeZone:tz,day:'2-digit'}).format(d);
      const month = capitalizeFr(new Intl.DateTimeFormat('fr-BE',{timeZone:tz,month:'long'}).format(d));
      const year = new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'numeric'}).format(d);
      return `${day} ${month} ${year}`;
    }
    function toBrusselsDate(ms){
      const d = new Date(ms);
      return new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d);
    }
    function formatBrusselsDateTime(ms){
      const d = new Date(ms);
      return new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d);
    }
    function monthYearInBrussels(ms){
      const d = new Date(new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date(ms))+'T00:00:00');
      return { y: d.getUTCFullYear(), m: d.getUTCMonth() };
    }
    function dateKeyBrussels(ms){
      return new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date(ms));
    }
    function dateKeyHuman(ms){
      return new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'2-digit',month:'2-digit',day:'2-digit'}).format(new Date(ms));
    }
    function plusThanOneYear(ms){ const d=new Date(ms); d.setUTCFullYear(d.getUTCFullYear()+1); return d.getTime()+1; }
    const fmtPct = n => (n>=0?'+':'') + n.toFixed(4) + ' %';

    // ====== Fetch helpers
    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status} ‚Äî ${await r.text()}`);
      return r.json();
    }
    async function mapLimit(items, limit, worker){
      const ret = []; let i=0, active=0, done=0;
      return new Promise(resolve=>{
        const next=()=>{
          while(active<limit && i<items.length){
            const idx=i++, it=items[idx]; active++;
            Promise.resolve(worker(it,idx))
            .then(res=>{ ret[idx]=res; })
            .catch(()=>{ ret[idx]=null; })
            .finally(()=>{
              active--; done++; progressEl.textContent = `${done}/${items.length}`;
              if(done===items.length) resolve(ret); else next();
            });
          }
        };
        next();
      });
    }
    function getTzOffsetMinutesEuropeBrussels(ms){
      const dtf = new Intl.DateTimeFormat('en-US',{timeZone:'Europe/Brussels',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hourCycle:'h23'});
      const parts = dtf.formatToParts(new Date(ms));
      const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
      const asUTC = Date.UTC(+map.year, +map.month-1, +map.day, +map.hour, +map.minute, +map.second);
      return Math.round((asUTC - ms)/60000);
    }
    function m5UtcFromDailyOpen(openTimeN_utc, minutesBrussels){
      const probe = openTimeN_utc + 12*60*60*1000;
      const offsetMin = getTzOffsetMinutesEuropeBrussels(probe);
      const minutesUtcFromMidnight = minutesBrussels - offsetMin;
      if (minutesUtcFromMidnight < 0 || minutesUtcFromMidnight >= 1440) return null;
      const k = Math.floor(minutesUtcFromMidnight/5);
      return openTimeN_utc + k * 5*60*1000;
    }
    async function fetch5mPct(sym, openTimeN, minutesBrussels){
      if(openTimeN==null) return { pct5m:null, m5Display:'‚Äî' };
      const m5Utc = m5UtcFromDailyOpen(openTimeN, minutesBrussels);
      if(m5Utc==null) return { pct5m:null, m5Display:'‚Äî' };
      const u = new URL('https://fapi.binance.com/fapi/v1/klines');
      u.searchParams.set('symbol', sym);
      u.searchParams.set('interval', '5m');
      u.searchParams.set('startTime', String(m5Utc));
      u.searchParams.set('limit', '1');
      try{
        const kl = await fetchJSON(u.toString());
        if(!kl || !kl.length) return { pct5m:null, m5Display:'‚Äî' };
        const k = kl[0], o=parseFloat(k[1]), c=parseFloat(k[4]);
        const pct5m = o>0 ? ((c-o)/o*100) : 0;
        return { pct5m, m5Display: formatBrusselsDateTime(m5Utc) };
      }catch{ return { pct5m:null, m5Display:'‚Äî' }; }
    }

    // ====== Rendering tableau (daily + 5m affich√©s, mais seule polarit√© 5m est utilis√©e dans les cartes)
    function renderTable(rows){
      tbody.innerHTML='';
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Aucun nouveau PERP USDT-M list√© pour les crit√®res choisis.</td></tr>`;
        return;
      }
      const frag = document.createDocumentFragment();
      rows.forEach(r=>{
        const tdSym = `<td>${r.sym}</td>`;
        const tdN   = `<td>${r.openTimeN===null?'<span class="muted">‚Äî</span>':toBrusselsDate(r.openTimeN)}</td>`;
        const tdP1  = `<td>${r.openTimeNPlus===null?'<span class="muted">‚Äî</span>':toBrusselsDate(r.openTimeNPlus)}</td>`;
        const tdPct = `<td>${r.pctN===null?'<span class="muted">‚Äî</span>':`<span class="${r.pctN>=0?'up':'down'}">${fmtPct(r.pctN)}</span>`}</td>`;
        const td5m = r.pct5m==null
          ? `<td><span class="muted">‚Äî</span></td>`
          : `<td><div><span class="${r.pct5m>=0?'up':'down'}">${fmtPct(r.pct5m)}</span></div><div class="muted" style="font-size:12px">${r.m5Display||'‚Äî'}</div></td>`;
        const tr = document.createElement('tr'); tr.innerHTML = tdSym+tdN+tdP1+tdPct+td5m; frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    function updateBannerOnly(){
      const n = parseInt(candleSel.value,10);
      const ms = BANNER_BASE_MS + (n-20)*dayMs;
      candleDateBanner.textContent = new Intl.DateTimeFormat('fr-BE',{timeZone:tz,day:'2-digit',month:'2-digit',year:'2-digit'}).format(ms);
    }
    function updateNCalendar(){
      const n = parseInt(candleSel.value,10);
      nCalN.textContent = n;
      if(refListingMs==null){ nCalDate.textContent='‚Äî'; return; }
      const ms = refListingMs + (n-1)*dayMs;
      nCalDate.textContent = formatLongFrDate(ms);
    }
    function updateLabels(){
      const n = parseInt(candleSel.value,10);
      nLabel.textContent = n; thN1.textContent = n; thN2.textContent = n;
      hintN.textContent = n; hintN2.textContent = n; hintN3.textContent = n;
      document.title = `Listings ‚Äî Bougie n¬∞${n} (Binance Futures USDT-M PERP)`;
      updateNCalendar(); updateBannerOnly();
    }
    const markDirty = () => { statusEl.textContent = 'Param√®tres modifi√©s ‚Äî cliquez sur Run (premier chargement seulement)'; };

    // ====== Cache warmers
    async function getSymbolsOnce(){
      if (CACHE.symbols) return CACHE.symbols;
      const ex = await fetchJSON('https://fapi.binance.com/fapi/v1/exchangeInfo');
      CACHE.symbols = (ex.symbols||[])
        .filter(s => s.contractType==='PERPETUAL' && s.quoteAsset==='USDT' && s.status==='TRADING')
        .map(s => s.symbol);
      return CACHE.symbols;
    }
    async function getDaily60(sym){
      if (CACHE.daily60.has(sym)) return CACHE.daily60.get(sym);
      const u=new URL('https://fapi.binance.com/fapi/v1/klines');
      u.searchParams.set('symbol',sym); u.searchParams.set('interval','1d');
      u.searchParams.set('limit','60'); u.searchParams.set('startTime','0');
      const kl = await fetchJSON(u.toString());
      CACHE.daily60.set(sym, kl||[]);
      return kl||[];
    }
    async function warmMonth(Y,M){
      const k = keyMonth(Y,M);
      if (CACHE.monthRows.has(k)) return CACHE.monthRows.get(k);
      const symbols = await getSymbolsOnce();
      statusEl.textContent = `Pr√©paration du mois ${String(M+1).padStart(2,'0')}/${Y}‚Ä¶`;
      progressEl.textContent = '‚Äî';
      const rows = await mapLimit(symbols, 8, async (sym)=>{
        try{
          const kl60 = await getDaily60(sym);
          if(!kl60.length) return null;
          const openTime1 = kl60[0][0];
          const {y,m} = monthYearInBrussels(openTime1);
          if (y!==Y || m!==M) return null;
          return { sym, openTime1, daily60: kl60 };
        }catch{ return null; }
      });
      const kept = rows.filter(Boolean);
      CACHE.monthRows.set(k, kept);
      return kept;
    }

    // Calcul ‚Äúrows‚Äù (daily calcul√© pour l‚Äôaffichage seulement)
    async function computeRowsNo5m(Y,M,N){
      const kc = keyComputed(Y,M,N);
      if (CACHE.computed.has(kc)) return CACHE.computed.get(kc);
      const base = CACHE.monthRows.get(keyMonth(Y,M)) || [];
      if(!base.length){ CACHE.computed.set(kc, []); return []; }
      const rows = await mapLimit(base, 12, async (r)=>{
        const kl = r.daily60;
        let openTimeN=null, openTimeNPlus=null, pctN=null;
        if (kl.length>=N){
          const kN = kl[N-1];
          openTimeN = kN[0];
          const o=parseFloat(kN[1]), c=parseFloat(kN[4]);
          pctN = o>0 ? ((c-o)/o*100) : 0;
          openTimeNPlus = plusThanOneYear(openTimeN);
        }
        return { sym:r.sym, openTime1:r.openTime1, openTimeN, openTimeNPlus, pctN };
      });
      const out = rows.sort((a,b)=>{
        if (a.openTimeN && b.openTimeN) return a.openTimeN - b.openTimeN;
        if (a.openTimeN) return -1;
        if (b.openTimeN) return 1;
        return a.sym.localeCompare(b.sym);
      });
      CACHE.computed.set(kc, out);
      return out;
    }

    // Ajoute les colonnes 5m
    async function enrichRowsWith5m(rows, m5Minutes){
      const out = await mapLimit(rows, 10, async (r)=>{
        if (!r.openTimeN) return { ...r, pct5m:null, m5Display:'‚Äî' };
        const k5m = key5m(r.sym, r.openTimeN, m5Minutes);
        if (CACHE.pct5m.has(k5m)){
          const { pct5m, m5Display } = CACHE.pct5m.get(k5m);
          return { ...r, pct5m, m5Display };
        }else{
          const res5m = await fetch5mPct(r.sym, r.openTimeN, m5Minutes);
          CACHE.pct5m.set(k5m, res5m);
          return { ...r, pct5m:res5m.pct5m, m5Display:res5m.m5Display };
        }
      });
      return out;
    }

    // ====== Test tous les cr√©neaux 5m (polarit√©e bas√©e UNIQUEMENT sur 5m)
    async function testAll5mSlots(Y, M, N) {
      const all5mSlots = [];
      for (let totMin = 0; totMin < 24 * 60; totMin += 5) {
        all5mSlots.push(totMin);
      }
      const validSlots = [];
      for (let i = 0; i < all5mSlots.length; i++) {
        const m5Minutes = all5mSlots[i];
        const hh = String(Math.floor(m5Minutes / 60)).padStart(2, '0');
        const mm = String(m5Minutes % 60).padStart(2, '0');
        statusEl.textContent = `Test ${i+1}/${all5mSlots.length} ‚Äî Cr√©neau 5m : ${hh}:${mm}‚Ä¶`;

        const rowsByMonth = await Promise.all(
          ALLOWED_MONTHS.map(async m => {
            const base = await computeRowsNo5m(Y, m, N);
            const enriched = await enrichRowsWith5m(base, m5Minutes);
            return enriched;
          })
        );

        // R√®gle: pour chaque mois, exactement 2 dates o√π deux symboles ont la m√™me polarit√© 5m (haussi√®re ou baissi√®re)
        const everyMonthHasExactlyTwo = rowsByMonth.every(rows => {
          const mapDates = new Map();
          rows.forEach(r => {
            if (r.openTimeN == null || r.pct5m == null || r.pct5m === 0) return;
            const key = dateKeyBrussels(r.openTimeN);
            if (!mapDates.has(key)) mapDates.set(key, { pos5: [], neg5: [] });
            const bag = mapDates.get(key);
            (r.pct5m > 0 ? bag.pos5 : bag.neg5).push(r);
          });
          let count = 0;
          for (const [, bag] of mapDates.entries()) {
            if (bag.pos5.length === 2) count++;
            if (bag.neg5.length === 2) count++;
          }
          return count === 2;
        });

        if (everyMonthHasExactlyTwo) {
          validSlots.push({ m5Minutes, rowsByMonth });
        }
      }
      return validSlots;
    }

    // ====== Cartes (affichage bas√© uniquement sur polarit√© 5m)
    function renderDupeCards(validSlots, Y, N) {
      dupeCardsContainer.innerHTML = '';
      if (validSlots.length === 0) {
        dupeCardsContainer.innerHTML = '<div class="muted">Aucun cr√©neau 5m ne respecte la r√®gle.</div>';
        return;
      }
      validSlots.forEach(slot => {
        const { m5Minutes, rowsByMonth } = slot;
        const hh = String(Math.floor(m5Minutes / 60)).padStart(2, '0');
        const mm = String(m5Minutes % 60).padStart(2, '0');
        const card = document.createElement('div');
        card.className = 'card dupe-card';
        card.innerHTML = `
          <div class="dupe-title">
            üö® <span>Dates r√©p√©t√©es avec la m√™me polarit√© ‚Äî Bougie n¬∞${N} ‚Ä¢ Cr√©neau 5m : ${hh}:${mm}</span>
          </div>
          <div id="dupeContent_${m5Minutes}"></div>
        `;
        const dupeContent = card.querySelector(`#dupeContent_${m5Minutes}`);

        // Abr√©viations style exemple (Jan, Jun, Sep)
        const monthNamesShort = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

        rowsByMonth.forEach((rows, idx) => {
          const M = ALLOWED_MONTHS[idx];
          const mapDates = new Map();
          rows.forEach(r => {
            if (r.openTimeN == null || r.pct5m == null || r.pct5m === 0) return;
            const key = dateKeyBrussels(r.openTimeN);
            if (!mapDates.has(key)) mapDates.set(key, { pos5: [], neg5: [] });
            const bag = mapDates.get(key);
            (r.pct5m > 0 ? bag.pos5 : bag.neg5).push(r);
          });

          const div = document.createElement('div');
          div.className = 'dupe-month';
          div.innerHTML = `<h4>${monthNamesShort[M]}</h4>`;
          const wrap = document.createElement('div');

          for (const [k, bag] of mapDates.entries()) {
            if (bag.pos5.length === 2) {
              const [a, b] = bag.pos5;
              const pill = document.createElement('span');
              pill.className = 'dupe-pill positive';
              const syms = [a.sym, b.sym].join(', ');
              pill.innerHTML = `<b>${dateKeyHuman(a.openTimeN)}</b> ‚Ä¢ Haussi√®re ‚Ä¢ x2<span class="muted" style="margin-left:6px">${syms}</span>`;
              wrap.appendChild(pill);
            }
            if (bag.neg5.length === 2) {
              const [a, b] = bag.neg5;
              const pill = document.createElement('span');
              pill.className = 'dupe-pill negative';
              const syms = [a.sym, b.sym].join(', ');
              pill.innerHTML = `<b>${dateKeyHuman(a.openTimeN)}</b> ‚Ä¢ Baissi√®re ‚Ä¢ x2<span class="muted" style="margin-left:6px">${syms}</span>`;
              wrap.appendChild(pill);
            }
          }

          if (!wrap.childNodes.length) {
            const empty = document.createElement('div');
            empty.className = 'dupe-empty';
            empty.textContent = '‚Äî';
            wrap.appendChild(empty);
          }

          div.appendChild(wrap);
          dupeContent.appendChild(div);
        });

        dupeCardsContainer.appendChild(card);
      });
    }

    // ====== Run
    async function run(){
      errEl.textContent=''; tbody.innerHTML=''; progressEl.textContent='‚Äî';
      lastRows=[]; refListingMs=null;
      const Y = parseInt(yearSel.value,10);
      const M = parseInt(monthSel.value,10);
      const N = parseInt(candleSel.value,10);
      try{
        statusEl.textContent = 'Chargement initial (une seule fois)‚Ä¶';
        await warmMonth(Y,M);
        await Promise.allSettled(ALLOWED_MONTHS.filter(mm=>mm!==M).map(mm=>warmMonth(Y,mm)));
        statusEl.textContent = `Test de tous les cr√©neaux 5m pour N=${N}‚Ä¶`;
        const validSlots = await testAll5mSlots(Y, M, N);
        if (validSlots.length > 0) {
          statusEl.textContent = `Trouv√© ${validSlots.length} cr√©neau(x) 5m valide(s) !`;
          renderDupeCards(validSlots, Y, N);
        } else {
          statusEl.textContent = 'Aucun cr√©neau 5m ne respecte la r√®gle.';
          dupeCardsContainer.innerHTML = '<div class="muted">Aucun cr√©neau 5m ne respecte la r√®gle.</div>';
        }
      }catch(e){
        console.error(e); errEl.textContent='Erreur: '+e.message; statusEl.textContent='';
      }
    }

    // ====== Effacer (reset complet)
    function clearAll(){
      CACHE.symbols = null;
      CACHE.daily60.clear();
      CACHE.monthRows.clear();
      CACHE.pct5m.clear();
      CACHE.computed.clear();
      lastRows = [];
      refListingMs = null;
      tbody.innerHTML = '';
      dupeCardsContainer.innerHTML = '';
      errEl.textContent = '';
      progressEl.textContent = '‚Äî';
      nCalDate.textContent = '‚Äî';
      candleDateBanner.textContent = '‚Äî';
      updateLabels();
      statusEl.textContent = 'Tout effac√© ‚Äî s√©lectionne tes param√®tres puis clique Run.';
    }

    // ====== Fast re-render si cache d√©j√† chaud
    async function tryFastRender(){
      const Y = parseInt(yearSel.value,10);
      const M = parseInt(monthSel.value,10);
      const N = parseInt(candleSel.value,10);
      if (CACHE.monthRows.has(keyMonth(Y,M))){
        statusEl.textContent = 'Recalcul rapide depuis le cache‚Ä¶';
        const validSlots = await testAll5mSlots(Y, M, N);
        renderDupeCards(validSlots, Y, N);
        statusEl.textContent = `OK (cache) ‚Ä¢ ${validSlots.length} cr√©neau(x) valide(s)`;
      }else{
        markDirty();
      }
    }

    // ====== UI init
    (function initSelectors(){
      const years=[2024];
      years.forEach(y=>{
        const o=document.createElement('option');
        o.value=String(y); o.textContent=String(y+1); o.dataset.realYear=y;
        yearSel.appendChild(o);
      });
      yearSel.value='2024';

      const limitedMonths=[
        {label:'01 Jan', value:0},
        {label:'06 Jun', value:5},
        {label:'09 Sep', value:8},
      ];
      limitedMonths.forEach(({label,value})=>{
        const o=document.createElement('option'); o.value=value; o.textContent=label; monthSel.appendChild(o);
      });
      monthSel.value=0;

      for(let n=1;n<=60;n++){ const o=document.createElement('option'); o.value=n; o.textContent=String(n); candleSel.appendChild(o); }
      candleSel.value='20';

      updateLabels(); updateNCalendar(); updateBannerOnly();
    })();

    // ====== Listeners
    candleSel.addEventListener('change', async ()=>{ updateLabels(); await tryFastRender(); });
    yearSel.addEventListener('change', tryFastRender);
    monthSel.addEventListener('change', tryFastRender);
    runBtn.addEventListener('click', run);
    clearBtn.addEventListener('click', clearAll);

    // ====== Header dynamique
    const h1 = document.getElementById('h1');
    const monthNames = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
    const updateHeader = () => { h1.innerHTML = `Listings en ${monthNames[+monthSel.value]} ‚Ä¢ Bougie n¬∞<span id="nLabel">${candleSel.value}</span>`; };
    monthSel.addEventListener('change', updateHeader);
    candleSel.addEventListener('change', updateHeader);
    updateHeader();
  </script>
</body>
</html>
