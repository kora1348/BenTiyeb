<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analyse Binance - Zones Acheteurs/Vendeurs + Bougies</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f1923;
      color: #eaeaea;
      margin: 0;
      padding: 20px;
    }
    #container {
      max-width: 1100px;
      margin: auto;
      background: #1a2a3a;
      padding: 20px;
      border-radius: 10px;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
      margin-top: 20px;
    }
    .zone-label {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>ðŸ“Š Binance: Bougies 1D + Zones Acheteurs/Vendeurs</h1>
    <canvas id="candlestick-chart"></canvas>
    <canvas id="orderbook-chart"></canvas>
    <div id="zones-info" class="zone-label">Chargement...</div>
  </div>

  <script>
    const SYMBOL = "BTCUSDT";
    const CANDLE_INTERVAL = "1d";
    const CANDLE_LIMIT = 50;
    const ORDERBOOK_LIMIT = 1000;

    let candleChart, orderbookChart;

    const candleCtx = document.getElementById("candlestick-chart").getContext("2d");
    const orderCtx = document.getElementById("orderbook-chart").getContext("2d");

    async function fetchCandlesticks() {
      try {
        const res = await axios.get(`https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=${CANDLE_INTERVAL}&limit=${CANDLE_LIMIT}`);
        const candles = res.data.map(c => ({
          x: new Date(c[0]),
          o: parseFloat(c[1]),
          h: parseFloat(c[2]),
          l: parseFloat(c[3]),
          c: parseFloat(c[4])
        }));

        if (candleChart) candleChart.destroy();

        candleChart = new Chart(candleCtx, {
          type: 'candlestick',
          data: {
            datasets: [{
              label: `${SYMBOL} (${CANDLE_INTERVAL})`,
              data: candles,
              color: {
                up: '#4caf50',
                down: '#f44336',
                unchanged: '#999'
              }
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                time: {
                  unit: 'day'
                },
                ticks: {
                  maxRotation: 0,
                  autoSkip: true
                }
              },
              y: {
                beginAtZero: false
              }
            }
          }
        });
      } catch (error) {
        console.error("Erreur bougies Binance :", error);
      }
    }

    async function fetchOrderbook() {
      try {
        const res = await axios.get(`https://fapi.binance.com/fapi/v1/depth?symbol=${SYMBOL}&limit=${ORDERBOOK_LIMIT}`);

        const bids = res.data.bids.map(([p, q]) => ({ price: parseFloat(p), qty: parseFloat(q) }));
        const asks = res.data.asks.map(([p, q]) => ({ price: parseFloat(p), qty: parseFloat(q) }));

        const topBids = bids.sort((a, b) => b.qty - a.qty).slice(0, 20);
        const topAsks = asks.sort((a, b) => b.qty - a.qty).slice(0, 20);

        const avgBid = averageQty(topBids);
        const avgAsk = averageQty(topAsks);

        const bidZones = topBids.filter(b => b.qty > avgBid * 1.5);
        const askZones = topAsks.filter(a => a.qty > avgAsk * 1.5);

        document.getElementById("zones-info").innerHTML = `
          <strong>Zones d'Acheteurs :</strong><br>
          ${bidZones.map(z => `ðŸŸ¢ ${z.price} (${z.qty})`).join("<br>")}
          <hr>
          <strong>Zones de Vendeurs :</strong><br>
          ${askZones.map(z => `ðŸ”´ ${z.price} (${z.qty})`).join("<br>")}
        `;

        if (orderbookChart) orderbookChart.destroy();

        orderbookChart = new Chart(orderCtx, {
          type: "bar",
          data: {
            labels: [
              ...topBids.map(b => b.price.toFixed(2)),
              ...topAsks.map(a => a.price.toFixed(2))
            ],
            datasets: [
              {
                label: "Buy Orders",
                data: topBids.map(b => b.qty),
                backgroundColor: "rgba(76, 175, 80, 0.6)",
              },
              {
                label: "Sell Orders",
                data: topAsks.map(a => a.qty),
                backgroundColor: "rgba(244, 67, 54, 0.6)",
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: { display: true, text: "Prix" },
                ticks: {
                  maxRotation: 90,
                  minRotation: 45,
                }
              },
              y: {
                title: { display: true, text: "Volume" }
              }
            }
          }
        });

      } catch (error) {
        console.error("Erreur carnet d'ordres Binance :", error);
        document.getElementById("zones-info").innerText = "Erreur API Binance";
      }
    }

    function averageQty(arr) {
      const total = arr.reduce((sum, o) => sum + o.qty, 0);
      return total / arr.length;
    }

    async function updateAll() {
      await fetchCandlesticks();
      await fetchOrderbook();
    }

    updateAll();
    setInterval(updateAll, 1200000); // 20 minutes en ms
  </script>
</body>
</html>
