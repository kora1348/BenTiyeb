<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Listings ‚Äî Jour n¬∞20 (4h intraday) (Binance Futures USDT-M PERP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ok:#10b981; --bad:#ef4444; --text:#e5e7eb; --border:#1f2937; --warn:#f59e0b; --ink:#111827;}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:13px
    }
    header{padding:18px 16px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    main{max-width:980px;margin:18px auto;padding:0 12px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0;align-items:flex-end}
    label{font-size:12px}
    label span{display:block;margin-bottom:4px;font-size:11px}
    select,button{
      background:#0b1220;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px 10px;
      font-size:12px
    }
    button{cursor:pointer}
    .btn-danger{border-color:#3b1d1d;background:#1a0e0e}
    #status{font-size:11px}
    #nCalendar{font-size:12px;margin-left:auto}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      position:relative
    }
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      text-align:right;
      vertical-align:top
    }
    th:first-child,td:first-child{text-align:left}
    .up{color:var(--ok);font-weight:600}
    .down{color:var(--bad);font-weight:600}
    .muted{color:var(--muted)}
    .error{color:var(--bad);margin-top:8px}
    .hint{font-size:11px;color:var(--muted);margin-top:8px}
    .badge{
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px
    }
    .right{position:absolute;top:-70px;right:12px}

    #homeBtn { color:white!important; border:1px solid var(--border); }
    #homeBtn a { color:white!important; text-decoration:none; display:block; }

    .candle-date-banner{
      margin:16px 0 6px;
      display:flex;
      justify-content:center;
      align-items:center;
      background:#facc15;
      color:#111827;
      border:1px solid #f59e0b;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      font-size:18px;
      letter-spacing:.5px;
    }

    .dupe-card{margin:16px 0 10px;background:#0f1222;border:1px solid #23324a}
    .dupe-title{display:flex;gap:8px;align-items:center;margin-bottom:8px;font-weight:700}
    .dupe-pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      margin:4px 6px 0 0;
      font-size:12px
    }
    .dupe-pill.positive{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08)}
    .dupe-pill.negative{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
    .dupe-month{margin-top:8px}
    .dupe-empty{font-size:12px;color:var(--muted)}
    .dupe-month h4{margin:8px 0 6px;font-size:13px;color:#d1d5db}
  </style>
</head>
<body>
  <header>
    <h1 id="h1">Listings en janvier ‚Ä¢ Jour n¬∞<span id="nLabel">20</span> (4h intraday)</h1>
    <div class="sub">March√© analys√© : <b>Binance Futures ‚Äî USDT-M PERP</b></div>
  </header>

  <main>
    <div class="controls">
      <label>
        <span class="muted">Ann√©e (affich√©e +1)</span>
        <select id="yearSel"></select>
      </label>
      <label>
        <span class="muted">Mois (listing)</span>
        <select id="monthSel"></select>
      </label>
      <label>
        <span class="muted">Jour n¬∞ apr√®s listing (daily)</span>
        <select id="candleSel"></select>
      </label>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="runBtn">Run</button>
        <button id="clearBtn" class="btn-danger">üóëÔ∏è Effacer</button>
        <button id="homeBtn"><a href="/index.html">Accueil</a></button>
        <span id="status" class="muted"></span>
      </div>

      <div class="muted" id="nCalendar">
        Jour n¬∞<b><span id="nCalN">20</span></b> ‚Äî <b><span id="nCalDate">‚Äî</span></b>
      </div>
    </div>

    <div id="dupeCard" class="card dupe-card" style="display:none">
      <div class="dupe-title">
        üö® <span>Dates r√©p√©t√©es avec la m√™me polarit√© ‚Äî Jour n¬∞<span id="dupeN">‚Äî</span> (4h)</span>
      </div>
      <div id="dupeContent"></div>
    </div>

    <div class="card">
      <div class="right badge"><span id="progress">‚Äî</span></div>

      <table>
        <thead>
          <tr>
            <th style="width:160px">Symbole</th>
            <th style="width:230px">Date &amp; heure (bougies 4h du jour N) (Europe/Brussels)</th>
            <th style="width:150px">Taux de Variation de la bougie 4h</th>
            <th style="width:230px">Date &amp; heure (bougies 4h du jour N) &gt; 1 an apr√®s</th>
            <th style="width:150px">Variation de la bougie 4h &gt; 1 an apr√®s</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div id="err" class="error"></div>
      <div class="hint" id="hint">
        1. On d√©tecte les listings avec les <b>bougies daily (1d)</b> depuis <code>startTime=0</code>.<br>
        2. On garde les PERP dont le <b>jour de listing</b> (en Europe/Brussels) est dans le mois/ann√©e choisis.<br>
        3. <b>Jour n¬∞<span id="hintN">20</span></b> = bougie daily n¬∞<span id="hintN2">20</span> apr√®s le listing.<br>
        4. Pour ce jour n¬∞<span id="hintN3">20</span>, on r√©cup√®re <b>toutes les bougies 4 heures de la journ√©e</b> et on affiche leur variation 4h.<br>
        5. La carte üö® affiche, par mois, les heures (00:00, 04:00, 08:00, ‚Ä¶) qui apparaissent sur au moins 2 dates diff√©rentes avec la m√™me polarit√© (en 4h).
      </div>

      <div id="candleDateBanner" class="candle-date-banner">‚Äî</div>
    </div>
  </main>

  <script>
    const tz='Europe/Brussels';
    const yearSel   = document.getElementById('yearSel');
    const monthSel  = document.getElementById('monthSel');
    const candleSel = document.getElementById('candleSel');
    const runBtn    = document.getElementById('runBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const statusEl  = document.getElementById('status');
    const progressEl= document.getElementById('progress');
    const tbody     = document.getElementById('tbody');
    const errEl     = document.getElementById('err');

    const nLabel = document.getElementById('nLabel');
    const hintN  = document.getElementById('hintN');
    const hintN2 = document.getElementById('hintN2');
    const hintN3 = document.getElementById('hintN3');

    const nCalN    = document.getElementById('nCalN');
    const nCalDate = document.getElementById('nCalDate');

    const candleDateBanner = document.getElementById('candleDateBanner');

    const dupeCard = document.getElementById('dupeCard');
    const dupeContent = document.getElementById('dupeContent');
    const dupeN = document.getElementById('dupeN');

    const dayMs = 24*60*60*1000;
    const BANNER_BASE_MS = Date.UTC(2025, 9, 9, 0, 0, 0);
    const ALL_MONTHS = [0,1,2,3,4,5,6,7,8,9,10,11];

    let refListingMs = null;
    let lastRows = [];

    const CACHE = {
      symbols: null,
      daily100: new Map(),
      monthRows: new Map(),
      dailyComputed: new Map(),
      fiveMByDay: new Map(),
      fiveMComputed: new Map(),
      fiveMByDayPlusOneYear: new Map(),
    };

    const keyMonth       = (Y,M)=>`${Y}-${M}`;
    const keyDailyKey    = (Y,M,N)=>`${Y}-${M}-${N}`;
    const keyFiveMKey    = (Y,M,N)=>`${Y}-${M}-${N}`;

    function formatShortFrDate(ms){
      const d = new Date(ms);
      return new Intl.DateTimeFormat('fr-BE',{
        timeZone:tz,
        year:'2-digit',
        month:'2-digit',
        day:'2-digit'
      }).format(d);
    }

    function toBrusselsDate(ms){
      const d = new Date(ms);
      return new Intl.DateTimeFormat('fr-BE',{
        timeZone:tz,
        year:'numeric',
        month:'2-digit',
        day:'2-digit',
        hour:'2-digit',
        minute:'2-digit'
      }).format(d);
    }

    function monthYearInBrussels(ms){
      const d = new Date(
        new Intl.DateTimeFormat('en-CA',{
          timeZone:tz,
          year:'numeric',
          month:'2-digit',
          day:'2-digit'
        }).format(new Date(ms))+'T00:00:00'
      );
      return { y: d.getUTCFullYear(), m: d.getUTCMonth() };
    }

    function plusThanOneYear(ms){
      const d=new Date(ms);
      d.setUTCFullYear(d.getUTCFullYear()+1);
      return d.getTime()+1;
    }

    const fmtPct = n => (n>=0?'+':'') + n.toFixed(4) + ' %';

    const dateKeyBrussels = (ms)=> new Intl.DateTimeFormat('en-CA',{
      timeZone:tz,
      year:'numeric',
      month:'2-digit',
      day:'2-digit'
    }).format(new Date(ms));

    const dateKeyHuman = (ms)=> new Intl.DateTimeFormat('fr-BE',{
      timeZone:tz,
      year:'2-digit',
      month:'2-digit',
      day:'2-digit'
    }).format(new Date(ms));

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status} ‚Äî ${await r.text()}`);
      return r.json();
    }

    async function mapLimit(items, limit, worker){
      const ret=[]; let i=0, active=0, done=0;
      return new Promise(resolve=>{
        const next=()=>{
          while(active<limit && i<items.length){
            const idx=i++, it=items[idx]; active++;
            Promise.resolve(worker(it,idx))
              .then(res=>{ ret[idx]=res; })
              .catch(()=>{ ret[idx]=null; })
              .finally(()=>{
                active--; done++;
                progressEl.textContent = `${done}/${items.length}`;
                if(done===items.length) resolve(ret);
                else next();
              });
          }
        };
        next();
      });
    }

    async function getSymbolsOnce(){
      if (CACHE.symbols) return CACHE.symbols;
      const ex = await fetchJSON('https://fapi.binance.com/fapi/v1/exchangeInfo');
      CACHE.symbols = (ex.symbols||[])
        .filter(s => s.contractType==='PERPETUAL' && s.quoteAsset==='USDT' && s.status==='TRADING')
        .map(s => s.symbol);
      return CACHE.symbols;
    }

    async function getDaily100(sym){
      if (CACHE.daily100.has(sym)) return CACHE.daily100.get(sym);
      const u=new URL('https://fapi.binance.com/fapi/v1/klines');
      u.searchParams.set('symbol',sym);
      u.searchParams.set('interval','1d');
      u.searchParams.set('limit','100');
      u.searchParams.set('startTime','0');
      const kl = await fetchJSON(u.toString());
      CACHE.daily100.set(sym, kl||[]);
      return kl||[];
    }

    async function getFiveMForDay(sym, openTimeN){
      const key = `${sym}-${openTimeN}`;
      if (CACHE.fiveMByDay.has(key)) return CACHE.fiveMByDay.get(key);
      const end = openTimeN + dayMs;
      const u=new URL('https://fapi.binance.com/fapi/v1/klines');
      u.searchParams.set('symbol',sym);
      u.searchParams.set('interval','4h');
      u.searchParams.set('limit','10');
      u.searchParams.set('startTime', String(openTimeN));
      u.searchParams.set('endTime',   String(end));
      const kl = await fetchJSON(u.toString());
      CACHE.fiveMByDay.set(key, kl||[]);
      return kl||[];
    }

    async function getFiveMForDayPlusOneYear(sym, openTimeNPlusOneYear){
      const key = `${sym}-${openTimeNPlusOneYear}`;
      if (CACHE.fiveMByDayPlusOneYear.has(key)) return CACHE.fiveMByDayPlusOneYear.get(key);
      const end = openTimeNPlusOneYear + dayMs;
      const u=new URL('https://fapi.binance.com/fapi/v1/klines');
      u.searchParams.set('symbol',sym);
      u.searchParams.set('interval','4h');
      u.searchParams.set('limit','10');
      u.searchParams.set('startTime', String(openTimeNPlusOneYear));
      u.searchParams.set('endTime',   String(end));
      const kl = await fetchJSON(u.toString());
      CACHE.fiveMByDayPlusOneYear.set(key, kl||[]);
      return kl||[];
    }

    async function warmMonth(Y,M){
      const k = keyMonth(Y,M);
      if (CACHE.monthRows.has(k)) return CACHE.monthRows.get(k);

      const symbols = await getSymbolsOnce();
      statusEl.textContent = `Pr√©paration du mois ${String(M+1).padStart(2,'0')}/${Y}‚Ä¶`;
      progressEl.textContent = '‚Äî';

      const rows = await mapLimit(symbols, 8, async (sym)=>{
        try{
          const kl100 = await getDaily100(sym);
          if(!kl100.length) return null;
          const openTime1 = kl100[0][0];
          const {y,m} = monthYearInBrussels(openTime1);
          if (y!==Y || m!==M) return null;
          return { sym, openTime1, daily: kl100 };
        }catch{
          return null;
        }
      });

      const kept = rows.filter(Boolean);
      CACHE.monthRows.set(k, kept);
      return kept;
    }

    async function computeDailyRows(Y,M,N){
      const kc = keyDailyKey(Y,M,N);
      if (CACHE.dailyComputed.has(kc)) return CACHE.dailyComputed.get(kc);

      const base = CACHE.monthRows.get(keyMonth(Y,M)) || [];
      if(!base.length){
        CACHE.dailyComputed.set(kc, []);
        return [];
      }

      const rows = base.map(r=>{
        const kl = r.daily;
        let openTimeN = null, pctN = null;
        if (kl.length >= N){
          const kN = kl[N-1];
          openTimeN = kN[0];
          const o=parseFloat(kN[1]);
          const c=parseFloat(kN[4]);
          pctN = o>0 ? ((c-o)/o*100) : 0;
        }
        return {
          sym: r.sym,
          openTime1: r.openTime1,
          openTimeN,
          pctN
        };
      });

      rows.sort((a,b)=>{
        if (a.openTimeN && b.openTimeN) return a.openTimeN - b.openTimeN;
        if (a.openTimeN) return -1;
        if (b.openTimeN) return 1;
        return a.sym.localeCompare(b.sym);
      });

      CACHE.dailyComputed.set(kc, rows);
      return rows;
    }

    async function computeFiveMRows(Y,M,N){
      const kc = keyFiveMKey(Y,M,N);
      if (CACHE.fiveMComputed.has(kc)) return CACHE.fiveMComputed.get(kc);

      const dailyRows = await computeDailyRows(Y,M,N);
      if(!dailyRows.length){
        CACHE.fiveMComputed.set(kc, []);
        return [];
      }

      const allRows = [];

      await mapLimit(dailyRows, 4, async (dr)=>{
        if (!dr.openTimeN) return;
        try{
          const kl5 = await getFiveMForDay(dr.sym, dr.openTimeN);
          const openTimeNPlusOneYear = plusThanOneYear(dr.openTimeN);
          const kl5PlusOneYear = await getFiveMForDayPlusOneYear(dr.sym, openTimeNPlusOneYear);

          (kl5||[]).forEach(k=>{
            const openTime5m = k[0];
            if (openTime5m >= dr.openTimeN + dayMs) return;
            const o = parseFloat(k[1]);
            const c = parseFloat(k[4]);
            const pct = o>0 ? ((c-o)/o*100) : 0;

            const fiveMPlusOneYear = (kl5PlusOneYear||[]).find(k2 => {
              const date1 = new Date(openTime5m);
              const date2 = new Date(k2[0]);
              return date1.getUTCHours() === date2.getUTCHours() && 
                     date1.getUTCMinutes() === date2.getUTCMinutes();
            });

            let pctPlusOneYear = null;
            let openTime5mPlusOneYear = null;
            
            if (fiveMPlusOneYear) {
              openTime5mPlusOneYear = fiveMPlusOneYear[0];
              const o2 = parseFloat(fiveMPlusOneYear[1]);
              const c2 = parseFloat(fiveMPlusOneYear[4]);
              pctPlusOneYear = o2>0 ? ((c2-o2)/o2*100) : 0;
            }

            allRows.push({
              sym: dr.sym,
              openTime5m,
              pct5m: pct,
              openTime5mPlusOneYear,
              pct5mPlusOneYear: pctPlusOneYear
            });
          });
        }catch{
        }
      });

      allRows.sort((a,b)=>{
        if (a.sym !== b.sym) return a.sym.localeCompare(b.sym);
        return a.openTime5m - b.openTime5m;
      });

      CACHE.fiveMComputed.set(kc, allRows);
      return allRows;
    }

    function renderTable(rows){
      tbody.innerHTML='';
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Aucun nouveau PERP USDT-M list√© pour les crit√®res choisis.</td></tr>`;
      } else {
        const frag = document.createDocumentFragment();
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.sym}</td>
            <td>${toBrusselsDate(r.openTime5m)}</td>
            <td><span class="${r.pct5m>=0?'up':'down'}">${fmtPct(r.pct5m)}</span></td>
            <td>${r.openTime5mPlusOneYear ? toBrusselsDate(r.openTime5mPlusOneYear) : '‚Äî'}</td>
            <td>${r.pct5mPlusOneYear !== null ? `<span class="${r.pct5mPlusOneYear>=0?'up':'down'}">${fmtPct(r.pct5mPlusOneYear)}</span>` : '‚Äî'}</td>
          `;
          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
      }
    }

    function updateBannerOnly(){
      const n = parseInt(candleSel.value,10);
      const ms = BANNER_BASE_MS + (n-20)*dayMs;
      candleDateBanner.textContent = formatShortFrDate(ms);
    }

    function updateNCalendar(){
      const n = parseInt(candleSel.value,10);
      nCalN.textContent = n;
      const ms = BANNER_BASE_MS + (n-20)*dayMs;
      nCalDate.textContent = new Intl.DateTimeFormat('fr-BE', {
        timeZone: tz,
        day: '2-digit',
        month: '2-digit',
        year: '2-digit'
      }).format(ms);
    }

    function updateLabels(){
      const n = parseInt(candleSel.value,10);
      nLabel.textContent = n;
      if (hintN)  hintN.textContent  = n;
      if (hintN2) hintN2.textContent = n;
      if (hintN3) hintN3.textContent = n;
      document.title = `Listings ‚Äî Jour n¬∞${n} (4h intraday) (Binance Futures USDT-M PERP)`;
      updateNCalendar();
      updateBannerOnly();
    }

    async function updateDupeCard(){
      const Y = parseInt(yearSel.value,10);
      const N = parseInt(candleSel.value,10);
      dupeN.textContent = N;

      const monthNamesLong = [
        'janvier','f√©vrier','mars','avril','mai','juin',
        'juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'
      ];

      const report = [];

      for (const M of ALL_MONTHS) {
        const fiveMRows = await computeFiveMRows(Y, M, N);
        if (!fiveMRows.length) continue;

        const mapTimes = new Map();

        fiveMRows.forEach(row => {
          if (row.pct5m === null) return;

          const d = new Date(row.openTime5m);
          const hm = new Intl.DateTimeFormat('fr-BE',{
            timeZone: tz,
            hour:'2-digit',
            minute:'2-digit',
            hour12:false
          }).format(d);

          const dateStr = dateKeyHuman(row.openTime5m);

          if (!mapTimes.has(hm)) {
            mapTimes.set(hm, { 
              pos: new Map(),
              neg: new Map()
            });
          }
          const bag = mapTimes.get(hm);

          if (row.pct5m > 0) {
            if (!bag.pos.has(dateStr)) bag.pos.set(dateStr, new Set());
            bag.pos.get(dateStr).add(row.sym);
          } else if (row.pct5m < 0) {
            if (!bag.neg.has(dateStr)) bag.neg.set(dateStr, new Set());
            bag.neg.get(dateStr).add(row.sym);
          }
        });

        const dupes = [];

        for (const [hm, bag] of mapTimes.entries()) {
          const posDates = [...bag.pos.keys()];
          const negDates = [...bag.neg.keys()];

          if (posDates.length >= 2 && negDates.length === 0) {
            const dateSymbols = posDates.map(dateStr => ({
              date: dateStr,
              symbols: [...bag.pos.get(dateStr)]
            }));
            
            dateSymbols.sort((a, b) => {
              const [dayA, monthA, yearA] = a.date.split('/').map(Number);
              const [dayB, monthB, yearB] = b.date.split('/').map(Number);
              const dateA = new Date(2000 + yearA, monthA - 1, dayA);
              const dateB = new Date(2000 + yearB, monthB - 1, dayB);
              return dateA - dateB;
            });

            dupes.push({
              hourMin: hm,
              sign: 'positive',
              dateSymbols: dateSymbols
            });
          }
          else if (negDates.length >= 2 && posDates.length === 0) {
            const dateSymbols = negDates.map(dateStr => ({
              date: dateStr,
              symbols: [...bag.neg.get(dateStr)]
            }));
            
            dateSymbols.sort((a, b) => {
              const [dayA, monthA, yearA] = a.date.split('/').map(Number);
              const [dayB, monthB, yearB] = b.date.split('/').map(Number);
              const dateA = new Date(2000 + yearA, monthA - 1, dayA);
              const dateB = new Date(2000 + yearB, monthB - 1, dayB);
              return dateA - dateB;
            });

            dupes.push({
              hourMin: hm,
              sign: 'negative',
              dateSymbols: dateSymbols
            });
          }
        }

        dupes.sort((a,b)=> a.hourMin.localeCompare(b.hourMin));

        report.push({
          month: M,
          monthLabel: monthNamesLong[M],
          dupes
        });
      }

      dupeContent.innerHTML = '';

      const hasAnyHour = report.some(block => block.dupes && block.dupes.length > 0);
      if (!hasAnyHour) {
        dupeCard.style.display = 'none';
        return;
      }

      report.forEach(block => {
        if (!block.dupes || !block.dupes.length) return;

        const div = document.createElement('div');
        div.className = 'dupe-month';
        div.innerHTML = `<h4>${block.monthLabel}</h4>`;
        const wrap = document.createElement('div');

        let displayedCount = 0;

        block.dupes.forEach(d => {
          d.dateSymbols.forEach(dateSymbol => {
            if (dateSymbol.symbols.length >= 2) {
              const pill = document.createElement('span');
              pill.className = `dupe-pill ${d.sign === 'positive' ? 'positive' : 'negative'}`;
              
              const symbolCount = dateSymbol.symbols.length;
              const symbolText = dateSymbol.symbols.join(', ');
              pill.textContent = `${dateSymbol.date} ${d.hourMin} ‚Ä¢ ${d.sign === 'positive' ? 'Haussi√®re' : 'Baissi√®re'} ‚Ä¢ x${symbolCount} ${symbolText}`;
              pill.title = `${dateSymbol.date} ${d.hourMin} ‚Ä¢ ${d.sign === 'positive' ? 'Haussi√®re' : 'Baissi√®re'} ‚Ä¢ ${symbolCount} symboles`;

              wrap.appendChild(pill);
              displayedCount++;
            }
          });
        });

        if (displayedCount > 0) {
          div.appendChild(wrap);
          dupeContent.appendChild(div);
        }
      });

      dupeCard.style.display = 'block';
    }

    async function buildAndRenderCurrent(Y,M,N){
      const rows5m = await computeFiveMRows(Y,M,N);
      if (rows5m.length){
        const dailyRows = await computeDailyRows(Y,M,N);
        if (dailyRows.length){
          refListingMs = dailyRows.reduce(
            (min, r) => r.openTime1 && r.openTime1 < min ? r.openTime1 : min,
            Number.POSITIVE_INFINITY
          );
        }else{
          refListingMs = null;
        }
      }else{
        refListingMs = null;
      }

      lastRows = rows5m;
      renderTable(rows5m);
      updateLabels();
      updateNCalendar();
    }

    async function run(){
      errEl.textContent=''; tbody.innerHTML=''; progressEl.textContent='‚Äî';
      lastRows=[]; refListingMs=null;

      const Y = parseInt(yearSel.value,10);
      const M = parseInt(monthSel.value,10);
      const N = parseInt(candleSel.value,10);

      try{
        statusEl.textContent = 'Chargement initial (une seule fois)‚Ä¶';
        await warmMonth(Y,M);
        Promise.allSettled(ALL_MONTHS.filter(mm=>mm!==M).map(mm=>warmMonth(Y,mm)));

        statusEl.textContent = `Calcul local pour jour N=${N} (4h)‚Ä¶`;
        await buildAndRenderCurrent(Y,M,N);
        await updateDupeCard();

        statusEl.textContent = `Termin√© (cache) ‚Äî ${lastRows.length} bougie(s) 4h ‚Ä¢ Jour n¬∞${N} ‚Ä¢ ${String(M+1).padStart(2,'0')}/${Y}`;
      }catch(e){
        console.error(e);
        errEl.textContent='Erreur: '+e.message;
        statusEl.textContent='';
      }
    }

    function clearAll(){
      CACHE.symbols = null;
      CACHE.daily100.clear();
      CACHE.monthRows.clear();
      CACHE.dailyComputed.clear();
      CACHE.fiveMByDay.clear();
      CACHE.fiveMComputed.clear();
      CACHE.fiveMByDayPlusOneYear.clear();

      lastRows = [];
      refListingMs = null;
      tbody.innerHTML = '';
      dupeContent.innerHTML = '';
      dupeCard.style.display = 'none';
      errEl.textContent = '';
      progressEl.textContent = '‚Äî';
      nCalDate.textContent = '‚Äî';
      candleDateBanner.textContent = '‚Äî';

      updateLabels();
      statusEl.textContent = 'Tout effac√© ‚Äî s√©lectionne tes param√®tres puis clique Run.';
    }

    async function tryFastRender(){
      const Y = parseInt(yearSel.value,10);
      const M = parseInt(monthSel.value,10);
      const N = parseInt(candleSel.value,10);

      if (CACHE.monthRows.has(keyMonth(Y,M))){
        statusEl.textContent = 'Recalcul rapide depuis le cache‚Ä¶';
        await buildAndRenderCurrent(Y,M,N);
        await updateDupeCard();
        statusEl.textContent = `OK (cache) ‚Ä¢ ${lastRows.length} bougie(s) 4h`;
      }else{
        statusEl.textContent = 'Param√®tres modifi√©s ‚Äî cliquez sur Run (premier chargement seulement)';
      }
    }

    (function initSelectors(){
  const years=[2024];
  years.forEach(y=>{
    const o=document.createElement('option');
    o.value=String(y);
    o.textContent=String(y+1);
    o.dataset.realYear=y;
    yearSel.appendChild(o);
  });
  yearSel.value='2024';

  const allMonths = [
    {label:'01 Jan', value:0},
    {label:'02 F√©v', value:1},
    {label:'03 Mar', value:2},
    {label:'04 Avr', value:3},
    {label:'05 Mai', value:4},
    {label:'06 Jun', value:5},
    {label:'07 Jul', value:6},
    {label:'08 Ao√ª', value:7},
    {label:'09 Sep', value:8},
    {label:'10 Oct', value:9},
    {label:'11 Nov', value:10},
    {label:'12 D√©c', value:11}
  ];
  
  allMonths.forEach(({label,value})=>{
    const o=document.createElement('option');
    o.value=value;
    o.textContent=label;
    monthSel.appendChild(o);
  });
  monthSel.value=0;

  const today = new Date();
  const todayMs = today.getTime();
  const diffDays = Math.round((todayMs - BANNER_BASE_MS) / dayMs);
  const nFromDate = 20 + diffDays;
  const defaultN = Math.max(1, Math.min(100, nFromDate));

  for(let n=1;n<=100;n++){
    const o=document.createElement('option');
    o.value=n;
    o.textContent=String(n);
    candleSel.appendChild(o);
  }
  
  candleSel.value = String(defaultN);

  updateLabels();
  updateNCalendar();
  updateBannerOnly();
})();

    candleSel.addEventListener('change', async ()=>{
      updateLabels();
      await tryFastRender();
    });
    yearSel.addEventListener('change', tryFastRender);
    monthSel.addEventListener('change', tryFastRender);

    runBtn.addEventListener('click', run);
    clearBtn.addEventListener('click', clearAll);

    const h1 = document.getElementById('h1');
    const monthNames = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
    const updateHeader = () => {
      h1.innerHTML = `Listings en ${monthNames[+monthSel.value]} ‚Ä¢ Jour n¬∞<span id="nLabel">${candleSel.value}</span> (4h intraday)`;
    };
    monthSel.addEventListener('change', updateHeader);
    candleSel.addEventListener('change', updateHeader);
    updateHeader();
  </script>
</body>
</html>