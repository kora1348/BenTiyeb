<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>5m â€” Variations multi-dates (heure Belgique)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
      color:#111
    }
    .container{
      background:#fff;
      border-radius:20px;
      padding:24px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      max-width:1400px;
      width:100%
    }
    header{
      display:flex;
      gap:12px;
      align-items:baseline;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:16px
    }
    h1{font-size:22px}
    .sub{color:#4f46e5;font-weight:700}
    .bar-wrap{
      width:100%;
      background:#e5e7eb;
      border-radius:10px;
      height:26px;
      overflow:hidden;
      margin:12px 0
    }
    .bar{
      height:100%;
      background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      font-size:12px;
      width:0%
    }
    button{
      padding:10px 14px;
      background:linear-gradient(135deg,#10b981 0%,#059669 100%);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      border-radius:10px;
      overflow:hidden
    }
    thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    th,td{
      padding:12px 10px;
      text-align:center;
      border-bottom:1px solid #eee;
      font-size:14px
    }
    tbody tr:hover{background:#f8f9fa}
    .symbol{font-weight:700}
    .pos{color:#16a34a;font-weight:700}
    .neg{color:#dc2626;font-weight:700}
    .muted{color:#9ca3af}
    .error{
      background:#fee;
      border:1px solid #fcc;
      color:#b91c1c;
      padding:12px;
      border-radius:10px;
      margin-top:12px
    }
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tag{
      background:#eef2ff;
      color:#3730a3;
      border:1px solid #c7d2fe;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:700
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}

    /* Ligne Total */
    .total-row{
      background:#111827;
      color:#fff;
      font-weight:700;
    }
    .total-row td{
      border-top:2px solid #4b5563;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ðŸ“Š Variations 5m â€” PERP USDT-M (dates prÃ©configurÃ©es)</h1>
        <div id="subtitle" class="sub"></div>
        <div class="row">
          <span class="tag">Intervalle : 5m</span>
          <span id="datesTag" class="tag"></span>
        </div>
      </div>
      <div class="controls">
        <button id="runBtn">ðŸ”„ Run (toutes les dates)</button>
      </div>
    </header>

    <div class="bar-wrap" id="barWrap" style="display:none">
      <div class="bar" id="bar">0%</div>
    </div>

    <div id="content">
      <div class="muted">
        Clique sur <b>Run</b> pour charger les variations 5m pour toutes les dates/heures suivantes (Europe/Brussels) :<br>
        14/10/2025 23:35 ; 15/10/2025 09:45 ; 19/10/2025 12:50 ; 23/10/2025 22:05 ; 28/10/2025 03:15 ; 31/10/2025 01:20 ;<br>
        10/11/2025 15:50 ; 15/11/2025 01:15, 05:55, 19:40 ; 16/11/2025 10:30 ; 17/11/2025 10:10 ; 21/11/2025 16:50 ; 26/11/2025 20:20.
      </div>
    </div>

    <div id="errorBox" class="error" style="display:none"></div>
  </div>

  <script>
    // ========================
    // CONFIG
    // ========================
    const API = 'https://fapi.binance.com';
    const INTERVAL = '5m';
    const INTERVAL_MS = 5 * 60 * 1000;

    // Dates/heures fixes en Europe/Brussels
    const SNAPSHOTS = [
      { y:2025,m:10,d:14,hh:23,mm:35, label:'14/10/2025 23:35' },
      { y:2025,m:10,d:15,hh: 9,mm:45, label:'15/10/2025 09:45' },
      { y:2025,m:10,d:19,hh:12,mm:50, label:'19/10/2025 12:50' },
      { y:2025,m:10,d:23,hh:22,mm: 5, label:'23/10/2025 22:05' },
      { y:2025,m:10,d:28,hh: 3,mm:15, label:'28/10/2025 03:15' },
      { y:2025,m:10,d:31,hh: 1,mm:20, label:'31/10/2025 01:20' },
      { y:2025,m:11,d:10,hh:15,mm:50, label:'10/11/2025 15:50' },
      { y:2025,m:11,d:15,hh: 1,mm:15, label:'15/11/2025 01:15' },
      { y:2025,m:11,d:15,hh: 5,mm:55, label:'15/11/2025 05:55' },
      { y:2025,m:11,d:15,hh:19,mm:40, label:'15/11/2025 19:40' },
      { y:2025,m:11,d:16,hh:10,mm:30, label:'16/11/2025 10:30' },
      { y:2025,m:11,d:17,hh:10,mm:10, label:'17/11/2025 10:10' },
      { y:2025,m:11,d:21,hh:16,mm:50, label:'21/11/2025 16:50' },
      { y:2025,m:11,d:26,hh:20,mm:20, label:'26/11/2025 20:20' }
    ];

    // --- Liste fournie des tickers (USDT-M PERP) ---
    const SYMBOLS = [
     "ARIAUSDT", "BRADUST", "CORIAUSDT", "HUSDT", "MERLUSDT"
    ];

    // ========================
    // TIMEZONE HELPERS (Europe/Brussels -> UTC)
    // ========================
    const ZONE = 'Europe/Brussels';

    function tzOffsetMinutesAt(utcMs, timeZone){
      const dtf = new Intl.DateTimeFormat('en-US', {
        timeZone, hour12:false,
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
      const parts = dtf.formatToParts(new Date(utcMs));
      const map = {};
      for (const {type, value} of parts) map[type] = value;
      const asUTC = Date.UTC(map.year, map.month-1, map.day, map.hour, map.minute, map.second);
      return (asUTC - utcMs) / 60000;
    }

    // Convertit Y-M-D H:M exprimÃ©s en heure "Europe/Brussels" vers epoch UTC (ms).
    function localBelgiumToUtcMs(y, m, d, hh, mm){
      let guess = Date.UTC(y, m-1, d, hh, mm);
      for (let i=0;i<3;i++){
        const offMin = tzOffsetMinutesAt(guess, ZONE);
        guess = Date.UTC(y, m-1, d, hh, mm) - offMin*60000;
      }
      return guess;
    }

    // PrÃ©-calcul UTC pour toutes les dates
    SNAPSHOTS.forEach(s => {
      s.openUtcMs = localBelgiumToUtcMs(s.y, s.m, s.d, s.hh, s.mm);
      s.endUtcMs  = s.openUtcMs + INTERVAL_MS - 1;
    });

    // ========================
    // NETWORK + RENDER
    // ========================
    function pLimit(concurrency){
      const queue = []; let active = 0;
      const next = () => {
        if (!queue.length || active >= concurrency) return;
        active++;
        const { fn, resolve, reject } = queue.shift();
        Promise.resolve().then(fn).then(
          v => { active--; resolve(v); next(); },
          e => { active--; reject(e); next(); }
        );
      };
      return fn => new Promise((resolve, reject)=>{ queue.push({fn,resolve,reject}); next(); });
    }

    async function getKlineAt(symbol, startMs, endMs){
      const url = `${API}/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&startTime=${startMs}&endTime=${endMs}&limit=1`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`Klines ${symbol}: ${res.status}`);
      const arr = await res.json();
      return arr[0] || null; // [ openTime, open, high, low, close, ... ]
    }

    function variationFromKline(k){
      const open = parseFloat(k[1]);
      const close = parseFloat(k[4]);
      return ((close - open) / open) * 100;
    }

    function setBar(pct){
      const barWrap = document.getElementById('barWrap');
      const bar = document.getElementById('bar');
      barWrap.style.display = 'block';
      bar.style.width = `${pct}%`;
      bar.textContent = `${pct}%`;
    }

    function showError(msg){
      const box = document.getElementById('errorBox');
      box.style.display = 'block';
      box.textContent = msg;
    }
    function clearError(){
      const box = document.getElementById('errorBox');
      box.style.display = 'none';
      box.textContent = '';
    }

    function pad2(n){ return String(n).padStart(2,'0'); }

    function updateHeader(){
      const first = SNAPSHOTS[0];
      const last  = SNAPSHOTS[SNAPSHOTS.length-1];
      const subtitle = document.getElementById('subtitle');
      subtitle.innerHTML =
        `Bougies 5m prÃ©configurÃ©es du <strong>${pad2(first.d)}/${pad2(first.m)}/${first.y} ${pad2(first.hh)}:${pad2(first.mm)}</strong>`+
        ` au <strong>${pad2(last.d)}/${pad2(last.m)}/${last.y} ${pad2(last.hh)}:${pad2(last.mm)}</strong> (Europe/Brussels)`;

      const datesTag = document.getElementById('datesTag');
      datesTag.textContent = `${SNAPSHOTS.length} date(s)/heure(s)`;

      document.title = '5m â€” Variations multi-dates (heure Belgique)';
    }

    // Rendu du tableau + TOTAL par date
    function renderTable(resultsMap){
      const rows = Array.from(resultsMap.values());
      const headCols = SNAPSHOTS
        .map(s => `<th>${s.label} (5m)</th>`)
        .join('');

      // Totaux par date (colonne)
      const totals = Array(SNAPSHOTS.length).fill(0);
      const counts = Array(SNAPSHOTS.length).fill(0);

      let html = `
        <table>
          <thead>
            <tr>
              <th>Symbole</th>
              ${headCols}
            </tr>
          </thead>
          <tbody>
      `;

      // Lignes par symbole
      for(const row of rows){
        html += `<tr><td class="symbol">${row.symbol}</td>`;
        row.values.forEach((v, idx) => {
          if (typeof v === 'number'){
            const cls = v >= 0 ? 'pos' : 'neg';
            const sign = v >= 0 ? '+' : '';
            html += `<td class="${cls}">${sign}${v.toFixed(2)}%</td>`;
            totals[idx] += v;
            counts[idx]++;
          } else {
            html += `<td class="muted">N/A</td>`;
          }
        });
        html += `</tr>`;
      }

      // Ligne TOTAL (somme des variations par date)
      html += `<tr class="total-row"><td>Total</td>`;
      totals.forEach((sum, idx) => {
        if (counts[idx] > 0){
          const cls = sum >= 0 ? 'pos' : 'neg';
          const sign = sum >= 0 ? '+' : '';
          html += `<td class="${cls}">${sign}${sum.toFixed(2)}%</td>`;
        } else {
          html += `<td class="muted">N/A</td>`;
        }
      });
      html += `</tr>`;

      html += `</tbody></table>`;
      document.getElementById('content').innerHTML = html;
    }

    // ========================
    // RUN BTN
    // ========================
    document.getElementById('runBtn').addEventListener('click', async ()=>{
      clearError();

      const totalRequests = SYMBOLS.length * SNAPSHOTS.length;
      const limit = pLimit(8);
      let done = 0;

      document.getElementById('content').innerHTML =
        `<div class="muted">Chargement des variations (${SYMBOLS.length} paires Ã— ${SNAPSHOTS.length} dates)â€¦</div>`;
      document.getElementById('runBtn').disabled = true;
      setBar(0);

      const resultsMap = new Map(); // symbol -> { symbol, values: [] }

      try{
        const tasks = [];

        SNAPSHOTS.forEach((snap, snapIndex) => {
          SYMBOLS.forEach(sym => {
            tasks.push(
              limit(async ()=>{
                try{
                  const k = await getKlineAt(sym, snap.openUtcMs, snap.endUtcMs);
                  const v = k ? variationFromKline(k) : null;

                  if (!resultsMap.has(sym)){
                    resultsMap.set(sym, { symbol:sym, values:Array(SNAPSHOTS.length).fill(null) });
                  }
                  resultsMap.get(sym).values[snapIndex] = v;
                }catch(e){
                  if (!resultsMap.has(sym)){
                    resultsMap.set(sym, { symbol:sym, values:Array(SNAPSHOTS.length).fill(null) });
                  }
                }finally{
                  done++;
                  setBar(Math.round((done/totalRequests)*100));
                }
              })
            );
          });
        });

        await Promise.all(tasks);
        renderTable(resultsMap);
      }catch(err){
        showError(`Erreur: ${err.message || err}`);
      }finally{
        document.getElementById('runBtn').disabled = false;
      }
    });

    // Init
    updateHeader();
  </script>
</body>
</html>
