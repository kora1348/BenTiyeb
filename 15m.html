<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Variations ‚Äî Binance Futures Perp (Movers 24h LIVE)</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5}
    h2{margin:0 0 6px}
    .status{margin:0 0 10px;font-weight:700}
    .status.negative{color:#dc2626}
    .status.positive{color:#16a34a}

    .card{margin:12px 0 14px;padding:14px;border-radius:10px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.10)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .muted{color:#666;font-size:13px}
    table{background:#fff;border-collapse:collapse;width:100%}
    th{background:#fafafa}
    th,td{border:1px solid #ddd;padding:8px}
    .wrap{max-width:800px;margin:0 auto}

    select, input, button{font:inherit}
    button{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:10px;
      padding:7px 10px;
      cursor:pointer;
    }
    button:hover{background:#fafafa}

    .pill{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:#eef2ff;
      font-size:12px;
      color:#1f2a44;
      border:1px solid #e5e7eb;
    }

    .moversGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 700px){ .moversGrid{grid-template-columns:1fr} }
    .kpiRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
    .kpi{padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;font-weight:800;font-size:12px}
    .loadingLine{color:#6b7280;font-style:italic}
    
    .box{
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    .boxHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .boxHeader .tag{
      font-weight:800;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid transparent;
    }
    .tag.neg{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .tag.pos{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    
    .positive{color:#16a34a}
    .negative{color:#dc2626}
  </style>
</head>

<body class="wrap">

  <!-- CARD CONTROLES -->
  <div class="card">
    <div class="row">
      <div>
        <button class="prevBtn">Pr√©c√©dent</button>
        <button class="nextBtn">Suivant</button>

        &nbsp;|&nbsp;

        <label>
          Date :
          <input type="text" class="dateInput" placeholder="JJ/MM/AAAA" inputmode="numeric" style="width:120px" />
        </label>

        <button class="goDateBtn">OK</button>

        &nbsp;|&nbsp;

        <label class="muted">
          Movers LIVE (24h) - Futures USDT-M PERPETUAL
        </label>

        <button id="reloadBtn">Recharger</button>

        <span class="pill" id="shownCount">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- CARTE MOVERS UNIQUE -->
  <div id="moversCard"></div>

<script>
/* ========= CONFIG ========= */
const BASE_FUTURES = "https://fapi.binance.com";
const MOVERS_TOP_N = 4;
const MOVERS_QUOTE = "USDT"; // uniquement pairs ...USDT
const MOVERS_ABS_CLAMP = 0; // 0 pour d√©sactiver

const NOW = new Date();
const RANGE_START_UTC = new Date(Date.UTC(NOW.getUTCFullYear(), NOW.getUTCMonth(), NOW.getUTCDate(), 0,0,0,0));
const RANGE_END_UTC   = new Date(Date.UTC(2025, 10, 27, 0,0,0,0)); // 27/11/2025
let baseDateUtc = new Date(RANGE_START_UTC);

const STATUS_BY_DATE_FR = {
  "23/12/2025": { text: "negative", cls: "negative" },
  "22/12/2025": { text: "positif",  cls: "positive" },
  "21/12/2025": { text: "negative", cls: "negative" },
  "20/12/2025": { text: "positif",  cls: "positive" },
  "19/12/2025": { text: "negative", cls: "negative" },
  "18/12/2025": { text: "negative", cls: "negative" },
  "17/12/2025": { text: "negative", cls: "negative" },
  "16/12/2025": { text: "positif",  cls: "positive" },
  "15/12/2025": { text: "negative", cls: "negative" },
  "14/12/2025": { text: "negative", cls: "negative" },
  "13/12/2025": { text: "negative", cls: "negative" },
  "12/12/2025": { text: "negative", cls: "negative" },
};

/* ========= HELPERS ========= */
const pad2 = n => String(n).padStart(2, "0");
const toFr = d => `${pad2(d.getUTCDate())}/${pad2(d.getUTCMonth()+1)}/${d.getUTCFullYear()}`;
const fmtPct = v => `${v>0?"+":""}${v.toFixed(2)}%`;
function applyColor(el, v){ el.style.color = v>0 ? "#16a34a" : v<0 ? "#dc2626" : ""; }

function addDaysUtc(d, days){
  const x = new Date(d);
  x.setUTCDate(x.getUTCDate() + days);
  return new Date(Date.UTC(x.getUTCFullYear(), x.getUTCMonth(), x.getUTCDate(), 0,0,0,0));
}

function clampToFixedRange(d){
  const maxT = Math.max(RANGE_START_UTC.getTime(), RANGE_END_UTC.getTime());
  const minT = Math.min(RANGE_START_UTC.getTime(), RANGE_END_UTC.getTime());
  const t = d.getTime();
  if(t > maxT) return new Date(maxT);
  if(t < minT) return new Date(minT);
  return d;
}

function frToUtcDate(fr){
  const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(String(fr || "").trim());
  if(!m) return null;
  const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
  if(mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;
  const dt = new Date(Date.UTC(yy, mm-1, dd, 0,0,0,0));
  if(isNaN(dt.getTime())) return null;
  if(dt.getUTCFullYear() !== yy || (dt.getUTCMonth()+1) !== mm || dt.getUTCDate() !== dd) return null;
  return dt;
}

/* ========= MOVERS: USDT-M PERPETUAL ONLY ========= */
let perpUsdtSetPromise = null;

async function getPerpUsdtSet(){
  if(perpUsdtSetPromise) return perpUsdtSetPromise;

  perpUsdtSetPromise = (async ()=>{
    const url = `${BASE_FUTURES}/fapi/v1/exchangeInfo`;
    const r = await fetch(url);
    if(!r.ok) throw new Error(`exchangeInfo -> HTTP ${r.status}`);
    const json = await r.json();
    const all = Array.isArray(json?.symbols) ? json.symbols : [];
    const set = new Set();

    for(const s of all){
      if(!s) continue;
      if(s.status !== "TRADING") continue;
      if(s.contractType !== "PERPETUAL") continue;     // ‚úÖ PERPETUAL
      if(s.quoteAsset !== MOVERS_QUOTE) continue;      // ‚úÖ USDT
      set.add(s.symbol);
    }
    return set;
  })();

  return perpUsdtSetPromise;
}

async function fetchMovers24hPerp(){
  const [perpSet] = await Promise.all([getPerpUsdtSet()]);
  const url = `${BASE_FUTURES}/fapi/v1/ticker/24hr`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`ticker/24hr -> HTTP ${r.status}`);
  const arr = await r.json();
  if(!Array.isArray(arr)) throw new Error(`ticker/24hr -> r√©ponse invalide`);

  const rows = [];
  for(const it of arr){
    const sym = String(it?.symbol || "");
    if(!perpSet.has(sym)) continue;                    // ‚úÖ filtre PERPETUAL+USDT
    const v = Number(it?.priceChangePercent);
    if(!isFinite(v)) continue;
    if(MOVERS_ABS_CLAMP > 0 && Math.abs(v) > MOVERS_ABS_CLAMP) continue;
    rows.push({ sym, v });
  }
  return { rows, totalPerp: perpSet.size };
}

/* ========= UI CARDS ========= */
function createMoversCard(dateUtc){
  const fr = toFr(dateUtc);
  const st = STATUS_BY_DATE_FR[fr];

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.polarity = st ? st.cls : "unknown";

  const h2 = document.createElement("h2");
  h2.textContent = `üìà Movers (24h LIVE) ‚Äî ${fr} ‚Äî Futures USDT-M PERPETUAL (TOP ${MOVERS_TOP_N} / FLOP ${MOVERS_TOP_N})`;
  card.appendChild(h2);

  const kpi = document.createElement("div");
  kpi.className = "kpiRow";
  kpi.innerHTML = `
    <span class="kpi" data-role="market">Market: FUTURES PERP</span>
    <span class="kpi" data-role="count">Paires PERP USDT: ‚Äî</span>
    <span class="kpi" data-role="note">Source: fapi ticker/24hr</span>
  `;
  card.appendChild(kpi);

  if(st){
    const p = document.createElement("div");
    p.className = `status ${st.cls}`;
    p.textContent = st.text;
    card.appendChild(p);
  }else{
    const p = document.createElement("div");
    p.className = "muted small";
    p.textContent = "(polarit√© non d√©finie)";
    card.appendChild(p);
  }

  const wrap = document.createElement("div");
  wrap.className = "moversGrid";

  const topBox = document.createElement("div");
  topBox.className = "box";
  topBox.innerHTML = `
    <div class="boxHeader">
      <span>Top ${MOVERS_TOP_N} (24h)</span>
      <span class="tag pos">HAUT</span>
    </div>
    <table>
      <thead><tr><th>Symbol</th><th>Var 24h</th></tr></thead>
      <tbody data-role="top"><tr><td colspan="2" class="loadingLine">‚è≥ Chargement‚Ä¶</td></tr></tbody>
    </table>
  `;

  const flopBox = document.createElement("div");
  flopBox.className = "box";
  flopBox.innerHTML = `
    <div class="boxHeader">
      <span>Flop ${MOVERS_TOP_N} (24h)</span>
      <span class="tag neg">BAS</span>
    </div>
    <table>
      <thead><tr><th>Symbol</th><th>Var 24h</th></tr></thead>
      <tbody data-role="flop"><tr><td colspan="2" class="loadingLine">‚è≥ Chargement‚Ä¶</td></tr></tbody>
    </table>
  `;

  wrap.appendChild(topBox);
  wrap.appendChild(flopBox);
  card.appendChild(wrap);

  return {
    card,
    elCount:  kpi.querySelector('[data-role="count"]'),
    topTbody: topBox.querySelector('tbody[data-role="top"]'),
    flopTbody: flopBox.querySelector('tbody[data-role="flop"]'),
  };
}

async function fillMoversForDate(_dateUtc, ui){
  // ticker/24hr = LIVE (pas historique) mais on l'affiche dans la grille multi-jours.
  const { rows, totalPerp } = await fetchMovers24hPerp();
  ui.elCount.textContent = `Paires PERP USDT: ${rows.length}/${totalPerp}`;

  rows.sort((a,b)=> b.v - a.v);
  const top = rows.slice(0, MOVERS_TOP_N);
  const flop = rows.slice(-MOVERS_TOP_N).sort((a,b)=> a.v - b.v);

  ui.topTbody.innerHTML = "";
  for(const it of top){
    const tr = document.createElement("tr");
    const tdS = document.createElement("td");
    const tdV = document.createElement("td");
    tdS.textContent = it.sym;
    tdV.textContent = fmtPct(it.v);
    applyColor(tdV, it.v);
    tr.appendChild(tdS); tr.appendChild(tdV);
    ui.topTbody.appendChild(tr);
  }

  ui.flopTbody.innerHTML = "";
  for(const it of flop){
    const tr = document.createElement("tr");
    const tdS = document.createElement("td");
    const tdV = document.createElement("td");
    tdS.textContent = it.sym;
    tdV.textContent = fmtPct(it.v);
    applyColor(tdV, it.v);
    tr.appendChild(tdS); tr.appendChild(tdV);
    ui.flopTbody.appendChild(tr);
  }
}

/* ========= RENDER ========= */
async function refreshMovers(){
  baseDateUtc = clampToFixedRange(baseDateUtc);
  const moversWrap = document.getElementById("moversCard");
  moversWrap.innerHTML = "";

  document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));

  const fr = toFr(baseDateUtc);
  document.getElementById("shownCount").textContent = `Date: ${fr}`;

  // Cr√©er et afficher la carte des movers
  const movers = createMoversCard(baseDateUtc);
  moversWrap.appendChild(movers.card);
  
  try {
    await fillMoversForDate(baseDateUtc, movers);
  } catch(err) {
    console.error(err);
    movers.topTbody.innerHTML = `<tr><td colspan="2">Erreur de chargement</td></tr>`;
    movers.flopTbody.innerHTML = `<tr><td colspan="2">Erreur de chargement</td></tr>`;
    movers.elCount.textContent = "Paires PERP USDT: Erreur";
  }
}

/* ========= EVENTS ========= */
document.querySelectorAll(".prevBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    baseDateUtc = addDaysUtc(baseDateUtc, -1);
    baseDateUtc = clampToFixedRange(baseDateUtc);
    await refreshMovers();
  });
});

document.querySelectorAll(".nextBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    baseDateUtc = addDaysUtc(baseDateUtc, 1);
    baseDateUtc = clampToFixedRange(baseDateUtc);
    await refreshMovers();
  });
});

document.querySelectorAll(".goDateBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    const wrap = btn.parentElement;
    const inp = wrap.querySelector(".dateInput");
    const dt = frToUtcDate(inp.value);
    if(!dt){
      alert("Date invalide. Format JJ/MM/AAAA (ex: 23/12/2025).");
      return;
    }
    baseDateUtc = clampToFixedRange(new Date(dt));
    await refreshMovers();
  });
});

document.querySelectorAll(".dateInput").forEach(inp => {
  inp.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      const btn = inp.parentElement.parentElement.querySelector(".goDateBtn");
      if(btn) btn.click();
    }
  });
});

document.getElementById("reloadBtn").addEventListener("click", refreshMovers);

/* ========= INIT ========= */
document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
refreshMovers();
</script>

</body>
</html>