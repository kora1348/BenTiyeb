<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Historique mensuel 2022 Binance</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background-color: #eee; }
#progressContainer {
  width: 100%;
  background-color: #ddd;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 10px;
}
#progressBar {
  height: 20px;
  width: 0%;
  background-color: #4caf50;
  text-align: center;
  color: white;
  font-size: 12px;
  line-height: 20px;
  transition: width 0.3s ease;
}
#cryptoCard {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  background-color: #f9f9f9;
}
</style>
</head>
<body>
<h2>Taux de variation mensuels pour 2022</h2>
<div id="progressContainer">
  <div id="progressBar">0%</div>
</div>
<div id="cryptoCard">
  <h3>Moyenne</h3>
  <div id="cryptoCardContent"></div>
</div>
<table>
<thead>
<tr>
  <th>Crypto</th>
  <th>Janvier</th>
  <th>Février</th>
  <th>Mars</th>
  <th>Avril</th>
  <th>Mai</th>
  <th>Juin</th>
  <th>Juillet</th>
  <th>Août</th>
  <th>Septembre</th>
  <th>Octobre</th>
  <th>Novembre</th>
  <th>Décembre</th>
  <th>Total</th>
  <th>Moyenne</th>
</tr>
</thead>
<tbody id="cryptoTableBody"></tbody>
</table>
<script>
async function fetchUsdtSymbols() {
  const resp = await fetch('https://api.binance.com/api/v3/exchangeInfo');
  if (!resp.ok) throw new Error('Erreur récupération exchangeInfo');
  const data = await resp.json();
  return data.symbols
    .filter(s => s.status === 'TRADING' && s.symbol.endsWith('USDT') && s.isSpotTradingAllowed)
    .map(s => s.symbol);
}

async function fetchDailyKlines(symbol) {
  const startTime = new Date("2022-01-01T00:00:00Z").getTime();
  const endTime = new Date("2022-12-31T23:59:59Z").getTime();
  const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&startTime=${startTime}&endTime=${endTime}&limit=1000`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Erreur API pour ${symbol} : ${resp.status}`);
  return resp.json();
}

function updateProgress(current, total) {
  const progressBar = document.getElementById('progressBar');
  const percent = Math.round((current / total) * 100);
  progressBar.style.width = percent + '%';
  progressBar.textContent = percent + '%';
}

function calculateMonthlyVariations(klines) {
  const monthlyVariations = new Array(12).fill(null);
  const monthlyFirstDays = [0];
  for (let i = 1; i < klines.length; i++) {
    const currentDate = new Date(klines[i][0]);
    const prevDate = new Date(klines[i - 1][0]);
    if (currentDate.getMonth() !== prevDate.getMonth()) {
      monthlyFirstDays.push(i);
    }
  }
  for (let i = 0; i < 12; i++) {
    const startIndex = monthlyFirstDays[i];
    const endIndex = monthlyFirstDays[i + 1] || klines.length;
    if (startIndex === undefined || endIndex === undefined || startIndex >= klines.length) {
      continue;
    }
    const startPrice = parseFloat(klines[startIndex][1]);
    const endPrice = parseFloat(klines[endIndex - 1][4]);
    if (startPrice && endPrice) {
      monthlyVariations[i] = ((endPrice - startPrice) / startPrice) * 100;
    }
  }
  return monthlyVariations;
}

async function main() {
  const tbody = document.getElementById('cryptoTableBody');
  const cryptoCardContent = document.getElementById('cryptoCardContent');
  tbody.innerHTML = '';
  cryptoCardContent.innerHTML = '';
  let rowsData = [];
  let cryptoCardData = [];

  try {
    const symbols = await fetchUsdtSymbols();
    const total = symbols.length;
    let processed = 0;

    for (const symbol of symbols) {
      try {
        const klines = await fetchDailyKlines(symbol);
        if (klines.length < 2) {
          processed++;
          updateProgress(processed, total);
          continue;
        }

        const monthlyVariations = calculateMonthlyVariations(klines);
        const validVariations = monthlyVariations.filter(variation => variation !== null);
        const totalVariation = validVariations.reduce((sum, variation) => sum + variation, 0);
        const averageVariation = validVariations.length > 0 ? totalVariation / validVariations.length : 0;

        if (averageVariation >= 70 && averageVariation < 80) {
          cryptoCardData.push({ symbol, averageVariation });
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${symbol}</td>
          ${monthlyVariations.map(variation => `
            <td>${variation !== null ? variation.toFixed(2) + '%' : 'N/A'}</td>
          `).join('')}
          <td>${totalVariation.toFixed(2)}%</td>
          <td>${averageVariation.toFixed(2)}%</td>
        `;

        rowsData.push(row);
      } catch (e) {
        console.error(e.message);
      }

      processed++;
      updateProgress(processed, total);
    }

    cryptoCardData.sort((a, b) => a.symbol.localeCompare(b.symbol));
    cryptoCardData.forEach(data => {
      cryptoCardContent.innerHTML += `${data.symbol} : ${data.averageVariation.toFixed(2)}%<br>`;
    });

    rowsData.sort((a, b) => a.innerText.localeCompare(b.innerText));
    rowsData.forEach(row => tbody.appendChild(row));

  } catch (e) {
    console.error('Erreur :', e.message);
  }
}

main();
</script>
</body>
</html>
