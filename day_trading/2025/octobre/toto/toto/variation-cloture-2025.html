<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bougie 23:18 (3m) â€“ 07/10, 09/10, 10/10/2025</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
      .container{background:white;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:1400px;width:100%}
      h1{text-align:center;color:#333;margin-bottom:8px;font-size:26px}
      .subtitle{text-align:center;color:#555;margin-bottom:24px}
      table{width:100%;border-collapse:collapse;margin-bottom:20px;background:white;border-radius:10px;overflow:hidden}
      thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
      th{padding:14px 10px;text-align:center;font-weight:bold;font-size:14px}
      td{padding:14px 10px;text-align:center;border-bottom:1px solid #eee;font-size:14px}
      tbody tr:last-child td{border-bottom:none}
      tbody tr:hover{background:#f8f9fa}
      .symbol{font-weight:bold;color:#333;text-align:left}
      .positive{color:#22c55e;font-weight:bold}
      .negative{color:#ef4444;font-weight:bold}
      .na{color:#9ca3af}
      .loading{text-align:center;color:#666;padding:20px}
      .error{background:#fee;border:1px solid #fcc;color:#b91c1c;padding:15px;border-radius:10px;margin-bottom:20px}
      button{width:100%;padding:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:transform .2s;margin-top:8px}
      button:hover{transform:translateY(-2px)}
      button:disabled{opacity:.5;cursor:not-allowed}
      .progress-container{width:100%;background:#e5e7eb;border-radius:10px;height:28px;overflow:hidden;margin-bottom:16px;box-shadow:inset 0 2px 4px rgba(0,0,0,.1)}
      .progress-bar{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);border-radius:10px;transition:width .3s ease;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:12px}
      .meta{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
      .badge{background:#eef2ff;color:#4338ca;border:1px solid #c7d2fe;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
      .foot{color:#6b7280;font-size:12px;text-align:center;margin-top:8px}
      .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:14px}
      @media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}
      .card{border:1px solid #eee;border-radius:12px;padding:12px}
      .card h3{font-size:14px;margin-bottom:8px;color:#374151}
      .pill{display:inline-block;background:#f3f4f6;border:1px solid #e5e7eb;color:#111827;border-radius:999px;padding:4px 8px;font-size:12px;margin:2px}
      tfoot td{font-weight:bold;background:#f3f4f6;border-top:2px solid #667eea}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ“Š Taux de variation â€“ 3m â€“ Bougie 23:18</h1>
      <div class="subtitle">Dates ciblÃ©es : <strong>07/10/2025</strong>, <strong>09/10/2025</strong>, <strong>10/10/2025</strong> (heure locale Bruxelles â†’ 23:18)</div>

      <div class="meta">
        <span class="badge">Exchange time: UTC</span>
        <span class="badge">Local (Bruxelles): UTC+2 (oct. 2025)</span>
        <span class="badge">23:18 locale = 21:18 UTC</span>
        <span class="badge">Interval: 3m</span>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Symboles (Ã©ditables dans le code)</h3>
          <div id="symbolsView"></div>
        </div>
        <div class="card">
          <h3>Cibles</h3>
          <span class="pill">Heure locale visÃ©e: 23:18</span>
          <span class="pill">Heure UTC visÃ©e: 21:18</span>
          <span class="pill">FenÃªtre: [t, t+3min)</span>
        </div>
      </div>

      <div id="progressContainer" style="display:none;">
        <div class="progress-container">
          <div id="progressBar" class="progress-bar" style="width:0%;">0%</div>
        </div>
      </div>

      <div id="content"><div class="loading">Chargement des donnÃ©esâ€¦</div></div>

      <button id="refreshBtn" onclick="fetchData()">ðŸ”„ Actualiser</button>
      <div class="foot">Astuce : change <code>LOCAL_TZ_OFFSET_MINUTES</code> si besoin (DST).</div>
    </div>

    <script>
      // =========================
      // ParamÃ¨tres principaux
      // =========================
      const TARGET_LOCAL_HH = 23;   // heure locale (Bruxelles)
      const TARGET_LOCAL_MM = 18;   // minute locale
      const LOCAL_TZ_OFFSET_MINUTES = 120; // Bruxelles en oct. 2025 = UTC+2 => 120

      // Dates Ã  analyser (format JJ/MM/AAAA)
      const TARGET_DATES_FR = ["07/10/2025", "09/10/2025", "10/10/2025"];

      // Symboles Futures USDT-M
      const symbols = [
        "AEVOUSDT","ARPAUSDT","AXLUSDT","DIAUSDT","EGLDUSDT","IDUSDT","RONINUSDT","WLDUSDT",
        "1000SATSUSDT","1000LUNCUSDT","ANKRUSDT","DENTUSDT","ENJUSDT","NXPCUSDT"
      ];

      const API = 'https://fapi.binance.com';
      const U = s => s.trim().toUpperCase();
      const pad2 = n => String(n).padStart(2,'0');

      function parseFRDate(fr){ // "DD/MM/YYYY" -> {y,m,d}
        const [dd, mm, yyyy] = fr.split('/').map(Number);
        return { y: yyyy, m: mm, d: dd };
      }

      // 23:18 locale -> 21:18 UTC aux dates concernÃ©es (UTC = Local - offset)
      function localToUTCms(y, m, d, hhLocal, mmLocal, tzOffsetMin){
        return Date.UTC(y, m-1, d, hhLocal, mmLocal) - tzOffsetMin*60*1000;
      }

      // RÃ©cupÃ¨re **la bougie 3m exacte** qui s'ouvre Ã  targetUTCms
      async function get3mCandleAt(symbol, targetUTCms){
        const startTime = targetUTCms;
        const endTime   = targetUTCms + 3*60*1000;
        const url = `${API}/fapi/v1/klines?symbol=${U(symbol)}&interval=3m&startTime=${startTime}&endTime=${endTime}&limit=1`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API ${symbol} (3m) status ${res.status}`);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) return null;
        const k = data[0];
        if (Number(k[0]) !== targetUTCms) return null; // vÃ©rification stricte
        return k;
      }

      function variationPct(kline){
        const open = parseFloat(kline[1]);
        const close = parseFloat(kline[4]);
        return ((close - open) / open) * 100;
      }

      function renderSymbols(){
        const el = document.getElementById('symbolsView');
        el.innerHTML = symbols.map(s=>`<span class="pill">${U(s)}</span>`).join('');
      }

      function renderTableHeader(){
        return `
          <thead>
            <tr>
              <th style="text-align:left">Symbole</th>
              ${TARGET_DATES_FR.map(d=>`<th>${d}<br><small>23:18 (3m)</small></th>`).join('')}
            </tr>
          </thead>
        `;
      }

      function formatCell(v){
        if (v==null || !isFinite(v)) return `<td class="na">N/A</td>`;
        const cls = v>=0 ? 'positive' : 'negative';
        const sign = v>=0 ? '+' : '';
        return `<td class="${cls}">${sign}${v.toFixed(3)}%</td>`;
      }

      function renderRow(symbol, values){
        return `<tr><td class="symbol">${U(symbol)}</td>${values.map(formatCell).join('')}</tr>`;
      }

      // -------- TOTAL uniquement (pas de moyenne)
      function renderTotalsOnly(rowsValues){
        const nDates = TARGET_DATES_FR.length;
        const sums   = new Array(nDates).fill(0);
        const counts = new Array(nDates).fill(0);

        rowsValues.forEach(vals=>{
          vals.forEach((v, i)=>{
            if (v!=null && isFinite(v)){
              sums[i] += v;
              counts[i] += 1;
            }
          });
        });

        let tfoot = `<tfoot><tr><td class="symbol">TOTAL</td>`;
        tfoot += sums.map((s,i)=>{
          if (!counts[i]) return `<td class="na">N/A</td>`;
          const cls = s>=0 ? 'positive' : 'negative';
          const sign = s>=0 ? '+' : '';
          return `<td class="${cls}">${sign}${s.toFixed(3)}%</td>`;
        }).join('');
        tfoot += `</tr></tfoot>`;
        return tfoot;
      }

      async function fetchData(){
        renderSymbols();

        const content = document.getElementById('content');
        const btn = document.getElementById('refreshBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        btn.disabled = true;
        content.innerHTML = '';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        try{
          // Timestamps UTC visÃ©s (23:18 locale -> 21:18 UTC)
          const targetUTCmsByDate = TARGET_DATES_FR.map(fr=>{
            const {y,m,d} = parseFRDate(fr);
            return localToUTCms(y,m,d, TARGET_LOCAL_HH, TARGET_LOCAL_MM, LOCAL_TZ_OFFSET_MINUTES);
          });

          const totalRequests = symbols.length * targetUTCmsByDate.length;
          let completed = 0;

          const allRows = []; // {symbol, vals:number[]|null[]}
          for (const sym of symbols){
            const vals = [];
            for (const tms of targetUTCmsByDate){
              try{
                const k = await get3mCandleAt(sym, tms);
                vals.push(k ? variationPct(k) : null);
              }catch{
                vals.push(null);
              }finally{
                completed++;
                const p = Math.round(completed*100/totalRequests);
                progressBar.style.width = p + '%';
                progressBar.textContent = p + '%';
              }
            }
            allRows.push({ symbol: sym, vals });
          }

          progressContainer.style.display = 'none';

          // ===== Table =====
          let html = `<table>${renderTableHeader()}<tbody>`;
          for (const row of allRows){
            html += renderRow(row.symbol, row.vals);
          }
          html += `</tbody>`;
          html += renderTotalsOnly(allRows.map(r=>r.vals));
          html += `</table>`;

          content.innerHTML = html;

        } catch(err){
          progressContainer.style.display = 'none';
          content.innerHTML = `<div class="error"><strong>Erreur :</strong> ${err.message}</div>`;
        } finally{
          btn.disabled = false;
        }
      }

      // Lancer
      fetchData();
    </script>
  </body>
</html>
