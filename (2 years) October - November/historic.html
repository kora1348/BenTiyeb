<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Historique Binance - Variation sur 2 ans</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background-color: #eee; }
  #progressContainer {
    width: 100%;
    background-color: #ddd;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 10px;
  }
  #progressBar {
    height: 20px;
    width: 0%;
    background-color: #4caf50;
    text-align: center;
    color: white;
    font-size: 12px;
    line-height: 20px;
    transition: width 0.3s ease;
  }
  #alertsContainer { display: flex; gap: 20px; margin-top: 20px; }
  #alertGreen, #alertRed {
    flex: 1;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
    background: #fafafa;
    min-height: 60px;
  }
  #alertGreen h3, #alertRed h3 { margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 6px; }
  #alertGreen div { color: green; margin-bottom: 4px; word-wrap: break-word; }
  #alertRed div { color: red; margin-bottom: 4px; word-wrap: break-word; }
  .small { font-size: 12px; color: #666; margin-top: 6px; }
</style>
</head>
<body>

<h2>Variation sur 2 ans</h2>

<div id="progressContainer">
  <div id="progressBar">0%</div>
</div>

<div id="alertsContainer">
  <div id="alertGreen">
    <h3>Variations entre -70% et -78% (Vert)</h3>
  </div>
  <div id="alertRed">
    <h3>Variations ≥ 10000% (Rouge)</h3>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Crypto</th>
      <th>Années comparées</th>
      <th>Taux de variation sur 2 ans (%)</th>
      <th>Clôture décembre</th>
    </tr>
  </thead>
  <tbody id="cryptoTableBody"></tbody>
</table>

<script>
  async function fetchUsdtSymbols() {
    const resp = await fetch('https://api.binance.com/api/v3/exchangeInfo');
    if (!resp.ok) throw new Error('Erreur récupération exchangeInfo (' + resp.status + ')');
    const data = await resp.json();
    return data.symbols
      .filter(s => s.status === 'TRADING' && s.symbol.endsWith('USDT') && s.isSpotTradingAllowed)
      .map(s => s.symbol);
  }

  async function fetchMonthlyKlines(symbol) {
    const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1M&limit=1000`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`Erreur API (${resp.status}) pour ${symbol}`);
    return resp.json();
  }

  function updateProgress(current, total) {
    const progressBar = document.getElementById('progressBar');
    const percent = Math.round((current / total) * 100);
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
  }

  // format price: supprime les 0 inutiles à la fin
  function fmtPrice(p) {
    if (p == null || !isFinite(p)) return '-';
    // 8 décimales max, puis retire trailing zeros
    return parseFloat(p.toFixed(8)).toString();
  }

  async function main() {
    const alertGreenDiv = document.getElementById('alertGreen');
    const alertRedDiv = document.getElementById('alertRed');
    const tbody = document.getElementById('cryptoTableBody');

    tbody.innerHTML = '';
    alertGreenDiv.innerHTML = '<h3>Variations entre -70% et -78% (Vert)</h3>';
    alertRedDiv.innerHTML = '<h3>Variations ≥ 10000% (Rouge)</h3>';

    let alertsGreen = [];
    let alertsRed = [];

    try {
      let symbols = await fetchUsdtSymbols();
      symbols.sort(); // tri alphabétique

      const total = symbols.length;
      let processed = 0;

      for (const symbol of symbols) {
        try {
          const klines = await fetchMonthlyKlines(symbol);

          // Récupère les clôtures de décembre par année
          const closeDecByYear = {};
          for (const k of klines) {
            const [openTime, , , , close] = k;
            const date = new Date(openTime);
            if (date.getMonth() === 11) { // décembre
              closeDecByYear[date.getFullYear()] = parseFloat(close);
            }
          }

          const years = Object.keys(closeDecByYear).map(Number).sort((a,b)=>a-b);

          // On commence à i=2 pour avoir comparaison yearPrev2 -> yearCurrent (deux ans)
          for (let i = 2; i < years.length; i++) {
            const yearCurrent = years[i];
            const yearPrev2 = years[i - 2];

            const closeCurrent = closeDecByYear[yearCurrent];
            const closePrev2 = closeDecByYear[yearPrev2];

            // protège contre division par 0 / données manquantes
            if (closePrev2 == null || closePrev2 === 0 || !isFinite(closePrev2)) continue;
            if (closeCurrent == null || !isFinite(closeCurrent)) continue;

            const variation2Years = ((closeCurrent - closePrev2) / closePrev2) * 100;
            const variationFixed = variation2Years.toFixed(2);

            // alertes
            if (variation2Years >= -78 && variation2Years <= -70) {
              alertsGreen.push({ symbol, from: yearPrev2, to: yearCurrent, variation: variation2Years });
            }
            if (variation2Years >= 10000) {
              alertsRed.push({ symbol, from: yearPrev2, to: yearCurrent, variation: variation2Years });
            }

            const color = (variation2Years >= -78 && variation2Years <= -70) ? 'green'
                        : (variation2Years >= 10000 ? 'red' : 'inherit');

            tbody.insertAdjacentHTML('beforeend', `
              <tr>
                <td>${symbol}</td>
                <td>${yearPrev2} → ${yearCurrent}</td>
                <td style="color:${color}">${variationFixed}%</td>
                <td>${fmtPrice(closeCurrent)}</td>
              </tr>
            `);
          }
        } catch (e) {
          tbody.insertAdjacentHTML('beforeend', `<tr><td>${symbol}</td><td colspan="3" style="color:red;">Erreur: ${e.message}</td></tr>`);
        }

        processed++;
        updateProgress(processed, total);
      }

      // Affiche les alertes triées
      if (alertsGreen.length > 0) {
        alertsGreen.sort((a,b) => a.from - b.from || a.variation - b.variation);
        alertsGreen.forEach(a => {
          alertGreenDiv.insertAdjacentHTML('beforeend', `<div>${a.symbol} : ${a.variation.toFixed(2)}% (${a.from} → ${a.to})</div>`);
        });
      } else {
        alertGreenDiv.insertAdjacentHTML('beforeend', '<div>Aucune variation annuelle entre -70% et -78% détectée.</div>');
      }

      if (alertsRed.length > 0) {
        alertsRed.sort((a,b) => a.from - b.from || b.variation - a.variation);
        alertsRed.forEach(a => {
          alertRedDiv.insertAdjacentHTML('beforeend', `<div>${a.symbol} : ${a.variation.toFixed(2)}% (${a.from} → ${a.to})</div>`);
        });
      } else {
        alertRedDiv.insertAdjacentHTML('beforeend', '<div>Aucune variation ≥ 10000% détectée.</div>');
      }

    } catch (e) {
      alertGreenDiv.innerHTML = `<div style="color:red;">Erreur globale : ${e.message}</div>`;
      alertRedDiv.innerHTML = '';
      tbody.insertAdjacentHTML('beforeend', `<tr><td colspan="4" style="color:red;">Erreur globale : ${e.message}</td></tr>`);
    }
  }

  // Lance le script
  main();
</script>

</body>
</html>
