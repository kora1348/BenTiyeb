<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Spike max â€” </title>
    <style>
      /* mÃªmes styles que ton codeâ€¦ (inchangÃ©s) */
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
      .container{background:white;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:1400px;width:100%}
      h1{text-align:center;color:#333;margin-bottom:30px;font-size:28px}
      table{width:100%;border-collapse:collapse;margin-bottom:20px;background:white;border-radius:10px;overflow:hidden}
      thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
      th{padding:15px 10px;text-align:center;font-weight:bold;font-size:14px}
      td{padding:15px 10px;text-align:center;border-bottom:1px solid #eee;font-size:14px}
      tbody tr:last-child td{border-bottom:none}
      tbody tr:hover{background:#f8f9fa}
      .symbol{font-weight:bold;color:#333}
      .positive{color:#22c55e;font-weight:bold}
      .negative{color:#ef4444;font-weight:bold}
      .loading{text-align:center;color:#666;padding:20px}
      .error{background:#fee;border:1px solid #fcc;color:#c33;padding:15px;border-radius:10px;margin-bottom:20px}
      button{width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:transform .2s}
      button:hover{transform:translateY(-2px)}
      button:disabled{opacity:.5;cursor:not-allowed}
      .progress-container{width:100%;background:#e5e7eb;border-radius:10px;height:30px;overflow:hidden;margin-bottom:20px;box-shadow:inset 0 2px 4px rgba(0,0,0,.1)}
      .progress-bar{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);border-radius:10px;transition:width .3s ease;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px}
      .year-badge{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:12px;font-weight:bold;display:inline-block;margin-bottom:10px}
      .sub{color:#555;text-align:center;margin:-18px 0 18px 0;font-size:13px}
      .year-badge a{color:white;text-decoration:none}
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="pageTitle">ðŸ“Š Spike max (mÃ¨che haute) â€” Bougies Daily ?</h1>
      <div class="sub">Variation = <strong>(High âˆ’ Open) / Open Ã— 100</strong> â€” aucune clÃ´ture affichÃ©e</div>

      <div style="text-align:center;">
        <span class="year-badge"><a href="/index.html">AnnÃ©e 2025</a></span>
        <div style="margin-top:10px; margin-bottom: 10px;color:#667eea;font-weight:bold;font-size:16px;">
          ðŸ“… Date de rÃ©fÃ©rence : <span id="refDateDisplay"></span>
        </div>
      </div>

      <div id="progressContainer" style="display:none;">
        <div class="progress-container">
          <div id="progressBar" class="progress-bar" style="width:0%;">0%</div>
        </div>
      </div>

      <div id="content">
        <div class="loading">Chargement des donnÃ©es...</div>
      </div>

      <button id="refreshBtn" onclick="fetchData()">ðŸ”„ Actualiser</button>
            <p>R + V + V + V + V + V</p>
    </div>

    <script>
      // =========================
      // PARAMÃˆTRE MODIFIABLE â€” ta date de rÃ©fÃ©rence (JJ/MM/AAAA)
      // =========================
      const REF_DATE_FR = '26/10/2025';

      // =========================
      // LOGIQUE DÃ‰CALAGE AUTOMATIQUE DES 6 DATES
      // =========================
      const BASE_REF_FR = '26/10/2025';
      const BASE_DATES_FR = [
        '23/02/2025',
        '01/03/2025',
        '23/07/2025',
        '26/07/2025',
        '22/10/2025',
        '26/10/2025'
      ];

      // ========= Utils dates (UTC safe) =========
      const pad2 = n => String(n).padStart(2,'0');

      function parseFR(strFR){ // "JJ/MM/AAAA" -> Date UTC
        const [jj,mm,aaaa] = strFR.split('/').map(Number);
        return new Date(Date.UTC(aaaa, mm-1, jj));
      }
      function formatFR(d){ // Date -> "JJ/MM/AAAA"
        return `${pad2(d.getUTCDate())}/${pad2(d.getUTCMonth()+1)}/${d.getUTCFullYear()}`;
      }
      function formatISO(d){ // Date -> "YYYY-MM-DD"
        return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())}`;
      }
      function daysBetweenUTC(d1,d2){
        const ms = 24*60*60*1000;
        const t1 = Date.UTC(d1.getUTCFullYear(), d1.getUTCMonth(), d1.getUTCDate());
        const t2 = Date.UTC(d2.getUTCFullYear(), d2.getUTCMonth(), d2.getUTCDate());
        return Math.round((t2 - t1)/ms);
      }
      function addDaysUTC(d, n){
        const cp = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
        cp.setUTCDate(cp.getUTCDate() + n);
        return cp;
      }

      // Calcule les 6 dates (FR pour affichage + ISO pour API) en fonction de REF_DATE_FR
      function computeShiftedDates(){
        const baseRef = parseFR(BASE_REF_FR);
        const refSel  = parseFR(REF_DATE_FR);
        const delta   = daysBetweenUTC(baseRef, refSel);

        const datesFR = [];
        const datesISO = [];
        for (const fr of BASE_DATES_FR){
          const d0 = parseFR(fr);
          const d  = addDaysUTC(d0, delta);
          datesFR.push(formatFR(d));
          datesISO.push(formatISO(d));
        }
        return { datesFR, datesISO };
      }

      // ====== <title> / <h1> / "Date de rÃ©fÃ©rence" / nÂ° de bougie ======
      function ddmmyyyyToPartsFR(str){
        const [jj, mm, aaaa] = str.split('/').map(Number);
        return { jj, mm, aaaa };
      }
      function dateUTC(yyyy, mm, dd){
        return new Date(Date.UTC(yyyy, mm - 1, dd));
      }

      (function applyTitleH1AndRefDate(){
        // 20e bougie = 09/10/2025 (rÃ©fÃ©rence commune Ã  tes pages)
        const ref20 = dateUTC(2025, 10, 9);

        const { jj, mm, aaaa } = ddmmyyyyToPartsFR(REF_DATE_FR);
        const sel = dateUTC(aaaa, mm, jj);

        const delta = daysBetweenUTC(ref20, sel);
        const numeroBougie = 20 + delta;

        // <title> : "Spike max â€” JJ-MM-AA"
        const t = document.querySelector('title');
        if (t){
          const yy = String(aaaa).slice(-2);
          t.textContent = `Spike max â€” ${pad2(jj)}-${pad2(mm)}-${yy}`;
        }

        // <h1> : inclure le numÃ©ro de bougie
        const h1 = document.getElementById('pageTitle') || document.querySelector('h1');
        if (h1){
          h1.textContent = `ðŸ“Š Spike max (mÃ¨che haute) â€” Bougies Daily ${numeroBougie}`;
        }

        // ðŸ“… Date de rÃ©fÃ©rence (format JJ/MM/AAAA avec slashs)
        const refSpan = document.getElementById('refDateDisplay');
        if (refSpan){
          refSpan.textContent = `${pad2(jj)}/${pad2(mm)}/${aaaa}`;
        }
      })();

      // =========================
      // API FUTURES (USDT-M)
      // =========================
      const API = 'https://fapi.binance.com';
      const U = s => s.trim().toUpperCase();

      // RÃ©cupÃ¨re la bougie daily couvrant `dateISO` (UTC)
      async function getKline(symbol, dateISO) {
        const startOfDay = new Date(dateISO);
        startOfDay.setUTCHours(0,0,0,0);
        const endOfDay = new Date(dateISO);
        endOfDay.setUTCHours(23,59,59,999);

        const url = `${API}/fapi/v1/klines?symbol=${U(symbol)}&interval=1d&startTime=${startOfDay.getTime()}&endTime=${endOfDay.getTime()}&limit=1`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Erreur API pour ${symbol} (${res.status})`);
        const data = await res.json();
        return data[0]; // undefined si pas de donnÃ©e ce jour-lÃ 
      }

      // ðŸŸ¢ SPIKE MAX: (High âˆ’ Open) / Open Ã— 100
      function calcSpikeMaxPct(kline) {
        const open = parseFloat(kline[1]); // open
        const high = parseFloat(kline[2]); // high
        if (!isFinite(open) || open === 0 || !isFinite(high)) return null;
        return ((high - open) / open) * 100;
      }

      async function fetchData() {
        const content = document.getElementById('content');
        const btn = document.getElementById('refreshBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        btn.disabled = true;
        content.innerHTML = '';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        try {
          // Liste modifiable de symboles
          const symbols = [
            "AEVOUSDT","ARPAUSDT","AXLUSDT","DIAUSDT","EGLDUSDT","IDUSDT","RONINUSDT","WLDUSDT",
            "1000satsusdt","1000luncusdt","ANKRUSDT","DENTUSDT","ENJUSDT","NXPCUSDT"
          ].map(U);

          // ðŸ‘‰ 6 dates calculÃ©es automatiquement (FR pour header, ISO pour API)
          const { datesFR, datesISO } = computeShiftedDates();

          const totalRequests = symbols.length * datesISO.length;
          let completedRequests = 0;

          const allPromises = [];
          for (const symbol of symbols) {
            for (const dateISO of datesISO) {
              allPromises.push(
                getKline(symbol, dateISO)
                  .then(kline => {
                    completedRequests++;
                    const p = Math.round((completedRequests / totalRequests) * 100);
                    progressBar.style.width = p + '%';
                    progressBar.textContent = p + '%';
                    return kline ? calcSpikeMaxPct(kline) : null;
                  })
                  .catch(() => {
                    completedRequests++;
                    const p = Math.round((completedRequests / totalRequests) * 100);
                    progressBar.style.width = p + '%';
                    progressBar.textContent = p + '%';
                    return null; // non listÃ© / pas de data / rate-limit
                  })
              );
            }
          }

          const allVariations = await Promise.all(allPromises);

          // Regrouper par symbole
          const results = [];
          for (let i = 0; i < symbols.length; i++) {
            const variations = allVariations.slice(i * datesISO.length, (i + 1) * datesISO.length);
            results.push({ symbol: symbols[i], variations });
          }

          progressContainer.style.display = 'none';

          // ======== TABLE dynamique (entÃªtes = datesFR auto) ========
          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>Symbole</th>
                  ${datesFR.map(d=>`<th>${d}<br><small>Spike max â†‘</small></th>`).join('')}
                </tr>
              </thead>
              <tbody>
          `;

          // Totaux par colonne (somme des spikes max)
          const totals = new Array(datesISO.length).fill(0);
          const counts = new Array(datesISO.length).fill(0);

          results.forEach(r => {
            tableHTML += `<tr><td class="symbol">${r.symbol}</td>`;
            r.variations.forEach((v, idx) => {
              if (v === null || !isFinite(v)) {
                tableHTML += `<td style="color:#9ca3af;">N/A</td>`;
              } else {
                const cls = v >= 0 ? 'positive' : 'negative';
                const sign = v >= 0 ? '+' : '';
                tableHTML += `<td class="${cls}">${sign}${v.toFixed(2)}%</td>`;
                totals[idx] += v;
                counts[idx]++;
              }
            });
            tableHTML += `</tr>`;
          });

          // Ligne TOTAL
          tableHTML += `<tr style="background:#f3f4f6;font-weight:bold;border-top:3px solid #667eea;">`;
          tableHTML += `<td class="symbol">TOTAL (somme spikes max)</td>`;
          totals.forEach((total, idx) => {
            if (counts[idx] === 0) {
              tableHTML += `<td style="color:#9ca3af;">N/A</td>`;
            } else {
              const cls = total >= 0 ? 'positive' : 'negative';
              const sign = total >= 0 ? '+' : '';
              tableHTML += `<td class="${cls}">${sign}${total.toFixed(2)}%</td>`;
            }
          });
          tableHTML += `</tr>`;

          tableHTML += `</tbody></table>`;
          content.innerHTML = tableHTML;

        } catch (err) {
          progressContainer.style.display = 'none';
          content.innerHTML = `<div class="error"><strong>Erreur:</strong> ${err.message}</div>`;
        } finally {
          btn.disabled = false;
        }
      }

      // Go!
      fetchData();
    </script>
  </body>
</html>
