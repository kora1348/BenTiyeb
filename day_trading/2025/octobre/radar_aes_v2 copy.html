<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Listings ‚Äî Bougie 5m n¬∞20 (Binance Futures USDT-M PERP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ok:#10b981; --bad:#ef4444; --text:#e5e7eb; --border:#1f2937; --warn:#f59e0b; --ink:#111827;}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:18px 16px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    main{max-width:980px;margin:18px auto;padding:0 12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0;align-items:flex-end}
    label span{display:block;margin-bottom:6px}
    select,button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    .btn-danger{border-color:#3b1d1d;background:#1a0e0e}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;position:relative}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;text-align:right;vertical-align:top}
    th:first-child,td:first-child{text-align:left}
    .up{color:var(--ok);font-weight:600}
    .down{color:var(--bad);font-weight:600}
    .muted{color:var(--muted)}
    .error{color:var(--bad);margin-top:8px}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
    .right{position:absolute;top:12px;right:12px}

    /* Bouton Accueil en blanc */
    #homeBtn { color:white!important; border:1px solid var(--border); }
    #homeBtn a { color:white!important; text-decoration:none; display:block; }

    /* Banni√®re date/heure de la bougie (sous le tableau) */
    .candle-date-banner{
      margin:16px 0 6px; display:flex; justify-content:center; align-items:center;
      background:#facc15; color:#111827; border:1px solid #f59e0b; border-radius:12px;
      padding:10px 14px; font-weight:700; font-size:18px; letter-spacing:.5px;
    }

    /* Carte d‚Äôalerte ‚Äúdates en double avec m√™me polarit√©‚Äù */
    .dupe-card{margin:16px 0 10px;background:#0f1222;border:1px solid #23324a}
    .dupe-title{display:flex;gap:8px;align-items:center;margin-bottom:8px;font-weight:700}
    .dupe-pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px}
    .dupe-pill.positive{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08)}
    .dupe-pill.negative{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
    .dupe-month{margin-top:8px}
    .dupe-empty{font-size:12px;color:var(--muted)}
    .dupe-month h4{margin:8px 0 6px;font-size:13px;color:#d1d5db}
  </style>
</head>
<body>
  <header>
    <h1 id="h1">Listings en janvier ‚Ä¢ Bougie 5m n¬∞<span id="nLabel">20</span></h1>
    <div class="sub">March√© analys√© : <b>Binance Futures ‚Äî USDT-M PERP</b></div>
  </header>

  <main>
    <div class="controls">
      <label>
        <span class="muted">Ann√©e du listing (affich√©e +1)</span>
        <select id="yearSel"></select>
      </label>
      <label>
        <span class="muted">Mois du listing</span>
        <select id="monthSel"></select>
      </label>
      <label>
        <span class="muted">N¬∞ de bougie (5m)</span>
        <select id="candleSel"></select>
      </label>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="runBtn">Run</button>
        <button id="clearBtn" class="btn-danger">üóëÔ∏è Effacer</button>
        <button id="homeBtn"><a href="/index.html">Accueil</a></button>
        <span id="status" class="muted"></span>
      </div>

      <div class="muted" id="nCalendar" style="margin-left:auto">
        Bougie 5m n¬∞<b><span id="nCalN">20</span></b> ‚Äî <b><span id="nCalDate">‚Äî</span></b>
      </div>
    </div>

    <!-- Carte d'alerte -->
    <div id="dupeCard" class="card dupe-card" style="display:none">
      <div class="dupe-title">
        üö® <span>Dates r√©p√©t√©es avec la m√™me polarit√© ‚Äî Bougie 5m n¬∞<span id="dupeN">‚Äî</span></span>
      </div>
      <div id="dupeContent"></div>
    </div>

    <div class="card">
      <div class="right badge"><span id="progress">‚Äî</span></div>
      <table>
        <thead>
          <tr>
            <th style="width:180px">Symbole</th>
            <th style="width:260px">Date/heure bougie 5m n¬∞<span id="thN1">20</span> (Europe/Brussels)</th>
            <th style="width:260px">Date/heure &gt; 24 h apr√®s (Europe/Brussels)</th>
            <th style="width:170px">Variation bougie 5m n¬∞<span id="thN2">20</span></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="err" class="error"></div>
      <div class="hint" id="hint">
        D√©tection du listing : premi√®re bougie <b>5 minutes</b> disponible (<code>startTime=0</code>).<br>
        On conserve uniquement les cryptos dont le <b>jour de listing</b> (premi√®re bougie 5m) est dans le mois/ann√©e choisis.<br>
        Bougie 5m n¬∞<span id="hintN">20</span> = <span id="hintN2">20</span>-√®me intervalle de 5 minutes apr√®s la premi√®re bougie.<br>
        Variation = (Close ‚àí Open) / Open √ó 100.<br>
        La colonne ‚Äú&gt; 24 h apr√®s‚Äù = (bougie 5m n¬∞<span id="hintN3">20</span>) + 24 h (strictement &gt; 24 h).
      </div>

      <!-- Banni√®re de date/heure de la bougie, sous le tableau -->
      <div id="candleDateBanner" class="candle-date-banner">‚Äî</div>
    </div>
  </main>

  <script>
    // ====== DOM refs
    const tz='Europe/Brussels';
    const yearSel   = document.getElementById('yearSel');
    const monthSel  = document.getElementById('monthSel');
    const candleSel = document.getElementById('candleSel');
    const runBtn    = document.getElementById('runBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const statusEl  = document.getElementById('status');
    const progressEl= document.getElementById('progress');
    const tbody     = document.getElementById('tbody');
    const errEl     = document.getElementById('err');

    const nLabel = document.getElementById('nLabel');
    const thN1   = document.getElementById('thN1');
    const thN2   = document.getElementById('thN2');
    const hintN  = document.getElementById('hintN');
    const hintN2 = document.getElementById('hintN2');
    const hintN3 = document.getElementById('hintN3');

    const nCalN    = document.getElementById('nCalN');
    const nCalDate = document.getElementById('nCalDate');

    const candleDateBanner = document.getElementById('candleDateBanner');

    const dupeCard = document.getElementById('dupeCard');
    const dupeContent = document.getElementById('dupeContent');
    const dupeN = document.getElementById('dupeN');

    // ====== Consts
    const min5Ms = 5*60*1000;
    const dayMs  = 24*60*60*1000;
    const ALLOWED_MONTHS = [0,5,8]; // Jan, Jun, Sep

    let refListingMs = null;
    let lastRows = [];

    // ====== Caches
    const CACHE = {
      symbols: null,
      first60_5m: new Map(),   // sym -> 5m klines (limit 60) depuis le d√©but (startTime=0)
      monthRows: new Map(),    // `${Y}-${M}` -> [{sym, openTime1, m5_60}]
      computed: new Map(),     // `${Y}-${M}-${N}` -> rows
    };
    const keyMonth    = (Y,M)=>`${Y}-${M}`;
    const keyComputed = (Y,M,N)=>`${Y}-${M}-${N}`;

    // ====== Helpers
    function capitalizeFr(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
    function formatLongFrDateTime(ms){
      const d = new Date(ms);
      const date = new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'numeric',month:'long',day:'2-digit'}).format(d);
      const hm = new Intl.DateTimeFormat('fr-BE',{timeZone:tz,hour:'2-digit',minute:'2-digit'}).format(d);
      return `${capitalizeFr(date)} ‚Ä¢ ${hm}`;
    }
    function formatShortFrDateTime(ms){
      const d = new Date(ms);
      return new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d);
    }
    function toBrusselsDateTime(ms){
      const d = new Date(ms);
      return new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d);
    }
    function monthYearInBrussels(ms){
      const d = new Date(new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date(ms))+'T00:00:00');
      return { y: d.getUTCFullYear(), m: d.getUTCMonth() };
    }
    function plusThan24h(ms){ return ms + dayMs + 1; }
    const fmtPct = n => (n>=0?'+':'') + n.toFixed(4) + ' %';

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status} ‚Äî ${await r.text()}`);
      return r.json();
    }
    async function mapLimit(items, limit, worker){
      const ret=[]; let i=0, active=0, done=0;
      return new Promise(resolve=>{
        const next=()=>{
          while(active<limit && i<items.length){
            const idx=i++, it=items[idx]; active++;
            Promise.resolve(worker(it,idx))
            .then(res=>{ ret[idx]=res; })
            .catch(()=>{ ret[idx]=null; })
            .finally(()=>{
              active--; done++; progressEl.textContent = `${done}/${items.length}`;
              if(done===items.length) resolve(ret); else next();
            });
          }
        };
        next();
      });
    }

    // ====== Cache warmers
    async function getSymbolsOnce(){
      if (CACHE.symbols) return CACHE.symbols;
      const ex = await fetchJSON('https://fapi.binance.com/fapi/v1/exchangeInfo');
      CACHE.symbols = (ex.symbols||[])
        .filter(s => s.contractType==='PERPETUAL' && s.quoteAsset==='USDT' && s.status==='TRADING')
        .map(s => s.symbol);
      return CACHE.symbols;
    }

    // R√©cup√®re les 60 premi√®res bougies 5m (depuis l‚Äôorigine des donn√©es du symbole)
    async function getFirst60_5m(sym){
      if (CACHE.first60_5m.has(sym)) return CACHE.first60_5m.get(sym);
      const u=new URL('https://fapi.binance.com/fapi/v1/klines');
      u.searchParams.set('symbol',sym);
      u.searchParams.set('interval','5m');
      u.searchParams.set('limit','60');
      u.searchParams.set('startTime','0'); // renvoie depuis le tout d√©but de l‚Äôhistorique 5m du symbole
      const kl = await fetchJSON(u.toString());
      CACHE.first60_5m.set(sym, kl||[]);
      return kl||[];
    }

    // Pr√©pare la liste des paires dont la premi√®re 5m est dans le mois/ann√©e choisi
    async function warmMonth(Y,M){
      const k = keyMonth(Y,M);
      if (CACHE.monthRows.has(k)) return CACHE.monthRows.get(k);

      const symbols = await getSymbolsOnce();
      statusEl.textContent = `Pr√©paration (5m) du mois ${String(M+1).padStart(2,'0')}/${Y}‚Ä¶`;
      progressEl.textContent = '‚Äî';

      const rows = await mapLimit(symbols, 8, async (sym)=>{
        try{
          const m5 = await getFirst60_5m(sym);
          if(!m5.length) return null;
          const openTime1 = m5[0][0]; // premi√®re 5m du symbole (‚âÉ listing)
          const {y,m} = monthYearInBrussels(openTime1);
          if (y!==Y || m!==M) return null;
          return { sym, openTime1, m5_60: m5 };
        }catch{ return null; }
      });

      const kept = rows.filter(Boolean);
      CACHE.monthRows.set(k, kept);
      return kept;
    }

    // Construit les lignes pour la bougie 5m n¬∞ N
    async function computeRows(Y,M,N){
      const kc = keyComputed(Y,M,N);
      if (CACHE.computed.has(kc)) return CACHE.computed.get(kc);

      const base = CACHE.monthRows.get(keyMonth(Y,M)) || [];
      if(!base.length){ CACHE.computed.set(kc, []); return []; }

      const rows = base.map(r=>{
        const kl = r.m5_60; // 60 premi√®res bougies 5m au listing
        let openTimeN=null, openTimeNPlus=null, pctN=null;
        if (kl.length>=N){
          const kN = kl[N-1];
          openTimeN = kN[0];
          const o=parseFloat(kN[1]), c=parseFloat(kN[4]);
          pctN = o>0 ? ((c-o)/o*100) : 0;
          openTimeNPlus = plusThan24h(openTimeN);
        }
        return { sym:r.sym, openTime1:r.openTime1, openTimeN, openTimeNPlus, pctN };
      });

      const out = rows.sort((a,b)=>{
        if (a.openTimeN && b.openTimeN) return a.openTimeN - b.openTimeN;
        if (a.openTimeN) return -1;
        if (b.openTimeN) return 1;
        return a.sym.localeCompare(b.sym);
      });

      CACHE.computed.set(kc, out);
      return out;
    }

    // ====== Rendering
    function renderTable(rows){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML='';
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Aucun PERP USDT-M list√© (premi√®re 5m) pour les crit√®res choisis.</td></tr>`;
        return;
      }
      const frag = document.createDocumentFragment();
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.sym}</td>
          <td>${r.openTimeN===null ? '<span class="muted">‚Äî</span>' : toBrusselsDateTime(r.openTimeN)}</td>
          <td>${r.openTimeNPlus===null ? '<span class="muted">‚Äî</span>' : toBrusselsDateTime(r.openTimeNPlus)}</td>
          <td>${r.pctN===null ? '<span class="muted">‚Äî</span>' : `<span class="${r.pctN>=0?'up':'down'}">${fmtPct(r.pctN)}</span>`}</td>
        `;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    function updateBannerOnly(){
      const n = parseInt(candleSel.value,10);
      if(refListingMs==null){ candleDateBanner.textContent='‚Äî'; return; }
      const ms = refListingMs + (n-1)*min5Ms;
      candleDateBanner.textContent = formatShortFrDateTime(ms);
    }
    function updateNCalendar(){
      const n = parseInt(candleSel.value,10);
      nCalN.textContent = n;
      if(refListingMs==null){ nCalDate.textContent='‚Äî'; return; }
      const ms = refListingMs + (n-1)*min5Ms;
      nCalDate.textContent = formatLongFrDateTime(ms);
    }
    function updateLabels(){
      const n = parseInt(candleSel.value,10);
      nLabel.textContent = n; thN1.textContent = n; thN2.textContent = n;
      hintN.textContent = n; hintN2.textContent = n; hintN3.textContent = n;
      document.title = `Listings ‚Äî Bougie 5m n¬∞${n} (Binance Futures USDT-M PERP)`;
      updateNCalendar(); updateBannerOnly();
    }
    const markDirty = () => { statusEl.textContent = 'Param√®tres modifi√©s ‚Äî cliquez sur Run (premier chargement seulement)'; };

    // ====== Dupe card : Jan/Jun/Sep ‚Äî s'affiche UNIQUEMENT si chaque mois a exactement 2 dates
    async function updateDupeCard(){
      const Y = parseInt(yearSel.value,10);
      const N = parseInt(candleSel.value,10);
      dupeN.textContent = N;

      await Promise.all(ALLOWED_MONTHS.map(m => warmMonth(Y,m)));
      const rowsByMonth = await Promise.all(ALLOWED_MONTHS.map(m => computeRows(Y,m,N)));

      const monthNamesShort = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

      const report = ALLOWED_MONTHS.map((M, idx)=>{
        const rows = rowsByMonth[idx];
        const mapDates = new Map(); // date -> {pos:[],neg:[]}

        rows.forEach(r=>{
          if (r.openTimeN==null || r.pctN==null) return;
          if (r.pctN === 0) return;
          const key = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date(r.openTimeN));
          if (!mapDates.has(key)) mapDates.set(key, {pos:[],neg:[]});
          const bag = mapDates.get(key);
          (r.pctN>0 ? bag.pos : bag.neg).push({ sym:r.sym, pct:r.pctN, ms:r.openTimeN });
        });

        const dupes = [];
        for (const [,bag] of mapDates.entries()){
          if (bag.pos.length>=2) dupes.push({ human: new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'2-digit',month:'2-digit',day:'2-digit'}).format(new Date(bag.pos[0].ms)), sign:'positive', count:bag.pos.length, list:bag.pos.slice(0,6) });
          if (bag.neg.length>=2) dupes.push({ human: new Intl.DateTimeFormat('fr-BE',{timeZone:tz,year:'2-digit',month:'2-digit',day:'2-digit'}).format(new Date(bag.neg[0].ms)), sign:'negative', count:bag.neg.length, list:bag.neg.slice(0,6) });
        }
        return { monthLabel: monthNamesShort[M], dupes };
      });

      const showCard = report.every(block => block.dupes.length === 2);

      dupeContent.innerHTML = '';
      if (!showCard){
        dupeCard.style.display = 'none';
        return;
      }

      report.forEach(block=>{
        const div = document.createElement('div');
        div.className = 'dupe-month';
        div.innerHTML = `<h4>${block.monthLabel}</h4>`;
        const wrap = document.createElement('div');
        block.dupes.slice(0,2).forEach(d=>{
          const pill = document.createElement('span');
          pill.className = `dupe-pill ${d.sign==='positive'?'positive':'negative'}`;
          const signTxt = d.sign==='positive' ? 'Haussi√®re' : 'Baissi√®re';
          const syms = d.list.map(x=>x.sym).join(', ');
          pill.innerHTML = `<b>${d.human}</b> ‚Ä¢ ${signTxt} ‚Ä¢ x${d.count}<span class="muted" style="margin-left:6px">${syms}${d.count>6?', ‚Ä¶':''}</span>`;
          wrap.appendChild(pill);
        });
        div.appendChild(wrap);
        dupeContent.appendChild(div);
      });

      dupeCard.style.display = 'block';
    }

    // ====== Build & render courant (5m)
    async function buildAndRenderCurrent(Y,M,N){
      const rows = await computeRows(Y,M,N);
      if (rows.length){
        // ref = plus petite premi√®re bougie (openTime1) du lot
        refListingMs = rows.reduce((min, r) => Math.min(min, r.openTime1), Number.POSITIVE_INFINITY);
      }else{
        refListingMs = null;
      }
      lastRows = rows;
      renderTable(rows);
      updateLabels(); updateNCalendar();
    }

    // ====== Run
    async function run(){
      errEl.textContent=''; tbody.innerHTML=''; progressEl.textContent='‚Äî';
      lastRows=[]; refListingMs=null;

      const Y = parseInt(yearSel.value,10);
      const M = parseInt(monthSel.value,10);
      const N = parseInt(candleSel.value,10);

      try{
        statusEl.textContent = 'Chargement initial (5m)‚Ä¶';
        await warmMonth(Y,M);
        // pr√©-chauffe silencieuse des deux autres mois (Jan/Jun/Sep)
        Promise.allSettled(ALLOWED_MONTHS.filter(mm=>mm!==M).map(mm=>warmMonth(Y,mm)));

        statusEl.textContent = `Calcul local 5m pour N=${N}‚Ä¶`;
        await buildAndRenderCurrent(Y,M,N);
        await updateDupeCard();

        statusEl.textContent = `Termin√© (cache) ‚Äî ${lastRows.length} symbole(s) ‚Ä¢ Bougie 5m n¬∞${N} ‚Ä¢ ${String(M+1).padStart(2,'0')}/${Y}`;
      }catch(e){
        console.error(e); errEl.textContent='Erreur: '+e.message; statusEl.textContent='';
      }
    }

    // ====== Effacer
    function clearAll(){
      CACHE.symbols = null;
      CACHE.first60_5m.clear();
      CACHE.monthRows.clear();
      CACHE.computed.clear();

      lastRows = [];
      refListingMs = null;
      tbody.innerHTML = '';
      dupeContent.innerHTML = '';
      dupeCard.style.display = 'none';
      errEl.textContent = '';
      progressEl.textContent = '‚Äî';
      nCalDate.textContent = '‚Äî';
      candleDateBanner.textContent = '‚Äî';

      updateLabels();
      statusEl.textContent = 'Tout effac√© ‚Äî s√©lectionne tes param√®tres puis clique Run.';
    }

    // ====== Fast re-render si cache d√©j√† chaud
    async function tryFastRender(){
      const Y = parseInt(yearSel.value,10);
      const M = parseInt(monthSel.value,10);
      const N = parseInt(candleSel.value,10);

      if (CACHE.monthRows.has(keyMonth(Y,M))){
        statusEl.textContent = 'Recalcul rapide depuis le cache‚Ä¶';
        await buildAndRenderCurrent(Y,M,N);
        await updateDupeCard();
        statusEl.textContent = `OK (cache) ‚Ä¢ ${lastRows.length} symbole(s)`;
      }else{
        markDirty();
      }
    }

    // ====== UI init
    (function initSelectors(){
      const years=[2024];
      years.forEach(y=>{
        const o=document.createElement('option');
        o.value=String(y); o.textContent=String(y+1); o.dataset.realYear=y;
        yearSel.appendChild(o);
      });
      yearSel.value='2024';

      const limitedMonths=[
        {label:'01 Jan', value:0},
        {label:'06 Jun', value:5},
        {label:'09 Sep', value:8},
      ];
      limitedMonths.forEach(({label,value})=>{
        const o=document.createElement('option'); o.value=value; o.textContent=label; monthSel.appendChild(o);
      });
      monthSel.value=0;

      for(let n=1;n<=60;n++){ const o=document.createElement('option'); o.value=n; o.textContent=String(n); candleSel.appendChild(o); }
      candleSel.value='20';

      updateLabels(); updateNCalendar(); updateBannerOnly();
    })();

    // ====== Listeners
    candleSel.addEventListener('change', async ()=>{ updateLabels(); await tryFastRender(); });
    yearSel.addEventListener('change', tryFastRender);
    monthSel.addEventListener('change', tryFastRender);

    runBtn.addEventListener('click', run);
    clearBtn.addEventListener('click', clearAll);

    // ====== Header dynamique
    const h1 = document.getElementById('h1');
    const monthNames = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
    const updateHeader = () => { h1.innerHTML = `Listings en ${monthNames[+monthSel.value]} ‚Ä¢ Bougie 5m n¬∞<span id="nLabel">${candleSel.value}</span>`; };
    monthSel.addEventListener('change', updateHeader);
    candleSel.addEventListener('change', updateHeader);
    updateHeader();
  </script>
</body>
</html>
