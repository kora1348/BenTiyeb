<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Variations — Binance Futures (1h) — RONINUSDT & 1000LUNCUSDT</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5}
    h2{margin:0 0 8px}
    .card{margin:12px 0 14px;padding:14px;border-radius:8px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.10)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .muted{color:#666;font-size:13px}
    table{background:#fff;border-collapse:collapse}
    th{background:#fafafa}
    th,td{border:1px solid #ddd;padding:8px}
    .wrap{max-width:1200px}
  </style>
</head>
<body class="wrap">

  <!-- Contrôles (précédant / suivant) -->
  <div class="card">
    <div class="row">
      <div>
        <button class="prevBtn">Précédant</button>
        <button class="nextBtn">Suivant</button>

        &nbsp;|&nbsp;

        <label>
          Date :
          <input
            type="text"
            class="dateInput"
            placeholder="JJ/MM/AAAA"
            inputmode="numeric"
            style="width:120px"
          />
        </label>

        <button class="goDateBtn">OK</button>
      </div>
      <div class="muted" id="rangeInfo">—</div>
    </div>
  </div>

 

  <!-- TABLE 2 -->
  <div class="card">
    <h2 id="title2">Tableau 2 — 1000LUNCUSDT — 20/12/2025</h2>
    <table width="100%" cellpadding="8">
      <thead>
        <tr>
          <th>Heure (UTC)</th>
          <th>Taux variation 1h</th>
        </tr>
      </thead>
      <tbody id="tbody2"></tbody>
    </table>
  </div>

<script>
/* ========= CONFIG ========= */
const BASE_FUTURES = "https://fapi.binance.com";
const SYMBOL_TABLE1 = "RONINUSDT";
const SYMBOL_TABLE2 = "1000LUNCUSDT";

// point de départ : 20/12/2025 (UTC)
let baseDateUtc = new Date(Date.UTC(2025, 11, 20, 0, 0, 0, 0));

/* ========= UTILS DATES ========= */
const pad2 = n => String(n).padStart(2, "0");
const toFr = d => `${pad2(d.getUTCDate())}/${pad2(d.getUTCMonth()+1)}/${d.getUTCFullYear()}`;
const toYmd = d => `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())}`;

function addDaysUtc(d, days){
  const x = new Date(d);
  x.setUTCDate(x.getUTCDate() + days);
  return new Date(Date.UTC(x.getUTCFullYear(), x.getUTCMonth(), x.getUTCDate(), 0, 0, 0, 0));
}

// parse "JJ/MM/AAAA" -> Date UTC (00:00)
function frToUtcDate(fr){
  const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(String(fr || "").trim());
  if(!m) return null;

  const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
  if(mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;

  const dt = new Date(Date.UTC(yy, mm-1, dd, 0, 0, 0, 0));
  if(isNaN(dt.getTime())) return null;

  // check existence réelle (31/02, etc.)
  if(dt.getUTCFullYear() !== yy || (dt.getUTCMonth()+1) !== mm || dt.getUTCDate() !== dd) return null;

  return dt;
}

function dayUtcRangeMs(dUtc){
  const y = dUtc.getUTCFullYear();
  const m = dUtc.getUTCMonth();
  const d = dUtc.getUTCDate();
  return {
    start: Date.UTC(y, m, d, 0, 0, 0, 0),
    end:   Date.UTC(y, m, d, 23, 59, 59, 999)
  };
}

/* ========= FORMAT ========= */
const fmtPct = v => `${v>0?"+":""}${v.toFixed(2)}%`;
function applyColor(el, v){
  el.style.color = v > 0 ? "green" : v < 0 ? "red" : "";
}

/* ========= API (1h klines) ========= */
async function fetchKlines1h(symbol, startMs, endMs){
  // on prend un peu de marge (Binance peut renvoyer un peu autour)
  const url = `${BASE_FUTURES}/fapi/v1/klines?symbol=${encodeURIComponent(symbol)}&interval=1h&startTime=${startMs}&endTime=${endMs}&limit=24`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${symbol} -> HTTP ${r.status}`);
  const arr = await r.json();
  if(!Array.isArray(arr) || arr.length === 0) throw new Error(`${symbol} -> aucune bougie 1h`);
  return arr;
}

function hourLabelUTC(ms){
  const d = new Date(ms);
  return `${pad2(d.getUTCHours())}:00`;
}

function pctFromKline(k){
  const o = +k[1], c = +k[4];
  if(!isFinite(o) || !isFinite(c) || o <= 0) return null;
  return ((c - o) / o) * 100;
}

/* ========= RENDER TABLE ========= */
async function renderHourlyTable(symbol, tbodyId){
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = "";

  const {start, end} = dayUtcRangeMs(baseDateUtc);

  // Récup bougies 1h du jour
  let klines = await fetchKlines1h(symbol, start, end);

  // Filtrer strictement sur [start, start+24h) et trier
  klines = klines
    .filter(k => k && k[0] >= start && k[0] < start + 24*60*60*1000)
    .sort((a,b)=>a[0]-b[0]);

  // Si Binance en renvoie moins, on affiche quand même ce qu'on a
  let total = 0;
  let count = 0;

  for(const k of klines){
    const openTime = k[0];
    const v = pctFromKline(k);

    const tr = document.createElement("tr");
    const tdH = document.createElement("td");
    const tdV = document.createElement("td");

    tdH.textContent = hourLabelUTC(openTime);

    if(v === null){
      tdV.textContent = "Erreur";
      tdV.style.color = "";
    }else{
      tdV.textContent = fmtPct(v);
      applyColor(tdV, v);
      total += v;
      count++;
    }

    tr.appendChild(tdH);
    tr.appendChild(tdV);
    tbody.appendChild(tr);
  }

  // Ligne TOTAL (somme des %)
  const trTotal = document.createElement("tr");
  const tdT1 = document.createElement("td");
  const tdT2 = document.createElement("td");
  tdT1.innerHTML = "<strong>TOTAL</strong>";
  tdT2.innerHTML = `<strong>${count ? fmtPct(total) : "Erreur"}</strong>`;
  trTotal.appendChild(tdT1);
  trTotal.appendChild(tdT2);
  tbody.appendChild(trTotal);
  applyColor(tdT2, total);
}

/* ========= REFRESH ========= */
async function refresh(){
  const fr = toFr(baseDateUtc);
  document.getElementById("title1").textContent = `Tableau 1 — ${SYMBOL_TABLE1} — ${fr}`;
  document.getElementById("title2").textContent = `Tableau 2 — ${SYMBOL_TABLE2} — ${fr}`;

  const {start, end} = dayUtcRangeMs(baseDateUtc);
  document.getElementById("rangeInfo").textContent =
    `Fenêtre 1D (UTC) : ${toYmd(baseDateUtc)} 00:00 → 23:59`;

  // loaders rapides
  document.getElementById("tbody1").innerHTML = `<tr><td colspan="2">Chargement...</td></tr>`;
  document.getElementById("tbody2").innerHTML = `<tr><td colspan="2">Chargement...</td></tr>`;

  try{
    await Promise.all([
      renderHourlyTable(SYMBOL_TABLE1, "tbody1"),
      renderHourlyTable(SYMBOL_TABLE2, "tbody2")
    ]);
  }catch(e){
    console.error(e);
    // en cas d'erreur globale, on affiche "Erreur" dans les 2 tables
    document.getElementById("tbody1").innerHTML = `<tr><td colspan="2">Erreur</td></tr>`;
    document.getElementById("tbody2").innerHTML = `<tr><td colspan="2">Erreur</td></tr>`;
  }
}

/* ========= NAVIGATION ========= */
document.querySelectorAll(".prevBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    baseDateUtc = addDaysUtc(baseDateUtc, -1);
    document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
    await refresh();
  });
});

document.querySelectorAll(".nextBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    baseDateUtc = addDaysUtc(baseDateUtc, 1);
    document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
    await refresh();
  });
});

document.querySelectorAll(".goDateBtn").forEach(btn => {
  btn.addEventListener("click", async ()=>{
    const wrap = btn.parentElement;
    const inp = wrap.querySelector(".dateInput");
    const dt = frToUtcDate(inp.value);

    if(!dt){
      alert("Date invalide. Utilise le format JJ/MM/AAAA (ex: 20/12/2025).");
      return;
    }

    baseDateUtc = new Date(dt);
    document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
    await refresh();
  });
});

document.querySelectorAll(".dateInput").forEach(inp => {
  inp.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      const btn = inp.parentElement.parentElement.querySelector(".goDateBtn");
      if(btn) btn.click();
    }
  });
});

/* ========= INIT ========= */
document.querySelectorAll(".dateInput").forEach(x => x.value = toFr(baseDateUtc));
refresh();
</script>

</body>
</html>
